<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link rel="manifest" href="manifest.json">
<title>Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°</title>
<style>
:root {
  --primary: #6C5CE7; --primary-light: #A29BFE;
  --accent-green: #00B894; --accent-red: #E17055; --accent-orange: #FDCB6E;
  --bg: #F8F9FA; --card: #FFFFFF; --text: #2D3436; --text-secondary: #636E72;
  --border: #E9ECEF; --radius: 16px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; -webkit-font-smoothing: antialiased; }

/* HEADER */
.app-header {
  background: linear-gradient(135deg, #6C5CE7, #A29BFE);
  color: white; padding: 14px 16px; display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; z-index: 100;
}
.app-title { font-size: 17px; font-weight: 800; }
.app-subtitle { font-size: 11px; opacity: 0.8; }
.header-right { display: flex; align-items: center; gap: 10px; }
.balance-badge {
  background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px;
  font-size: 12px; font-weight: 700; white-space: nowrap;
}
.btn-refresh {
  background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px;
  border-radius: 50%; font-size: 16px; cursor: pointer;
}

/* BOTTOM NAV */
.bottom-nav {
  position: sticky; top: 0; left: 0; right: 0; background: white;
  display: flex; border-bottom: 1px solid var(--border); z-index: 99;
  padding: 0;
}
.nav-btn {
  flex: 1; padding: 8px 4px 6px; border: none; background: none; cursor: pointer;
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  color: var(--text-secondary); font-size: 10px; font-weight: 600;
  transition: color 0.2s;
}
.nav-btn.active { color: var(--primary); }
.nav-icon { font-size: 22px; }

/* TABS */
.main-tab { display: none; padding: 12px; min-height: calc(100vh - 100px); }
.main-tab.active { display: block; }

/* CARDS */
.card {
  background: var(--card); border-radius: var(--radius); padding: 16px; margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.card-header { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
.card-gradient {
  background: linear-gradient(135deg, #6C5CE7 0%, #A29BFE 100%);
  color: white; border-radius: var(--radius); padding: 18px; margin-bottom: 12px;
}

/* PRIORITY CARD (credits) */
.priority-card { border-left: 4px solid var(--primary); }
.next-payment {
  background: #FFF3E0; border-radius: 12px; padding: 14px; margin-bottom: 14px;
  border-left: 4px solid #FF9800;
}
.next-payment.urgent { background: #FFEBEE; border-left-color: #F44336; }
.next-payment.today { background: #FFF3E0; border-left-color: #FF5722; }
.next-label { font-size: 11px; font-weight: 700; color: #E65100; text-transform: uppercase; letter-spacing: 0.5px; }
.next-info { font-size: 17px; font-weight: 800; margin: 4px 0 2px; color: var(--text); }
.next-date { font-size: 12px; color: var(--text-secondary); }

/* PAYMENT ROWS */
.pay-row {
  display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.pay-row:last-child { border-bottom: none; }
.pay-row.paid { opacity: 0.45; }
.pay-day { width: 36px; font-weight: 600; color: var(--text-secondary); font-size: 12px; }
.pay-name { flex: 1; }
.pay-amount { font-weight: 700; margin-right: 8px; }
.pay-status { font-size: 14px; }

/* FORECAST BOX */
.forecast-box { padding: 12px; border-radius: 12px; margin-top: 12px; text-align: center; font-size: 13px; font-weight: 600; }
.forecast-ok { background: #E8F5E9; color: #2E7D32; }
.forecast-bad { background: #FFEBEE; color: #C62828; }

/* BIZ SUMMARY */
.biz-mini { display: flex; gap: 10px; margin-bottom: 10px; }
.biz-mini-box { flex: 1; background: var(--bg); border-radius: 12px; padding: 12px; text-align: center; }
.biz-mini-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; }
.biz-mini-value { font-size: 18px; font-weight: 800; margin-top: 4px; }
.biz-mini-sub { font-size: 10px; color: var(--text-secondary); margin-top: 2px; }
.progress-wrap { background: rgba(255,255,255,0.2); border-radius: 10px; height: 26px; overflow: hidden; margin-top: 8px; }
.progress-fill {
  height: 100%; border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; color: white; transition: width 0.6s;
  background: linear-gradient(90deg, #00B894, #55EFC4);
}
.progress-bg { background: #E9ECEF; border-radius: 10px; height: 22px; overflow: hidden; }
.progress-fg { height: 100%; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: white; background: var(--primary); transition: width 0.5s; }

/* FAMILY SUMMARY */
.fam-bar { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }

/* STATS GRID */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
.stat-box { background: rgba(255,255,255,0.15); padding: 14px; border-radius: 12px; text-align: center; }
.stat-label { font-size: 10px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.3px; }
.stat-value { font-size: 20px; font-weight: 800; margin-top: 4px; }
.stat-sub { font-size: 10px; opacity: 0.7; margin-top: 2px; }

/* FILIAL CARDS */
.filial-card { background: var(--card); border-radius: var(--radius); padding: 16px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
.filial-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.filial-name { font-size: 14px; font-weight: 700; }
.filial-rank { background: var(--primary); color: white; font-size: 10px; padding: 3px 8px; border-radius: 10px; font-weight: 700; }
.filial-row { display: flex; justify-content: space-between; font-size: 13px; padding: 3px 0; }
.filial-perf { padding: 6px 10px; border-radius: 8px; text-align: center; font-size: 12px; font-weight: 600; margin-top: 8px; }
.perf-high { background: #D4EDDA; color: #155724; }
.perf-med { background: #FFF3CD; color: #856404; }
.perf-low { background: #F8D7DA; color: #721C24; }

/* CREDIT CARDS */
.credit-card { background: var(--card); border-radius: var(--radius); padding: 16px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
.credit-card.frozen { opacity: 0.55; }
.credit-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.credit-name { font-weight: 700; font-size: 14px; }
.credit-rate { font-size: 13px; font-weight: 700; color: var(--accent-red); }
.credit-amount { font-size: 20px; font-weight: 800; margin: 6px 0; }
.credit-row { display: flex; justify-content: space-between; font-size: 12px; padding: 3px 0; color: var(--text-secondary); }
.credit-progress { background: #E9ECEF; height: 6px; border-radius: 3px; margin-top: 10px; }
.credit-progress-fill { height: 100%; background: var(--accent-green); border-radius: 3px; transition: width 0.4s; }

/* MONTH SELECT */
.month-select { padding: 10px; display: flex; align-items: center; gap: 10px; }
.month-select select { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); font-size: 14px; background: white; }

/* LOADING / ERROR */
.loading-box { text-align: center; padding: 40px; color: var(--text-secondary); }
.spinner { width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
@keyframes spin { to { transform: rotate(360deg); } }
.error-box { background: #FFEBEE; color: #C62828; padding: 16px; border-radius: 12px; text-align: center; font-size: 13px; }

/* SECTION TOGGLE */
.section-toggle {
  display: flex; align-items: center; justify-content: space-between; cursor: pointer;
  padding: 10px 0; font-size: 14px; font-weight: 700;
}
.section-toggle .arrow { transition: transform 0.2s; }
.section-toggle.open .arrow { transform: rotate(90deg); }

/* FAMILY IFRAME */
#tab-family iframe { width: 100%; height: calc(100vh - 100px); border: none; border-radius: var(--radius); background: #f3f4f6; }

/* TOAST */
.toast { position: fixed; top: 70px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; z-index: 200; transition: transform 0.3s; pointer-events: none; }
.toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- HEADER -->
<header class="app-header">
  <div>
    <div class="app-title">Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°</div>
    <div class="app-subtitle" id="header-subtitle">v2.0</div>
  </div>
  <div class="header-right">
    <div class="balance-badge" id="balance-badge">ĞĞ° ÑÑ‡ĞµÑ‚Ğ°Ñ…: â€”</div>
    <button class="btn-refresh" onclick="refreshAll()" title="ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ">&#x21bb;</button>
  </div>
</header>

<nav class="bottom-nav">
  <button class="nav-btn active" onclick="switchTab('home', this)" id="nav-home">
    <span class="nav-icon">&#x1F3E0;</span>Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ
  </button>
  <button class="nav-btn" onclick="switchTab('business', this)" id="nav-business">
    <span class="nav-icon">&#x1F3E2;</span>Ğ‘Ğ¸Ğ·Ğ½ĞµÑ
  </button>
  <button class="nav-btn" onclick="switchTab('family', this)" id="nav-family">
    <span class="nav-icon">&#x1F45B;</span>Ğ¡ĞµĞ¼ÑŒÑ
  </button>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TAB: Ğ“Ğ›ĞĞ’ĞĞĞ¯ (overview dashboard) -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main-tab active" id="tab-home">

  <!-- 1. ĞšĞ Ğ•Ğ”Ğ˜Ğ¢ĞĞ«Ğ• ĞŸĞ›ĞĞ¢Ğ•Ğ–Ğ˜ -->
  <div class="card priority-card" id="card-payments">
    <div class="card-header">&#x1F4B3; ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸ &#x2014; <span id="pay-month-name">Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ</span></div>
    <div id="payments-content"><div class="loading-box"><div class="spinner"></div></div></div>
  </div>

  <!-- 2. ĞĞ¢Ğ•Ğ›Ğ¬Ğ• -->
  <div class="card" id="card-biz-summary">
    <div class="card-header">&#x1F3E2; ĞÑ‚ĞµĞ»ÑŒĞµ &#x2014; <span id="biz-summary-month">ÑĞ½Ğ²Ğ°Ñ€ÑŒ</span></div>
    <div id="biz-summary-content"><div class="loading-box"><div class="spinner"></div></div></div>
  </div>

  <!-- 3. Ğ¡Ğ•ĞœĞ¬Ğ¯ -->
  <div class="card" id="card-family-summary">
    <div class="card-header">&#x1F3E0; Ğ¡ĞµĞ¼ÑŒÑ &#x2014; <span id="fam-summary-month">ÑĞ½Ğ²Ğ°Ñ€ÑŒ</span></div>
    <div id="family-summary-content">
      <div style="font-size:13px; color:var(--text-secondary);">ĞŸĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ Ğ¡ĞµĞ¼ÑŒÑ Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</div>
    </div>
  </div>

  <!-- 4. Ğ ĞĞ¡Ğ¥ĞĞ”Ğ« ĞĞ¢Ğ•Ğ›Ğ¬Ğ• (Ğ¸Ğ· ÑĞµĞ¼ĞµĞ¹Ğ½Ñ‹Ñ… Ğ²Ñ‹Ğ¿Ğ¸ÑĞ¾Ğº) -->
  <div class="card" id="biz-expenses-card" style="display:none; border-left:4px solid #FDCB6E;">
  </div>

  <!-- ĞšĞ Ğ•Ğ”Ğ˜Ğ¢Ğ« (ÑĞ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğ¹) -->
  <div class="card">
    <div class="section-toggle" onclick="toggleSection('credits-detail', this)">
      <span>&#x1F4B3; Ğ’ÑĞµ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ñ‹ (Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸)</span>
      <span class="arrow">&#x25B6;</span>
    </div>
    <div id="credits-detail" style="display:none;">
      <div id="credits-summary-box"></div>
      <div id="credits-list"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TAB: Ğ‘Ğ˜Ğ—ĞĞ•Ğ¡ (detailed) -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main-tab" id="tab-business">
  <div class="month-select">
    <span style="font-weight:600;">ĞœĞµÑÑÑ†:</span>
    <select id="bizMonthSelect" onchange="loadBranches()">
      <option value="1">Ğ¯Ğ½Ğ²Ğ°Ñ€ÑŒ</option><option value="2">Ğ¤ĞµĞ²Ñ€Ğ°Ğ»ÑŒ</option>
      <option value="3">ĞœĞ°Ñ€Ñ‚</option><option value="4">ĞĞ¿Ñ€ĞµĞ»ÑŒ</option>
      <option value="5">ĞœĞ°Ğ¹</option><option value="6">Ğ˜ÑĞ½ÑŒ</option>
      <option value="7">Ğ˜ÑĞ»ÑŒ</option><option value="8">ĞĞ²Ğ³ÑƒÑÑ‚</option>
      <option value="9">Ğ¡ĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ</option><option value="10">ĞĞºÑ‚ÑĞ±Ñ€ÑŒ</option>
      <option value="11">ĞĞ¾ÑĞ±Ñ€ÑŒ</option><option value="12">Ğ”ĞµĞºĞ°Ğ±Ñ€ÑŒ</option>
    </select>
  </div>

  <div id="biz-loading"><div class="loading-box"><div class="spinner"></div><p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ¸Ğ»Ğ¸Ğ°Ğ»Ğ¾Ğ²...</p></div></div>
  <div id="biz-error" style="display:none;"></div>

  <div id="biz-overview-content" style="display:none;">
    <div class="card-gradient">
      <div style="text-align:center; font-size:16px; font-weight:700; margin-bottom:14px;">Ğ¡ĞµÑ‚ÑŒ Ğ¸Ğ· 9 Ğ°Ñ‚ĞµĞ»ÑŒĞµ</div>
      <div class="stats-grid">
        <div class="stat-box"><div class="stat-label">ĞÑ‚ĞµĞ»ÑŒĞµ</div><div class="stat-value" id="ov-atelie">&#x2014;</div><div class="stat-sub" id="ov-atelie-plan"></div></div>
        <div class="stat-box"><div class="stat-label">Ğ¥Ğ¸Ğ¼Ñ‡Ğ¸ÑÑ‚ĞºĞ°</div><div class="stat-value" id="ov-himch">&#x2014;</div><div class="stat-sub" id="ov-himch-plan"></div></div>
        <div class="stat-box"><div class="stat-label">Ğ’ÑĞµĞ³Ğ¾</div><div class="stat-value" id="ov-total">&#x2014;</div><div class="stat-sub" id="ov-total-plan"></div></div>
        <div class="stat-box"><div class="stat-label">ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹</div><div class="stat-value" id="ov-clients">&#x2014;</div><div class="stat-sub" id="ov-avg-check"></div></div>
        <div class="stat-box"><div class="stat-label">ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ</div><div class="stat-value" id="ov-profit">&#x2014;</div><div class="stat-sub">Ñ‡Ğ¸ÑÑ‚Ğ°Ñ</div></div>
      </div>
      <div class="progress-wrap"><div class="progress-fill" id="ov-progress" style="width:0%">0%</div></div>
    </div>
  </div>

  <div id="filialsGrid"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TAB: Ğ¡Ğ•ĞœĞ¬Ğ¯ (iframe) -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main-tab" id="tab-family">
  <iframe id="familyFrame" src="family.html?embedded=1" style="width:100%; height:calc(100vh - 100px); border:none; border-radius:var(--radius); background:#f3f4f6;"></iframe>
</div>

<!-- BOTTOM NAV -->
<!-- NAV MOVED TO TOP -->

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API & CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const API_URL = 'https://script.google.com/macros/s/AKfycbxfN2eYhdWamLmTuR6I4unWFpNA4iOD5QxzaKWASZmW6G8El_FWk3vOi1wE7x4AUNasVA/exec';
const DASHBOARD_API_URL = 'https://script.google.com/macros/s/AKfycbwyjWBnlCZFMbjkcggsMQWuhaxUzNkxG2_QStfSqf3sSoeNlkF424ykPbrxgwtg2sA/exec';
const MONTH_NAMES = ['', 'ÑĞ½Ğ²Ğ°Ñ€ÑŒ', 'Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ', 'Ğ¼Ğ°Ñ€Ñ‚', 'Ğ°Ğ¿Ñ€ĞµĞ»ÑŒ', 'Ğ¼Ğ°Ğ¹', 'Ğ¸ÑĞ½ÑŒ', 'Ğ¸ÑĞ»ÑŒ', 'Ğ°Ğ²Ğ³ÑƒÑÑ‚', 'ÑĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ', 'Ğ¾ĞºÑ‚ÑĞ±Ñ€ÑŒ', 'Ğ½Ğ¾ÑĞ±Ñ€ÑŒ', 'Ğ´ĞµĞºĞ°Ğ±Ñ€ÑŒ'];
const MONTH_NAMES_CAP = ['', 'Ğ¯Ğ½Ğ²Ğ°Ñ€ÑŒ', 'Ğ¤ĞµĞ²Ñ€Ğ°Ğ»ÑŒ', 'ĞœĞ°Ñ€Ñ‚', 'ĞĞ¿Ñ€ĞµĞ»ÑŒ', 'ĞœĞ°Ğ¹', 'Ğ˜ÑĞ½ÑŒ', 'Ğ˜ÑĞ»ÑŒ', 'ĞĞ²Ğ³ÑƒÑÑ‚', 'Ğ¡ĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ', 'ĞĞºÑ‚ÑĞ±Ñ€ÑŒ', 'ĞĞ¾ÑĞ±Ñ€ÑŒ', 'Ğ”ĞµĞºĞ°Ğ±Ñ€ÑŒ'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let appState = {
  credits: [], balances: [], settings: {}, forecast: [],
  branchData: null, familySummary: null, dataLoaded: false
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function fetchWithTimeout(url, timeout = 10000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  const response = await fetch(url, { signal: controller.signal });
  clearTimeout(id);
  return response;
}

async function loadAllData() {
  showToast('Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...');
  try {
    const res = await fetchWithTimeout(API_URL + '?action=getAll', 15000);
    const data = await res.json();
    if (data.success) {
      if (data.credits) appState.credits = data.credits;
      if (data.settings) appState.settings = data.settings;
      if (data.balances) appState.balances = data.balances;
      if (data.forecast) appState.forecast = data.forecast;
      appState.dataLoaded = true;
      showToast('Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹');
    }
  } catch (err) {
    console.warn('API error, using defaults:', err.message);
    loadDefaults();
    showToast('Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºÑÑˆ');
  }

  // Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
  renderOverview();
  renderCreditsDetail();

  // Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ¸Ğ»Ğ¸Ğ°Ğ»Ğ¾Ğ²
  loadBranches();
}

function loadDefaults() {
  appState.credits = [
    { name: 'Ğ¢-Ğ‘Ğ°Ğ½Ğº 27.3%', rate: 0.273, balanceInit: 1784581, balanceCurrent: 1784581, payment: 98650, paymentDay: 5, closeDate: 'ĞĞ²Ğ³ 2026', priority: 1, status: 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹' },
    { name: 'Ğ¡Ğ±ĞµÑ€Ğ±Ğ°Ğ½Ğº 25.4%', rate: 0.254, balanceInit: 256000, balanceCurrent: 256000, payment: 2309, paymentDay: 10, closeDate: '', priority: 0, status: 'Ğ—ĞĞœĞĞ ĞĞ–Ğ•Ğ' },
    { name: 'Ğš4 Ğ¤Ğ¸Ğ·Ğ»Ğ¸Ñ†Ğ¾', rate: 0.25, balanceInit: 397000, balanceCurrent: 397000, payment: 25000, paymentDay: 15, closeDate: 'Ğ¡ĞµĞ½ 2026', priority: 3, status: 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹' },
    { name: 'Ğš3 Ğ¤Ğ¸Ğ·Ğ»Ğ¸Ñ†Ğ¾', rate: 0.25, balanceInit: 225000, balanceCurrent: 225000, payment: 20000, paymentDay: 0, closeDate: 'ĞĞºÑ‚ 2026', priority: 4, status: 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹' },
    { name: 'Ğš2 Ğ¤Ğ¸Ğ·Ğ»Ğ¸Ñ†Ğ¾', rate: 0.25, balanceInit: 474000, balanceCurrent: 474000, payment: 20000, paymentDay: 0, closeDate: 'ĞĞºÑ‚ 2026', priority: 5, status: 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹' },
    { name: 'Ğš1 Ğ¤Ğ¸Ğ·Ğ»Ğ¸Ñ†Ğ¾', rate: 0.20, balanceInit: 681417, balanceCurrent: 681417, payment: 15000, paymentDay: 0, closeDate: 'ĞĞ¾Ñ 2026', priority: 6, status: 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹' },
    { name: 'Ğ¡Ğ±ĞµÑ€Ğ±Ğ°Ğ½Ğº 19.5%', rate: 0.195, balanceInit: 483375, balanceCurrent: 483375, payment: 32700, paymentDay: 0, closeDate: 'Ğ”ĞµĞº 2026', priority: 7, status: 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹' },
    { name: 'Ğ¡Ğ±ĞµÑ€Ğ±Ğ°Ğ½Ğº Ğ¿Ğ°Ğ¿Ğ°', rate: 0.1705, balanceInit: 831000, balanceCurrent: 831000, payment: 30300, paymentDay: 0, closeDate: 'Ğ”ĞµĞº 2026', priority: 8, status: 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹' },
    { name: 'ĞĞ±ÑĞ¾Ğ»ÑÑ‚ Ğ‘Ğ°Ğ½Ğº', rate: 0.10, balanceInit: 3346902, balanceCurrent: 3346902, payment: 30250, paymentDay: 0, closeDate: 'ĞĞµ Ğ² 2026', priority: 9, status: 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹' },
    { name: 'Ğ”Ñ€Ğ°Ğ¹Ğ² ĞšĞ»Ğ¸Ğº', rate: 0.049, balanceInit: 1535172, balanceCurrent: 1535172, payment: 33000, paymentDay: 0, closeDate: 'ĞĞµ Ğ² 2026', priority: 10, status: 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹' },
    { name: 'Ğ˜Ğ¿Ğ¾Ñ‚ĞµĞºĞ°', rate: 0.001, balanceInit: 8931119, balanceCurrent: 8931119, payment: 28200, paymentDay: 0, closeDate: 'ĞĞµ Ğ² 2026', priority: 11, status: 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹' },
    { name: 'Ğ Ğ°ÑÑÑ€Ğ¾Ñ‡ĞºĞ°', rate: 0.0, balanceInit: 246800, balanceCurrent: 246800, payment: 61600, paymentDay: 0, closeDate: 'ĞĞ¿Ñ€ 2026', priority: 12, status: 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹' }
  ];
  appState.settings = { 'Ğ¼Ğ°Ñ€Ğ¶Ğ°_Ğ°Ñ‚ĞµĞ»ÑŒĞµ': 0.5, 'Ğ¼Ğ°Ñ€Ğ¶Ğ°_Ñ…Ğ¸Ğ¼Ñ‡Ğ¸ÑÑ‚ĞºĞ°': 0.4, 'Ğ°Ñ€ĞµĞ½Ğ´Ğ°_Ğ²ÑĞµĞ³Ğ¾': 396000, 'Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ñ‹_ÑĞµĞ¼ÑŒÑ': 354000 };
  appState.forecast = [
    { month: 1, income: 510263, obligations: 402327 }, { month: 2, income: 488051, obligations: 402327 },
    { month: 3, income: 916641, obligations: 402327 }, { month: 4, income: 928138, obligations: 402327 },
    { month: 5, income: 941033, obligations: 341127 }, { month: 6, income: 917548, obligations: 340727 },
    { month: 7, income: 674080, obligations: 340727 }, { month: 8, income: 794772, obligations: 340727 },
    { month: 9, income: 798438, obligations: 242065 }, { month: 10, income: 878332, obligations: 222598 },
    { month: 11, income: 908278, obligations: 178820 }, { month: 12, income: 895996, obligations: 169385 }
  ];
  appState.dataLoaded = true;
}

async function loadBranches() {
  const month = document.getElementById('bizMonthSelect') ? document.getElementById('bizMonthSelect').value : (new Date().getMonth() + 1);

  const loadEl = document.getElementById('biz-loading');
  const overEl = document.getElementById('biz-overview-content');
  const errEl = document.getElementById('biz-error');
  if (loadEl) loadEl.style.display = 'block';
  if (overEl) overEl.style.display = 'none';
  if (errEl) errEl.style.display = 'none';

  try {
    let res;
    try { res = await fetchWithTimeout(API_URL + '?action=getBranches&month=' + month, 12000); }
    catch { res = await fetchWithTimeout(DASHBOARD_API_URL + '?month=' + month, 12000); }
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    appState.branchData = data;
    renderBizOverview(data);
    renderFilials(data);
    renderBizSummaryCard(data); // update overview card

    if (loadEl) loadEl.style.display = 'none';
    if (overEl) overEl.style.display = 'block';
  } catch (err) {
    if (loadEl) loadEl.style.display = 'none';
    if (errEl) { errEl.style.display = 'block'; errEl.innerHTML = '<div class="error-box">' + err.message + '</div>'; }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: OVERVIEW (TAB 1)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderOverview() {
  const now = new Date();
  const cm = now.getMonth() + 1;

  // Update month labels
  document.getElementById('pay-month-name').textContent = MONTH_NAMES[cm];
  document.getElementById('biz-summary-month').textContent = MONTH_NAMES[cm === 1 ? 1 : cm - 1]; // last complete month or current
  document.getElementById('fam-summary-month').textContent = MONTH_NAMES[cm];

  // Balance badge
  updateBalanceBadge();

  // #1 Credit payments
  renderPaymentsCard();

  // #3 Family placeholder
  renderFamilyCard();
}

function updateBalanceBadge() {
  const debit = appState.balances.filter(b => b.type === 'Ğ”ĞµĞ±ĞµÑ‚' || b.type === 'Ğ Ğ¡Ñ‡');
  const total = debit.reduce((s, b) => s + (b.balance || 0), 0);
  const badge = document.getElementById('balance-badge');

  if (total > 0) {
    const d = new Date();
    const dateStr = String(d.getDate()).padStart(2, '0') + '.' + String(d.getMonth() + 1).padStart(2, '0');
    badge.textContent = fmtShort(total) + ' (' + dateStr + ')';
  } else {
    badge.textContent = 'ĞĞ° ÑÑ‡ĞµÑ‚Ğ°Ñ…: Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ #1: ĞšĞ Ğ•Ğ”Ğ˜Ğ¢ĞĞ«Ğ• ĞŸĞ›ĞĞ¢Ğ•Ğ–Ğ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPaymentsCard() {
  const now = new Date();
  const today = now.getDate();
  const cm = now.getMonth() + 1;
  const daysInMonth = new Date(now.getFullYear(), cm, 0).getDate();

  const active = appState.credits.filter(c => c.status === 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹');
  const frozen = appState.credits.filter(c => (c.status || '').includes('Ğ—ĞĞœĞĞ ĞĞ–Ğ•Ğ'));

  // ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸ Ñ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğ¹ Ğ´Ğ°Ñ‚Ğ¾Ğ¹
  const withDay = active.filter(c => c.paymentDay > 0).map(c => ({
    name: c.name, amount: c.payment, day: c.paymentDay,
    isPast: c.paymentDay < today, isToday: c.paymentDay === today,
    daysUntil: c.paymentDay >= today ? c.paymentDay - today : daysInMonth - today + c.paymentDay
  })).sort((a, b) => a.day - b.day);

  // Ğ‘ĞµĞ· Ğ´Ğ°Ñ‚Ñ‹
  const noDay = active.filter(c => !c.paymentDay || c.paymentDay === 0);
  const noDayTotal = noDay.reduce((s, c) => s + c.payment, 0);

  const totalMonthly = active.reduce((s, c) => s + c.payment, 0);
  const remaining = withDay.filter(p => !p.isPast).reduce((s, p) => s + p.amount, 0) + noDayTotal;

  // Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ
  const totalBalance = appState.balances.filter(b => b.type === 'Ğ”ĞµĞ±ĞµÑ‚' || b.type === 'Ğ Ğ¡Ñ‡').reduce((s, b) => s + (b.balance || 0), 0);

  // ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ´Ğ¾Ñ…Ğ¾Ğ´Ğ° Ğ´Ğ¾ ĞºĞ¾Ğ½Ñ†Ğ° Ğ¼ĞµÑÑÑ†Ğ°
  const fc = appState.forecast.find(f => f.month === cm) || {};
  const monthProgress = today / daysInMonth;
  const remainingIncome = Math.round((fc.income || 0) * (1 - monthProgress));

  const available = totalBalance + remainingIncome;
  const afterPayments = available - remaining;
  const enough = afterPayments >= 0;

  // Ğ‘Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶
  const next = withDay.find(p => !p.isPast);

  let html = '';

  // ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞ³Ğ¾
  if (next) {
    const cls = next.daysUntil === 0 ? 'today' : next.daysUntil <= 2 ? 'urgent' : '';
    const when = next.isToday ? 'Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯!' : (next.daysUntil === 1 ? 'Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°' : 'Ñ‡ĞµÑ€ĞµĞ· ' + next.daysUntil + ' Ğ´Ğ½.');
    html += '<div class="next-payment ' + cls + '">';
    html += '<div class="next-label">Ğ‘Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶</div>';
    html += '<div class="next-info">' + next.name + ' &#x2014; ' + fmt(next.amount) + '</div>';
    html += '<div class="next-date">' + next.day + ' ' + MONTH_NAMES[cm] + ' &#x2022; ' + when + '</div>';
    html += '</div>';
  }

  // Ğ’ÑĞµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ¸
  html += '<div style="margin-bottom:8px;">';
  withDay.forEach(function(p) {
    var status = p.isPast ? '&#x2705;' : (p.isToday ? '&#x1F534;' : '&#x23F3;');
    var cls = p.isPast ? 'paid' : '';
    html += '<div class="pay-row ' + cls + '">';
    html += '<span class="pay-day">' + p.day + '-Ğµ</span>';
    html += '<span class="pay-name">' + p.name + '</span>';
    html += '<span class="pay-amount">' + fmt(p.amount) + '</span>';
    html += '<span class="pay-status">' + status + '</span>';
    html += '</div>';
  });

  if (noDay.length > 0) {
    html += '<div class="pay-row" style="opacity:0.6;">';
    html += '<span class="pay-day">&#x2014;</span>';
    html += '<span class="pay-name">' + noDay.length + ' Ğ±ĞµĞ· ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ´Ğ°Ñ‚Ñ‹</span>';
    html += '<span class="pay-amount">' + fmtShort(noDayTotal) + '</span>';
    html += '<span class="pay-status">&#x1F4C5;</span>';
    html += '</div>';
  }
  html += '</div>';

  // Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ + Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·
  html += '<div style="background:var(--bg); border-radius:12px; padding:12px; font-size:13px;">';
  html += '<div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğ² ' + MONTH_NAMES[cm] + 'Ğµ:</span><strong>' + fmtShort(totalMonthly) + '</strong></div>';
  html += '<div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ:</span><strong>' + fmtShort(remaining) + '</strong></div>';

  html += '<div class="forecast-box ' + (enough ? 'forecast-ok' : 'forecast-bad') + '">';
  if (enough) {
    html += '&#x2705; Ğ¥Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚. ĞŸĞ¾ÑĞ»Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹: ' + fmtShort(afterPayments);
  } else {
    html += '&#x274C; ĞĞµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚! Ğ”ĞµÑ„Ğ¸Ñ†Ğ¸Ñ‚: ' + fmtShort(Math.abs(afterPayments));
  }
  if (totalBalance > 0 && remainingIncome > 0) {
    html += '<div style="font-size:11px; margin-top:4px; opacity:0.8;">Ğ¡Ñ‡ĞµÑ‚Ğ° ' + fmtShort(totalBalance) + ' + Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ´Ğ¾Ñ…Ğ¾Ğ´Ğ° ' + fmtShort(remainingIncome) + '</div>';
  }
  html += '</div>';
  html += '</div>';

  document.getElementById('payments-content').innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ #2: Ğ‘Ğ˜Ğ—ĞĞ•Ğ¡ Ğ¡Ğ’ĞĞ”ĞšĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBizSummaryCard(data) {
  if (!data || !data.totals) {
    document.getElementById('biz-summary-content').innerHTML = '<div style="color:var(--text-secondary); font-size:13px;">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>';
    return;
  }

  const t = data.totals;
  const pct = t.performance ? t.performance.total : 0;
  const pctColor = pct >= 95 ? 'var(--accent-green)' : pct >= 80 ? '#F39C12' : 'var(--accent-red)';
  const monthName = data.monthName || MONTH_NAMES_CAP[data.currentMonth || 1];

  document.getElementById('biz-summary-month').textContent = monthName.toLowerCase();

  let html = '';
  html += '<div class="biz-mini">';
  html += '<div class="biz-mini-box"><div class="biz-mini-label">Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°</div><div class="biz-mini-value">' + fmtShort(t.fact.total) + '</div><div class="biz-mini-sub">Ğ¿Ğ»Ğ°Ğ½ ' + fmtShort(t.plan.total) + '</div></div>';
  html += '<div class="biz-mini-box"><div class="biz-mini-label">ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ</div><div class="biz-mini-value" style="color:var(--accent-green);">' + fmtShort(t.fact.profit) + '</div><div class="biz-mini-sub">' + (t.fact.clients || 0) + ' ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²</div></div>';
  html += '<div class="biz-mini-box"><div class="biz-mini-label">ĞŸĞ»Ğ°Ğ½</div><div class="biz-mini-value" style="color:' + pctColor + ';">' + pct + '%</div><div class="biz-mini-sub">Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ</div></div>';
  html += '</div>';

  html += '<div class="progress-bg"><div class="progress-fg" style="width:' + Math.min(pct, 100) + '%; background:' + pctColor + ';">' + pct + '%</div></div>';

  document.getElementById('biz-summary-content').innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ #3: Ğ¡Ğ•ĞœĞ¬Ğ¯ Ğ¡Ğ’ĞĞ”ĞšĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFamilyCard() {
  if (!appState.familySummary) {
    document.getElementById('family-summary-content').innerHTML = '<div style="font-size:13px; color:var(--text-secondary);">Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ğ² Ñ„Ğ¾Ğ½Ğµ...</div>';
    return;
  }

  const fs = appState.familySummary;
  const spent = fs.spent || 0;
  const budget = fs.budget || (appState.settings['Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ñ‹_ÑĞµĞ¼ÑŒÑ'] || 354000);
  const over = spent > budget;
  const pct = budget > 0 ? Math.round(spent / budget * 100) : 0;
  const diff = Math.abs(spent - budget);

  let html = '';
  html += '<div class="fam-bar"><span>ĞŸĞ¾Ñ‚Ñ€Ğ°Ñ‡ĞµĞ½Ğ¾</span><span><strong>' + fmtShort(spent) + '</strong> / ' + fmtShort(budget) + '</span></div>';
  html += '<div class="progress-bg" style="margin-bottom:8px;"><div class="progress-fg" style="width:' + Math.min(pct, 100) + '%; background:' + (over ? 'var(--accent-red)' : 'var(--accent-green)') + ';">' + pct + '%</div></div>';

  if (over) {
    html += '<div style="text-align:center; font-size:13px; color:var(--accent-red); font-weight:600;">ĞŸĞµÑ€ĞµÑ€Ğ°ÑÑ…Ğ¾Ğ´: ' + fmtShort(diff) + '</div>';
  } else {
    html += '<div style="text-align:center; font-size:13px; color:var(--accent-green); font-weight:600;">Ğ’ Ğ·Ğ°Ğ¿Ğ°ÑĞµ: ' + fmtShort(diff) + '</div>';
  }

  document.getElementById('family-summary-content').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: BUSINESS DETAIL (TAB 2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderBizOverview(data) {
  const t = data.totals;
  document.getElementById('ov-atelie').textContent = fmt(t.fact.atelie);
  document.getElementById('ov-himch').textContent = fmt(t.fact.himchistka);
  document.getElementById('ov-total').textContent = fmt(t.fact.total);
  document.getElementById('ov-clients').textContent = t.fact.clients.toLocaleString('ru-RU');
  document.getElementById('ov-profit').textContent = fmt(t.fact.profit);

  if (t.plan.total > 0) {
    document.getElementById('ov-atelie-plan').textContent = 'ĞŸĞ»Ğ°Ğ½: ' + fmt(t.plan.atelie) + ' (' + t.performance.atelie + '%)';
    document.getElementById('ov-himch-plan').textContent = 'ĞŸĞ»Ğ°Ğ½: ' + fmt(t.plan.himchistka) + ' (' + t.performance.himchistka + '%)';
    document.getElementById('ov-total-plan').textContent = 'ĞŸĞ»Ğ°Ğ½: ' + fmt(t.plan.total) + ' (' + t.performance.total + '%)';
  }
  if (t.fact.avgCheck) document.getElementById('ov-avg-check').textContent = 'Ğ¡Ñ€.Ñ‡ĞµĞº: ' + fmt(t.fact.avgCheck);

  const pct = t.performance ? Math.min(t.performance.total, 100) : 0;
  document.getElementById('ov-progress').style.width = pct + '%';
  document.getElementById('ov-progress').textContent = (t.performance ? t.performance.total : 0) + '%';
}

function renderFilials(data) {
  const grid = document.getElementById('filialsGrid');
  grid.innerHTML = '';
  const sorted = [...data.filials].sort((a, b) => b.fact.total - a.fact.total);

  sorted.forEach(function(f, i) {
    const rank = i + 1;
    const perf = f.performance.total;
    let perfClass = 'perf-low';
    if (perf >= 95) perfClass = 'perf-high';
    else if (perf >= 85) perfClass = 'perf-med';

    let forecastHtml = '';
    if (f.forecast) {
      const pEmoji = f.forecast.probability === 'high' ? '&#x1F7E2;' : f.forecast.probability === 'medium' ? '&#x1F7E1;' : '&#x1F534;';
      forecastHtml = '<div style="background:var(--bg); padding:10px; border-radius:10px; margin-top:10px; font-size:12px; border-left:3px solid var(--primary);"><strong>ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ·:</strong> ' + fmt(f.forecast.total) + ' ' + pEmoji + '<div style="font-size:10px; color:var(--text-secondary); margin-top:2px;">Ğ”Ğ½ĞµĞ¹: ' + f.forecast.daysPassed + '/' + (f.forecast.daysPassed + f.forecast.daysLeft) + '</div></div>';
    }

    grid.innerHTML += '<div class="filial-card">' +
      '<div class="filial-top"><div class="filial-name">' + f.name + '</div><div class="filial-rank">#' + rank + '</div></div>' +
      '<div class="filial-row"><span>ĞÑ‚ĞµĞ»ÑŒĞµ:</span><span>' + fmt(f.fact.atelie) + '</span></div>' +
      '<div style="font-size:10px; color:var(--text-secondary); margin-bottom:6px;">ĞŸĞ»Ğ°Ğ½: ' + fmt(f.plan.atelie) + ' (' + f.performance.atelie + '%)</div>' +
      '<div class="filial-row"><span>Ğ¥Ğ¸Ğ¼Ñ‡Ğ¸ÑÑ‚ĞºĞ°:</span><span>' + fmt(f.fact.himchistka) + '</span></div>' +
      '<div style="font-size:10px; color:var(--text-secondary); margin-bottom:6px;">ĞŸĞ»Ğ°Ğ½: ' + fmt(f.plan.himchistka) + ' (' + f.performance.himchistka + '%)</div>' +
      '<div class="filial-row"><span><strong>Ğ˜Ğ¢ĞĞ“Ğ:</strong></span><span><strong>' + fmt(f.fact.total) + '</strong></span></div>' +
      '<div class="filial-perf ' + perfClass + '">' + perf + '% Ğ¾Ñ‚ Ğ¿Ğ»Ğ°Ğ½Ğ°</div>' +
      '<div style="background:#E7F3FF; padding:8px; border-radius:8px; margin-top:8px; font-size:11px;">' +
        '<div style="display:flex; justify-content:space-between;"><span>ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹:</span><strong>' + f.fact.clients + '</strong></div>' +
        '<div style="display:flex; justify-content:space-between;"><span>Ğ¡Ñ€.Ñ‡ĞµĞº:</span><strong>' + fmt(f.fact.avgCheck) + '</strong></div>' +
        '<div style="display:flex; justify-content:space-between;"><span>ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ:</span><strong>' + fmt(f.fact.profit) + '</strong></div>' +
      '</div>' + forecastHtml + '</div>';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: CREDITS DETAIL (expandable section in Tab 1)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderCreditsDetail() {
  const credits = appState.credits;
  if (!credits.length) return;

  const active = credits.filter(c => c.status === 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹');
  const totalDebt = active.reduce(function(s, c) { return s + (c.balanceCurrent || c.balanceInit); }, 0);
  const initialDebt = 19192366;
  const paidPct = Math.round((1 - totalDebt / initialDebt) * 100);

  let summaryHtml = '<div style="background:var(--bg); border-radius:12px; padding:14px; margin-bottom:12px; text-align:center;">';
  summaryHtml += '<div style="font-size:12px; color:var(--text-secondary);">ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ´Ğ¾Ğ»Ğ³</div>';
  summaryHtml += '<div style="font-size:22px; font-weight:800;">' + fmtShort(totalDebt) + '</div>';
  summaryHtml += '<div class="progress-bg" style="margin-top:8px;"><div class="progress-fg" style="width:' + Math.max(paidPct, 0) + '%; background:var(--accent-green);">' + paidPct + '%</div></div>';
  summaryHtml += '<div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">ĞŸĞ¾Ğ³Ğ°ÑˆĞµĞ½Ğ¾ ' + fmtShort(initialDebt - totalDebt) + ' Ğ¸Ğ· ' + fmtShort(initialDebt) + '</div>';
  summaryHtml += '</div>';
  document.getElementById('credits-summary-box').innerHTML = summaryHtml;

  const list = document.getElementById('credits-list');
  list.innerHTML = '';

  const sorted = [...credits].sort(function(a, b) {
    if ((a.status || '').includes('Ğ—ĞĞœĞĞ ĞĞ–Ğ•Ğ')) return 1;
    if ((b.status || '').includes('Ğ—ĞĞœĞĞ ĞĞ–Ğ•Ğ')) return -1;
    return (b.rate || 0) - (a.rate || 0);
  });

  sorted.forEach(function(c) {
    const balance = c.balanceCurrent || c.balanceInit;
    const isFrozen = (c.status || '').includes('Ğ—ĞĞœĞĞ ĞĞ–Ğ•Ğ');
    const paidPct = Math.round((1 - balance / c.balanceInit) * 100);
    const rateStr = c.rate ? (c.rate * 100).toFixed(1) + '%' : '0%';
    let badge = '';
    if (c.priority > 0 && c.priority <= 3 && !isFrozen) {
      badge = '<span style="background:var(--accent-red); color:white; font-size:9px; padding:2px 6px; border-radius:6px; margin-left:6px;">ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ ' + c.priority + '</span>';
    }
    list.innerHTML += '<div class="credit-card ' + (isFrozen ? 'frozen' : '') + '">' +
      '<div class="credit-top"><div><span class="credit-name">' + c.name + '</span>' + badge + '</div><span class="credit-rate">' + rateStr + '</span></div>' +
      '<div class="credit-amount">' + fmt(balance) + '</div>' +
      '<div class="credit-row"><span>ĞŸĞ»Ğ°Ñ‚Ñ‘Ğ¶ /Ğ¼ĞµÑ</span><span>' + fmt(c.payment) + '</span></div>' +
      (c.paymentDay ? '<div class="credit-row"><span>Ğ”ĞµĞ½ÑŒ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°</span><span>' + c.paymentDay + '-Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾</span></div>' : '') +
      (c.closeDate ? '<div class="credit-row"><span>Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ</span><span>' + c.closeDate + '</span></div>' : '') +
      '<div class="credit-progress"><div class="credit-progress-fill" style="width:' + Math.max(paidPct, 0) + '%;"></div></div>' +
      '<div style="text-align:right; font-size:10px; color:var(--text-secondary); margin-top:2px;">ĞŸĞ¾Ğ³Ğ°ÑˆĞµĞ½Ğ¾ ' + paidPct + '%</div>' +
      '</div>';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchTab(name, btn) {
  document.querySelectorAll('.main-tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.nav-btn').forEach(function(b) { b.classList.remove('active'); });
  document.getElementById('tab-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  else document.getElementById('nav-' + name).classList.add('active');
}

function toggleSection(id, el) {
  const section = document.getElementById(id);
  const isOpen = section.style.display !== 'none';
  section.style.display = isOpen ? 'none' : 'block';
  el.classList.toggle('open', !isOpen);
}

function refreshAll() {
  loadAllData();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function fmt(num) {
  if (!num && num !== 0) return '\u2014';
  return new Intl.NumberFormat('ru-RU').format(Math.round(num)) + '\u20BD';
}

function fmtShort(num) {
  if (!num) return '0';
  if (num < 0) return '\u2212' + fmtShort(Math.abs(num));
  if (num >= 1000000) return (num / 1000000).toFixed(1) + '\u041C\u20BD';
  if (num >= 1000) return Math.round(num / 1000) + '\u041A\u20BD';
  return Math.round(num) + '\u20BD';
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(function() { toast.classList.remove('show'); }, 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FAMILY IFRAME COMMUNICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.addEventListener('message', function(e) {
  if (e.data && e.data.type === 'familySummary') {
    appState.familySummary = e.data;
    renderFamilyCard();
  }
  if (e.data && e.data.type === 'bizExpensesSummary') {
    appState.bizExpenses = e.data;
    renderBizExpensesCard();
  }
});

function renderBizExpensesCard() {
  const card = document.getElementById('biz-expenses-card');
  if (!card) return;
  const d = appState.bizExpenses;
  if (!d || d.total === 0) { card.style.display = 'none'; return; }
  card.style.display = 'block';
  const cats = { rent: 'ğŸ  ĞÑ€ĞµĞ½Ğ´Ğ°', supplies: 'ğŸ§µ Ğ—Ğ°ĞºÑƒĞ¿ĞºĞ¸', drycleaning: 'ğŸ‘” Ğ¥Ğ¸Ğ¼Ñ‡Ğ¸ÑÑ‚ĞºĞ°', taxes: 'ğŸ¦ ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸', maintenance: 'ğŸ”§ ĞĞ¼Ğ¾Ñ€Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ', bonuses: 'ğŸ‰ ĞŸÑ€ĞµĞ¼Ğ¸Ğ¸' };
  let html = '<div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span style="font-weight:700;">Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹ Ğ°Ñ‚ĞµĞ»ÑŒĞµ (Ğ¸Ğ· Ğ²Ñ‹Ğ¿Ğ¸ÑĞ¾Ğº)</span><span style="font-weight:700;">' + fmtShort(d.total) + '</span></div>';
  const keys = Object.keys(d.byCat || {}).filter(function(k) { return d.byCat[k] > 0; });
  if (keys.length > 0) {
    keys.sort(function(a, b) { return d.byCat[b] - d.byCat[a]; });
    keys.forEach(function(k) {
      html += '<div style="display:flex; justify-content:space-between; font-size:12px; padding:2px 0;"><span>' + (cats[k] || k) + '</span><span>' + fmtShort(d.byCat[k]) + '</span></div>';
    });
  }
  html += '<div style="font-size:11px; color:var(--text-secondary); margin-top:6px;">' + d.count + ' Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ‡ĞµĞ½Ğ¾</div>';
  card.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.onload = function() {
  const now = new Date();
  const sel = document.getElementById('bizMonthSelect');
  if (sel) sel.value = now.getMonth() + 1;

  loadAllData();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(function(err) { console.log('SW:', err); });
  }
};
</script>
</body>
</html>
