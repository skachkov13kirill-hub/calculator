<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç v19</title>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#8b5cf6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–ë—é–¥–∂–µ—Ç">
  <link rel="apple-touch-icon" href="icon-512.svg">
  <link rel="icon" type="image/svg+xml" href="icon-512.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    :root {
      --bg-main: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #1f2937;
      --text-secondary: #6b7280;
      --color-primary: #8b5cf6;
      --color-secondary: #d946ef;
    }
    
    /* ===== EMBEDDED MODE (inside unified app iframe) ===== */
    body.embedded-mode #mainHeader { display: none; }
    body.embedded-mode #app { padding: 8px 12px 4px; }
    body.embedded-mode footer { display: none; }
    
    body { font-family: 'Inter', sans-serif; background: var(--bg-main); color: var(--text-main); }
    .gradient-header { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #d946ef 100%); }
    .category-card { transition: all 0.2s ease; background: var(--bg-card); }
    .category-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(139, 92, 246, 0.15); }
    .tab-active { background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .progress-bar { transition: width 0.5s ease; }
    input[type="file"]::file-selector-button {
      background: linear-gradient(135deg, #8b5cf6, #a855f7);
      color: white; border: none; padding: 10px 20px;
      border-radius: 10px; cursor: pointer; font-weight: 500; margin-right: 12px;
    }
    
    /* ===== TOAST –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===== */
    .toast-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      width: 90%;
      max-width: 440px;
    }
    .toast {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.05);
      padding: 20px;
      animation: toastIn 0.35s ease-out;
      position: relative;
      overflow: hidden;
    }
    .toast::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
    }
    .toast-success::before { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .toast-delete::before { background: linear-gradient(90deg, #ef4444, #dc2626); }
    .toast-undo::before { background: linear-gradient(90deg, #8b5cf6, #a855f7); }
    .toast-info::before { background: linear-gradient(90deg, #3b82f6, #2563eb); }
    
    body.dark-theme .toast { background: #1e293b; color: #eee; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    
    @keyframes toastIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
    
    /* ===== –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê ===== */
    body.dark-theme { background: #1a1a2e; color: #eee; }
    
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–æ–Ω—ã */
    body.dark-theme .bg-white { background: #16213e !important; }
    body.dark-theme .bg-gray-50 { background: #1a1a2e !important; }
    body.dark-theme .bg-gray-100 { background: #0f3460 !important; }
    
    /* –¢–µ–∫—Å—Ç –Ω–∞ —Ç—ë–º–Ω–æ–º —Ñ–æ–Ω–µ - —Å–≤–µ—Ç–ª—ã–π */
    body.dark-theme .text-gray-800 { color: #f1f5f9 !important; }
    body.dark-theme .text-gray-700 { color: #e2e8f0 !important; }
    body.dark-theme .text-gray-600 { color: #cbd5e1 !important; }
    body.dark-theme .text-gray-500 { color: #94a3b8 !important; }
    body.dark-theme .text-gray-400 { color: #64748b !important; }
    
    /* –ì—Ä–∞–Ω–∏—Ü—ã */
    body.dark-theme .border-gray-200 { border-color: #0f3460 !important; }
    body.dark-theme .border-gray-100 { border-color: #16213e !important; }
    body.dark-theme .divide-gray-100 > * + * { border-color: #0f3460 !important; }
    
    /* –¶–≤–µ—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ - –¥–µ–ª–∞–µ–º —Ñ–æ–Ω —Ç—ë–º–Ω—ã–º, —Ç–µ–∫—Å—Ç —è—Ä–∫–∏–º */
    body.dark-theme .bg-red-50 { background: #3b1c1c !important; }
    body.dark-theme .bg-red-100 { background: #4c2020 !important; }
    body.dark-theme .bg-green-50 { background: #1c3b2a !important; }
    body.dark-theme .bg-green-100 { background: #204c35 !important; }
    body.dark-theme .bg-blue-50 { background: #1c2a3b !important; }
    body.dark-theme .bg-purple-50 { background: #2a1c3b !important; }
    
    /* –¢–µ–∫—Å—Ç –Ω–∞ —Ü–≤–µ—Ç–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–∫–∞—Ö - —è—Ä–∫–∏–π –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π */
    body.dark-theme .bg-red-50 .text-red-600,
    body.dark-theme .bg-red-50 .text-red-700,
    body.dark-theme .bg-red-100 .text-red-600 { color: #fca5a5 !important; }
    
    body.dark-theme .bg-green-50 .text-green-600,
    body.dark-theme .bg-green-50 .text-green-700,
    body.dark-theme .bg-green-100 .text-green-600 { color: #86efac !important; }
    
    body.dark-theme .bg-blue-50 .text-blue-600,
    body.dark-theme .bg-blue-50 .text-blue-700 { color: #93c5fd !important; }
    
    body.dark-theme .bg-purple-50 .text-purple-600,
    body.dark-theme .bg-purple-50 .text-purple-700 { color: #c4b5fd !important; }
    
    /* –§–æ—Ä–º—ã */
    body.dark-theme select, 
    body.dark-theme input[type="text"],
    body.dark-theme input[type="color"] { background: #0f3460; color: #eee; border-color: #16213e; }
    body.dark-theme input[type="range"] { background: #0f3460; }
    
    /* –ö–Ω–æ–ø–∫–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
    body.dark-theme #settingsContent .bg-gray-200 { background: #0f3460 !important; color: #eee !important; }
    body.dark-theme #settingsContent .bg-gray-200:hover { background: #16213e !important; }
    body.dark-theme #settingsContent .hover\:bg-gray-300:hover { background: #1a3a5c !important; }
    body.dark-theme #settingsContent button { color: #eee; }
    body.dark-theme #settingsContent .bg-gray-800 { background: #0a1628 !important; }
    
    /* –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ */
    body.dark-theme #settingsContent .bg-purple-100 { background: #3b2667 !important; }
    body.dark-theme #settingsContent .bg-purple-100:hover { background: #4c3280 !important; }
    body.dark-theme #settingsContent .bg-blue-100 { background: #1e3a5f !important; }
    body.dark-theme #settingsContent .bg-blue-100:hover { background: #264a75 !important; }
    body.dark-theme #settingsContent .bg-red-100 { background: #5c2424 !important; }
    body.dark-theme #settingsContent .bg-red-100:hover { background: #6e2c2c !important; }
    body.dark-theme #settingsContent .text-purple-700 { color: #c4b5fd !important; }
    body.dark-theme #settingsContent .text-blue-700 { color: #93c5fd !important; }
    body.dark-theme #settingsContent .text-red-600 { color: #fca5a5 !important; }
    body.dark-theme #settingsContent .text-gray-600 { color: #cbd5e1 !important; }
    
    /* Hover —ç—Ñ—Ñ–µ–∫—Ç—ã */
    body.dark-theme .hover\:bg-gray-50:hover { background: #0f3460 !important; }
    body.dark-theme .hover\:bg-gray-100:hover { background: #16213e !important; }
    body.dark-theme .hover\:bg-purple-50:hover { background: #2a1c3b !important; }
    body.dark-theme .hover\:bg-red-100:hover { background: #5c2424 !important; }
    body.dark-theme .hover\:bg-green-100:hover { background: #245c40 !important; }
    
    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    body.dark-theme #settingsContent { background: #16213e; }
    body.dark-theme #settingsContent .bg-gray-50 { background: #0f3460 !important; }
    body.dark-theme #drillModal .bg-white { background: #16213e !important; }
    body.dark-theme #uploadModal .bg-white { background: #16213e !important; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

<div class="toast-container" id="toastContainer"></div>

<div id="app" class="max-w-4xl mx-auto p-4">
  
  <!-- Header -->
  <header id="mainHeader" class="gradient-header rounded-3xl p-6 mb-6 text-white shadow-xl">
    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
      <div class="flex items-center gap-3">
        <span class="text-3xl">üë®‚Äçüë©‚Äçüëß</span>
        <div>
          <h1 class="text-2xl font-bold">–°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</h1>
          <p class="text-white/70 text-sm" id="periodInfo">–Ø–Ω–≤–∞—Ä—å 2026 ‚Ä¢ –¢–æ–ª—å–∫–æ –°–±–µ—Ä</p>
        </div>
      </div>
      <div class="flex gap-2">
        <div class="relative group">
          <button onclick="showUploadModal()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-sm font-medium transition-all flex items-center gap-2">
            üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å
          </button>
          <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none">
            –ó–∞–≥—Ä—É–∑–∏—Ç—å PDF –≤—ã–ø–∏—Å–∫–∏ –°–±–µ—Ä–±–∞–Ω–∫–∞
            <div class="absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-gray-900"></div>
          </div>
        </div>
        <div class="relative group">
          <button onclick="syncWithSheets()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-sm font-medium transition-all">
            üîÑ
          </button>
          <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Google Sheets
            <div class="absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-gray-900"></div>
          </div>
        </div>
        <div class="relative group">
          <button id="undoBtn" onclick="undo()" class="bg-white/20 px-4 py-2 rounded-xl text-sm font-medium transition-all opacity-50 cursor-not-allowed">
            ‚Ü©Ô∏è
          </button>
          <div id="undoTooltip" class="absolute top-full left-1/2 -translate-x-1/2 mt-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none">
            –ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã
            <div class="absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-gray-900"></div>
          </div>
        </div>
        <div class="relative group">
          <button onclick="showSettingsModal()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-sm font-medium transition-all">
            ‚öôÔ∏è
          </button>
          <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none">
            –ù–∞—Å—Ç—Ä–æ–π–∫–∏: —Ç–µ–º–∞, —Ü–≤–µ—Ç–∞, —à—Ä–∏—Ñ—Ç
            <div class="absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-gray-900"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="bg-white/20 rounded-2xl p-4 mb-4">
      <div class="flex justify-between text-sm mb-2">
        <span id="progressLabel">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</span>
        <span id="progressValues">0‚ÇΩ / 0‚ÇΩ</span>
      </div>
      <div class="bg-white/30 rounded-full h-3 overflow-hidden">
        <div id="progressBar" class="progress-bar bg-white h-full rounded-full" style="width: 0%"></div>
      </div>
      <div class="flex justify-between text-xs mt-2 text-white/70">
        <span id="remainingBudget">–û—Å—Ç–∞—Ç–æ–∫: 0‚ÇΩ</span>
        <span id="progressPercent">0%</span>
      </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="grid grid-cols-2 gap-3">
      <div class="bg-white/20 backdrop-blur rounded-2xl p-4 text-center cursor-pointer hover:bg-white/30 transition" onclick="showTab('categories')">
        <div class="text-sm text-white/70">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</div>
        <div class="text-2xl font-bold" id="monthTotal">0‚ÇΩ</div>
      </div>
      <div class="bg-white/20 backdrop-blur rounded-2xl p-4 text-center cursor-pointer hover:bg-white/30 transition" onclick="showTab('trends')">
        <div class="text-sm text-white/70">–ù–æ—Ä–º–∞/–º–µ—Å—è—Ü</div>
        <div class="text-2xl font-bold" id="monthNorm">0‚ÇΩ</div>
      </div>
    </div>
  </header>

  <!-- Filters -->
  <div class="flex gap-2 mb-4 flex-wrap items-center">
    <select id="monthFilter" onchange="applyFilters()" class="bg-white border border-gray-200 rounded-xl px-4 py-2 text-sm font-medium">
      <option value="2026-01">–Ø–Ω–≤–∞—Ä—å 2026</option>
    </select>
    <select id="monthFilterTo" onchange="applyFilters()" class="bg-white border border-gray-200 rounded-xl px-4 py-2 text-sm font-medium hidden">
      <option value="">–¥–æ...</option>
    </select>
    <select id="ownerFilter" onchange="applyFilters()" class="bg-white border border-gray-200 rounded-xl px-4 py-2 text-sm font-medium">
      <option value="all">–í—Å–µ</option>
      <option value="–ö–∏—Ä–∏–ª–ª">–ö–∏—Ä–∏–ª–ª</option>
      <option value="–ê–ª—ë–Ω–∞">–ê–ª—ë–Ω–∞</option>
    </select>
    <select id="categoryFilter" onchange="applyFilters()" class="bg-white border border-gray-200 rounded-xl px-4 py-2 text-sm font-medium">
      <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
    </select>
  </div>

  <!-- Tabs -->
  <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
    <button onclick="showTab('overview')" class="tab-btn tab-active px-5 py-2.5 rounded-xl font-medium transition-all whitespace-nowrap" data-tab="overview">üìä –û–±–∑–æ—Ä</button>
    <button onclick="showTab('categories')" class="tab-btn bg-white text-gray-600 hover:bg-purple-50 px-5 py-2.5 rounded-xl font-medium transition-all whitespace-nowrap" data-tab="categories">üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
    <button onclick="showTab('trends')" class="tab-btn bg-white text-gray-600 hover:bg-purple-50 px-5 py-2.5 rounded-xl font-medium transition-all whitespace-nowrap" data-tab="trends">üìà –î–∏–Ω–∞–º–∏–∫–∞</button>
    <button onclick="showTab('transactions')" class="tab-btn bg-white text-gray-600 hover:bg-purple-50 px-5 py-2.5 rounded-xl font-medium transition-all whitespace-nowrap" data-tab="transactions">üìú –û–ø–µ—Ä–∞—Ü–∏–∏</button>
    <button onclick="showTab('excluded')" class="tab-btn bg-white text-gray-600 hover:bg-purple-50 px-5 py-2.5 rounded-xl font-medium transition-all whitespace-nowrap" data-tab="excluded">üîÄ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</button>
    <button onclick="showTab('bizexpenses')" class="tab-btn bg-white text-gray-600 hover:bg-purple-50 px-5 py-2.5 rounded-xl font-medium transition-all whitespace-nowrap" data-tab="bizexpenses">üíº –ê—Ç–µ–ª—å–µ</button>
  </div>

  <!-- Tab Content -->
  <div id="tabContent" class="fade-in"></div>

  <!-- Footer -->
  <footer class="text-center text-sm text-gray-400 mt-6 pb-4">
    v18 ‚Ä¢ –î–∞–Ω–Ω—ã–µ –≤ Google Sheets ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="lastUpdate">‚Äî</span>
  </footer>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
  <div class="bg-white rounded-3xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-2xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-gray-800">üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –≤—ã–ø–∏—Å–æ–∫</h2>
      <button onclick="hideUploadModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>
    
    <div id="dropZone" class="bg-gradient-to-br from-purple-50 to-fuchsia-50 rounded-2xl p-8 mb-4 border-2 border-dashed border-purple-300 transition-all hover:border-purple-500 hover:bg-purple-100/50 cursor-pointer"
         onclick="document.getElementById('fileInput').click()"
         ondragover="event.preventDefault(); this.classList.add('border-purple-500', 'bg-purple-100')"
         ondragleave="this.classList.remove('border-purple-500', 'bg-purple-100')"
         ondrop="event.preventDefault(); this.classList.remove('border-purple-500', 'bg-purple-100'); handleFiles(event.dataTransfer.files)">
      <div class="text-center">
        <div class="text-5xl mb-3">üìÑ</div>
        <p class="text-gray-700 font-medium mb-1">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ PDF —Ñ–∞–π–ª—ã —Å—é–¥–∞</p>
        <p class="text-gray-500 text-sm mb-3">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
        <p class="text-purple-600 text-xs">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤—ã–ø–∏—Å–∫–∏ –°–±–µ—Ä–±–∞–Ω–∫–∞</p>
      </div>
      <input type="file" id="fileInput" multiple accept=".pdf" onchange="handleFiles(this.files)" class="hidden">
    </div>
    
    <div id="selectedFiles" class="hidden mb-4 p-3 bg-green-50 rounded-xl">
      <div class="flex items-center gap-2 text-green-700">
        <span>‚úÖ</span>
        <span id="filesCount">0 —Ñ–∞–π–ª–æ–≤ –≤—ã–±—Ä–∞–Ω–æ</span>
      </div>
    </div>
    
    <div id="loadingIndicator" class="hidden mb-4 p-4 bg-purple-50 rounded-xl">
      <div class="flex items-center justify-center gap-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
        <p class="text-purple-600">–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF...</p>
      </div>
    </div>

    <div id="uploadPreview" class="hidden mb-4">
      <h3 class="font-semibold text-gray-700 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (<span id="previewCount">0</span> —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π):</h3>
      <div id="previewList" class="max-h-48 overflow-y-auto bg-gray-50 rounded-xl p-4 text-sm space-y-1"></div>
    </div>

    <div class="flex gap-3">
      <button onclick="processTransactions()" id="processBtn" disabled class="flex-1 bg-gradient-to-r from-purple-500 to-fuchsia-500 disabled:from-gray-300 disabled:to-gray-400 text-white px-6 py-3 rounded-xl font-semibold transition-all">
        ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      </button>
      <button onclick="hideUploadModal()" class="bg-gray-200 hover:bg-gray-300 px-6 py-3 rounded-xl font-medium transition-all">
        –û—Ç–º–µ–Ω–∞
      </button>
    </div>
  </div>
</div>

<!-- Drill-down Modal -->
<div id="drillModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
  <div class="bg-white rounded-3xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-gray-800" id="drillTitle">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2>
      <button onclick="hideDrillModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>
    <div id="drillContent"></div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
  <div class="bg-white rounded-3xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto shadow-2xl" id="settingsContent">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-gray-800">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <button onclick="hideSettingsModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>
    
    <div class="space-y-4">
      <!-- –¢–µ–º–∞ -->
      <div class="p-4 bg-gray-50 rounded-xl">
        <h3 class="font-semibold text-gray-700 mb-3">üåì –¢–µ–º–∞</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="setTheme('light')" id="themeLightBtn" class="p-3 rounded-lg border-2 border-purple-500 bg-white text-gray-800 font-medium transition">
            ‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è
          </button>
          <button onclick="setTheme('dark')" id="themeDarkBtn" class="p-3 rounded-lg border-2 border-transparent bg-gray-800 text-white font-medium transition">
            üåô –¢—ë–º–Ω–∞—è
          </button>
        </div>
      </div>
      
      <!-- –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ -->
      <div class="p-4 bg-gray-50 rounded-xl">
        <h3 class="font-semibold text-gray-700 mb-3">üé® –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞</h3>
        <div class="grid grid-cols-4 gap-2 mb-3">
          <button onclick="setColorScheme('purple')" class="w-full h-10 rounded-lg bg-gradient-to-r from-purple-500 to-fuchsia-500 border-2 border-transparent hover:border-gray-400 transition" title="–§–∏–æ–ª–µ—Ç–æ–≤–∞—è"></button>
          <button onclick="setColorScheme('blue')" class="w-full h-10 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-500 border-2 border-transparent hover:border-gray-400 transition" title="–°–∏–Ω—è—è"></button>
          <button onclick="setColorScheme('green')" class="w-full h-10 rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 border-2 border-transparent hover:border-gray-400 transition" title="–ó–µ–ª—ë–Ω–∞—è"></button>
          <button onclick="setColorScheme('orange')" class="w-full h-10 rounded-lg bg-gradient-to-r from-orange-500 to-red-500 border-2 border-transparent hover:border-gray-400 transition" title="–û—Ä–∞–Ω–∂–µ–≤–∞—è"></button>
          <button onclick="setColorScheme('pink')" class="w-full h-10 rounded-lg bg-gradient-to-r from-pink-500 to-rose-500 border-2 border-transparent hover:border-gray-400 transition" title="–†–æ–∑–æ–≤–∞—è"></button>
          <button onclick="setColorScheme('teal')" class="w-full h-10 rounded-lg bg-gradient-to-r from-teal-500 to-cyan-500 border-2 border-transparent hover:border-gray-400 transition" title="–ë–∏—Ä—é–∑–æ–≤–∞—è"></button>
          <button onclick="setColorScheme('indigo')" class="w-full h-10 rounded-lg bg-gradient-to-r from-indigo-500 to-violet-500 border-2 border-transparent hover:border-gray-400 transition" title="–ò–Ω–¥–∏–≥–æ"></button>
          <button onclick="setColorScheme('gray')" class="w-full h-10 rounded-lg bg-gradient-to-r from-gray-500 to-slate-600 border-2 border-transparent hover:border-gray-400 transition" title="–°–µ—Ä–∞—è"></button>
        </div>
        <div class="mt-4 p-3 bg-purple-100 rounded-xl border-2 border-purple-300">
          <label class="block text-sm font-bold text-purple-700 mb-2">üéØ –°–≤–æ–π —Ü–≤–µ—Ç</label>
          <input type="color" id="colorPrimary" value="#8b5cf6" onchange="applyCustomColor()" class="w-full h-12 rounded-lg cursor-pointer border-2 border-purple-300">
          <p class="text-xs text-purple-600 mt-1">–í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–æ–π —Ü–≤–µ—Ç –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã</p>
        </div>
      </div>
      
      <!-- –®—Ä–∏—Ñ—Ç -->
      <div class="p-4 bg-gray-50 rounded-xl">
        <h3 class="font-semibold text-gray-700 mb-3">üî§ –®—Ä–∏—Ñ—Ç</h3>
        <select id="fontSelect" onchange="setFont(this.value)" class="w-full p-3 border rounded-lg text-sm">
          <option value="system">–°–∏—Å—Ç–µ–º–Ω—ã–π</option>
          <option value="inter">Inter</option>
          <option value="roboto">Roboto</option>
          <option value="open-sans">Open Sans</option>
          <option value="montserrat">Montserrat</option>
          <option value="nunito">Nunito</option>
        </select>
      </div>
      
      <!-- –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ -->
      <div class="p-4 bg-gray-50 rounded-xl">
        <h3 class="font-semibold text-gray-700 mb-3">üìè –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</h3>
        <div class="flex items-center gap-3">
          <button onclick="setFontSize('small')" class="flex-1 py-2 px-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-sm transition">A-</button>
          <button onclick="setFontSize('medium')" class="flex-1 py-2 px-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-base transition">A</button>
          <button onclick="setFontSize('large')" class="flex-1 py-2 px-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-lg transition">A+</button>
        </div>
      </div>
      
      <!-- –§–æ—Ç–æ –Ω–∞ —Ñ–æ–Ω -->
      <div class="p-4 bg-gray-50 rounded-xl">
        <h3 class="font-semibold text-gray-700 mb-3">üñºÔ∏è –§–æ—Ç–æ –Ω–∞ —Ñ–æ–Ω</h3>
        
        <!-- –§–æ—Ç–æ —à–∞–ø–∫–∏ -->
        <div class="mb-4">
          <div class="relative group">
            <label class="block text-sm font-medium text-gray-600 mb-2">–§–æ—Ç–æ –≤ —à–∞–ø–∫—É:</label>
            <div class="flex gap-2">
              <label class="flex-1 cursor-pointer">
                <div class="p-3 bg-purple-100 hover:bg-purple-200 rounded-lg text-center text-purple-700 text-sm font-medium transition">
                  üì∑ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ
                </div>
                <input type="file" accept="image/*" onchange="setHeaderPhoto(this.files)" class="hidden">
              </label>
              <button onclick="removeHeaderPhoto()" class="px-3 py-2 bg-red-100 hover:bg-red-200 rounded-lg text-red-600 text-sm transition" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">
                üóëÔ∏è
              </button>
            </div>
            <div class="absolute bottom-full left-0 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none w-full">
              –§–æ—Ç–æ –±—É–¥–µ—Ç —Ä–∞–∑–º—ã—Ç–æ –∏ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ —à–∞–ø–∫–µ –∑–∞ —Ç–µ–∫—Å—Ç–æ–º "–°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç"
            </div>
          </div>
          <div id="headerPhotoPreview" class="mt-2 hidden">
            <img id="headerPhotoImg" class="w-full h-16 object-cover rounded-lg opacity-50">
          </div>
        </div>
        
        <!-- –§–æ—Ç–æ —Ñ–æ–Ω–∞ -->
        <div class="mb-4">
          <div class="relative group">
            <label class="block text-sm font-medium text-gray-600 mb-2">–§–æ—Ç–æ –Ω–∞ –≤–µ—Å—å —Ñ–æ–Ω:</label>
            <div class="flex gap-2">
              <label class="flex-1 cursor-pointer">
                <div class="p-3 bg-blue-100 hover:bg-blue-200 rounded-lg text-center text-blue-700 text-sm font-medium transition">
                  üåÑ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ
                </div>
                <input type="file" accept="image/*" onchange="setBackgroundPhoto(this.files)" class="hidden">
              </label>
              <button onclick="removeBackgroundPhoto()" class="px-3 py-2 bg-red-100 hover:bg-red-200 rounded-lg text-red-600 text-sm transition" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">
                üóëÔ∏è
              </button>
            </div>
            <div class="absolute bottom-full left-0 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none w-full">
              –§–æ—Ç–æ –±—É–¥–µ—Ç —Ä–∞–∑–º—ã—Ç–æ –∏ –ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∞ —Ñ–æ–Ω–µ –≤—Å–µ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞
            </div>
          </div>
          <div id="bgPhotoPreview" class="mt-2 hidden">
            <img id="bgPhotoImg" class="w-full h-16 object-cover rounded-lg opacity-50">
          </div>
        </div>
        
        <!-- –°–∏–ª–∞ —Ä–∞–∑–º—ã—Ç–∏—è -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-2">–°–∏–ª–∞ —Ä–∞–∑–º—ã—Ç–∏—è: <span id="blurValue">10</span>px</label>
          <input type="range" id="blurSlider" min="0" max="30" value="10" onchange="updateBlur(this.value)" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
          <div class="flex justify-between text-xs text-gray-400 mt-1">
            <span>–ß—ë—Ç–∫–æ–µ</span>
            <span>–°–∏–ª—å–Ω–æ–µ —Ä–∞–∑–º—ã—Ç–∏–µ</span>
          </div>
        </div>
      </div>
      
      <!-- –ù–æ—Ä–º—ã —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
      <div class="p-4 bg-gray-50 rounded-xl">
        <h3 class="font-semibold text-gray-700 mb-3">üìä –ù–æ—Ä–º—ã —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="setNormsMode('fixed')" id="normsFixedBtn" class="p-3 rounded-lg border-2 border-purple-500 bg-purple-50 text-purple-700 font-medium transition text-sm">
            üìå –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
          </button>
          <button onclick="setNormsMode('auto')" id="normsAutoBtn" class="p-3 rounded-lg border-2 border-transparent bg-gray-200 text-gray-600 font-medium transition text-sm">
            üîÑ –ê–≤—Ç–æ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-2" id="normsHint">–ù–æ—Ä–º—ã –∑–∞–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é (DEFAULT_NORMS)</p>
      </div>
      
      <!-- –°–±—Ä–æ—Å -->
      <button onclick="resetAllSettings()" class="w-full text-sm text-red-600 hover:underline py-2">
        –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      </button>
    </div>
    
    <button onclick="hideSettingsModal()" class="w-full mt-4 bg-purple-600 text-white py-3 rounded-xl font-medium hover:bg-purple-700">
      –ó–∞–∫—Ä—ã—Ç—å
    </button>
  </div>
</div>

<script>
// ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================

// ==================== TOAST –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ====================

function showToast(config) {
  const { icon, title, message, type, duration, showUndo } = {
    icon: '‚úÖ',
    title: '–ì–æ—Ç–æ–≤–æ',
    message: '',
    type: 'success',
    duration: 5000,
    showUndo: true,
    ...config
  };
  
  const container = document.getElementById('toastContainer');
  
  // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π toast –µ—Å–ª–∏ –µ—Å—Ç—å
  container.innerHTML = '';
  
  // –ó–∞–º–µ–Ω—è–µ–º \n –Ω–∞ <br> –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const formattedMessage = message.replace(/\n/g, '<br>');
  
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `
    <div style="display:flex; align-items:flex-start; gap:12px;">
      <div style="font-size:28px; line-height:1;">${icon}</div>
      <div style="flex:1; min-width:0;">
        <div style="font-weight:700; font-size:15px; margin-bottom:4px;">${title}</div>
        <div style="font-size:13px; color:#6b7280; line-height:1.4;">${formattedMessage}</div>
        ${showUndo ? `
          <button onclick="undo(); this.closest('.toast').remove();" 
                  style="margin-top:10px; display:inline-flex; align-items:center; gap:6px; padding:6px 14px; background:linear-gradient(135deg,#8b5cf6,#a855f7); color:white; border:none; border-radius:10px; font-size:12px; font-weight:600; cursor:pointer;">
            ‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ
          </button>
        ` : ''}
      </div>
      <button onclick="this.closest('.toast').remove();" 
              style="background:none; border:none; color:#9ca3af; font-size:18px; cursor:pointer; padding:0; line-height:1;">‚úï</button>
    </div>
  `;
  
  container.appendChild(toast);
  
  // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ
  setTimeout(() => {
    if (toast.parentNode) {
      toast.style.animation = 'toastOut 0.3s ease-in forwards';
      setTimeout(() => toast.remove(), 300);
    }
  }, duration);
}

// ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê URL –ù–û–í–û–ì–û –ï–î–ò–ù–û–ì–û APPS SCRIPT (unified_apps_script.js)
const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxfN2eYhdWamLmTuR6I4unWFpNA4iOD5QxzaKWASZmW6G8El_FWk3vOi1wE7x4AUNasVA/exec';

// ==================== –ü–ê–¢–¢–ï–†–ù–´ –ö–ê–¢–ï–ì–û–†–ò–ô ====================
// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å parse_statement_v2.py

const CATEGORY_PATTERNS = [
  { category: '–ó–¥–æ—Ä–æ–≤—å–µ', patterns: [
    'YAKOB-ART', 'YAKOB', 'TOP GUN', 'TOPGUN', 'CMRT', 'STOMATOLOG', '–°–¢–û–ú–ê–¢–û–õ–û–ì',
    'APTEKA', '–ê–ü–¢–ï–ö–ê', 'ZHIVIKA', 'GORZDRAV', 'RIGLA', 'BEAUTY', 
    '–°–ê–õ–û–ù', '–ö–†–ê–°–û–¢', 'SPA', '–ú–ê–°–°–ê–ñ', '–ö–õ–ò–ù–ò–ö–ê', 'MED', 'DOCTOR',
    'SPBAPT', 'APTECHNOE', 'TSMRT', 'RDK', 'ATRIBEAUTE',
    'OH MY NAILS', 'NAILS', 'MUMINOVA', 'RODIONOV',
    'LOGINOVA', '–õ–û–ì–ò–ù–û–í–ê', '–Æ–õ–ò–Ø –ò–õ–¨–ò–ù–ò–ß–ù–ê', 'K. YULIA', '–¢–†–ï–ù–ï–†', 'TRAINER',
    'MC DEVYATKINO', '–ú–ï–î–ò–¶–ò–ù–°–ö–ò–ô', '–ü–û–õ–ò–ö–õ–ò–ù–ò–ö–ê', '–ê–ù–ê–õ–ò–ó', '–õ–ê–ë–û–†–ê–¢–û–†',
    'INVITRO', 'HELIX', '–ì–ï–ú–û–¢–ï–°–¢', 'KRASIVO', '–ü–ê–†–ò–ö–ú–ê–•–ï–†', 'BARBER',
    '–ú–ê–ù–ò–ö–Æ–†', '–ü–ï–î–ò–ö–Æ–†', '–ö–û–°–ú–ï–¢–û–õ–û–ì', '–°–¢–†–ò–ñ–ö–ê'
  ]},
  { category: '–î–µ—Ç—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã', patterns: [
    'DETSKIY MIR', '–î–ï–¢–°–ö–ò–ô –ú–ò–†', '–î–û–ß–ö–ò-–°–´–ù–û–ß–ö–ò', 'DOCHKI',
    'VOTONYA', 'VOTONIA', '–ö–û–†–ê–ë–õ–ò–ö', 'KORABLIK', '–î–ï–¢–ö–ò',
    'MOTHERCARE', 'CHICCO', '–ò–ì–†–£–®–ö–ò', 'TOYS'
  ]},
  { category: '–ü—Ä–æ–¥—É–∫—Ç—ã', patterns: [
    'MAGNIT', '–ú–ê–ì–ù–ò–¢', 'LENTA', '–õ–ï–ù–¢–ê', 'DIKSI', '–î–ò–ö–°–ò', 'PEREKRESTOK',
    '–ü–ï–†–ï–ö–†–Å–°–¢–û–ö', '–ü–ï–†–ï–ö–†–ï–°–¢–û–ö', 'PYATEROCHKA', '–ü–Ø–¢–Å–†–û–ß–ö–ê', '–ü–Ø–¢–ï–†–û–ß–ö–ê', '5KA',
    'SAMOKAT', '–°–ê–ú–û–ö–ê–¢', 'LAVKA', '–õ–ê–í–ö–ê', 'VKUSVILL', '–í–ö–£–°–í–ò–õ–õ', 
    'SPAR', 'PRISMA', 'ASHAN', '–ê–®–ê–ù', 'OKEY', '–û\'–ö–ï–ô', 'METRO', 
    'SUPERMARKET', '–ü–†–û–î–£–ö–¢–´', '–ì–ò–ü–ï–†–ú–ê–†–ö–ï–¢',
    'MAGAZIN', 'MURINO TRC NEBO', 'NEBO', 'DIXY', 'REAL',
    'OREKHI-FRUKTY', 'KRASNOE&BELOE', 'KRASNOE', 'WINELAB', 'VV_',
    '–§–ï–†–ú–ï–†', '–†–´–ù–û–ö', 'MYASNOV', '–ú–Ø–°–ù–û–í',
    'ULYBKA RADUGI', '–£–õ–´–ë–ö–ê –†–ê–î–£–ì–ò', 'BIKO', '–°–ï–ú–ò–®–ê–ì–û–§–§',
    'TRC NEBO', 'PISKAREVSKAYA', 'MEGA PARNAS', '–ú–ï–ì–ê –ü–ê–†–ù–ê–°',
    'CHEFMARKET', '–®–ï–§ –ú–ê–†–ö–ï–¢'
  ]},
  { category: '–†–µ—Å—Ç–æ—Ä–∞–Ω—ã/–∫–∞—Ñ–µ', patterns: [
    'MR BLACK', 'DO.BRO', '–î–û–ë–†–û', 'COFFEE', '–ö–û–§–ï', 'CHAJHONA', '–ß–ê–ô–•–û–ù–ê',
    'BULOCH', '–ë–£–õ–û–ß', 'BBQ', 'MASE', 'QSR', '–†–ï–°–¢–û–†–ê–ù', '–ö–ê–§–ï', '–ë–£–†–ì–ï–†',
    'KFC', '–ú–ê–ö–î–û–ù–ê–õ–¨–î–°', 'MCDONALD', '–¢–ï–†–ï–ú–û–ö', 'TEREMOK', 'SUBWAY', 
    '–®–û–ö–û–õ–ê–î–ù–ò–¶–ê', 'STARBUCKS', 'BUSHE', '–ë–£–®–ï', '–ü–ò–¶–¶–ê', 'PIZZA', 
    '–°–£–®–ò', 'SUSHI', 'BURGER', '–ë–£–†–ì–ï–† –ö–ò–ù–ì',
    'CHAIKHONA', 'CHAIHONA', 'GRADUSY', 'HOTKITCHENSPB', 'UZHINDOMA',
    'BAR', '–ë–ê–†', 'PIZZAHUB', 'YUMAMART', 'KINOBAR',
    'PEKARNYA', '–ü–ï–ö–ê–†–ù–Ø', 'CHEBUREKMI', '–ß–ï–ë–£–†–ï–ö',
    'TEKSTURA', 'ETYUD', 'GAVSHINSKAYA', 'KAFE', 'CAFE',
    'STOLOVAYA', '–°–¢–û–õ–û–í–ê–Ø', '–§–ê–°–¢–§–£–î', 'FASTFOOD',
    'CHAJKHONA', 'RESTORAN', 'BALKAN', 'V CHASHCHE', 'FUDTRAK',
    'NOVOE DEVYATKINO', 'MISTOLOVO', 'SHAVERMA', '–®–ê–í–ï–†–ú–ê', '–®–ê–®–õ–´–ö',
    'DZHUDOS', '–î–ñ–£–î–û–°', 'HOTKITCHEN', '–ü–ò–¶–¶–ï–†–ò–Ø', 'PIZZERIA',
    'KHLEBNIK', '–•–õ–ï–ë–ù–ò–ö', 'EVRAZIYA', '–ï–í–†–ê–ó–ò–Ø', 'GRADUSI', '–ì–†–ê–î–£–°–´',
    'IZBA', '–ò–ó–ë–ê', 'SBERCHAEVYE', '–ß–ê–ï–í–´–ï'
  ]},
  { category: '–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã', patterns: [
    'WILDBERRIES', '–í–ê–ô–õ–î–ë–ï–†–†–ò–ó', 'WB', 'OZON', '–û–ó–û–ù', 'NESP',
    'YANDEX DOSTAVKA', 'ALIEXPRESS', 'LAMODA', 'MEGAMARKET', 
    '–°–ë–ï–†–ú–ï–ì–ê–ú–ê–†–ö–ï–¢', '–Ø–ù–î–ï–ö–° –ú–ê–†–ö–ï–¢', 'YANDEX MARKET'
  ]},
  { category: '–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã', patterns: [
    'UZHIN DOMA', '–£–ñ–ò–ù –î–û–ú–ê', 'YANDEX EDA', '–Ø–ù–î–ï–ö–° –ï–î–ê', 'YANDEX.EDA',
    'DELIVERY CLUB', '–î–ï–õ–ò–í–ï–†–ò', 'SBERMARKET', '–°–ë–ï–†–ú–ê–†–ö–ï–¢',
    '–Ø–ù–î–ï–ö–° –õ–ê–í–ö–ê',
    'CDEK', '–°–î–≠–ö', 'BOXBERRY', '–ü–û–ß–¢–ê', 'POST', '–î–û–°–¢–ê–í–ö–ê', 'DELIVERY',
    'DPD', 'PICKPOINT', '–ü–£–ù–ö–¢ –í–´–î–ê–ß–ò', '–ü–í–ó'
  ]},
  { category: '–¢–∞–∫—Å–∏', patterns: [
    'YANDEX GO', '–Ø–ù–î–ï–ö–° –ì–û', 'YANDEX.GO', 'TAXI', '–¢–ê–ö–°–ò', 
    'UBER', 'CITYMOBIL', '–°–ò–¢–ò–ú–û–ë–ò–õ', 'MAXIM', '–ú–ê–ö–°–ò–ú',
    'YANDEX*', 'ROGOZHINA'
  ]},
  { category: '–ê–≤—Ç–æ', patterns: [
    'LUKOIL', '–õ–£–ö–û–ô–õ', 'GAZPROM', '–ì–ê–ó–ü–†–û–ú', 'ROSNEFT', '–†–û–°–ù–ï–§–¢–¨', 
    'BENZIN', '–ë–ï–ù–ó–ò–ù', '–ê–ó–°', 'SHELL', 'PARKING', '–ü–ê–†–ö–û–í–ö–ê', 
    'ZSD', '–ó–°–î', 'AVTODOR', '–ê–í–¢–û–î–û–†', '–ê–í–¢–û–ú–û–ô–ö–ê', '–ú–û–ô–ö–ê', 
    '–°–¢–û', '–ê–í–¢–û–°–ï–†–í–ò–°', 'MAXIMUM', '–ú–ê–ö–°–ò–ú–£–ú',
    'AZS ', 'MOYKA', 'TROFIMOV', '11149', '11160',
    '–¢–û–ü–õ–ò–í–û', 'FUEL', '–ó–ê–ü–†–ê–í–ö–ê', 'NEFTMAGISTRAL', '–¢–ù–ö', 'BP ',
    'GPNBONUS', 'GPN BONUS', '–ì–ê–ó–ü–†–û–ú–ù–ï–§–¢–¨',
    'KAD2', '–ö–ê–î2', 'KAD ', 'NOVOE KACHESTVO DOROG', 'NKDOR', '–ü–õ–ê–¢–û–ù',
    '–®–ò–ù–û–ú–û–ù–¢–ê–ñ', '–ê–í–¢–û–ó–ê–ü–ß–ê–°–¢–ò', 'EXIST', 'AUTODOC',
    'M11', '–ú11', 'OSSP_M11', 'SEVERNAYA MAGISTRAL'
  ]},
  { category: '–î–æ–º/–•–æ–∑—Ç–æ–≤–∞—Ä—ã', patterns: [
    'GALAMART', '–ì–ê–õ–ê–ú–ê–†–¢', 'FIX PRICE', '–§–ò–ö–° –ü–†–ê–ô–°', 'FIXPRICE',
    '–î–û–ú–û–í–û–ô', '–•–û–ó–¢–û–í–ê–†–´', '–ü–û–°–£–î–ê', '–ü–û–†–Ø–î–û–ö', '–õ–ï–û–ù–ê–†–î–û',
    'FAMILIA', '–§–ê–ú–ò–õ–ò–Ø', '–ö–†–ê–°–ù–ê–Ø –¶–ï–ù–ê', '–°–í–ï–¢–û–§–û–†'
  ]},
  { category: '–¢–∞–±–∞–∫', patterns: [
    'TABAK', '–¢–ê–ë–ê–ö', 'TABAKO', '–°–ò–ì–ê–†–ï–¢', 'VAPE', 'IQOS', 
    'SMOKE', '–°–ò–ì–ê–†–´', '–¢–ê–ë–ê–ß–ù–ê–Ø'
  ]},
  { category: '–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ', patterns: [
    '–ñ–ö–•', 'GIS_ZKH', 'GIS ZKH', 'GIS-ZKH', '–ö–û–ú–ú–£–ù–ê–õ–¨–ù', '–¢–°–ñ', '–£–ö ',
    '–ò–ù–¢–ï–†–ù–ï–¢', '–†–û–°–¢–ï–õ–ï–ö–û–ú', 'ROSTELEKOM', 'BEELINE', '–ë–ò–õ–ê–ô–ù', 
    'MTS', '–ú–¢–°', 'MEGAFON', '–ú–ï–ì–ê–§–û–ù', 'TELE2', '–¢–ï–õ–ï2',
    'DOM.RU', '–î–û–ú–ê.–†–£', '–≠–¢–ê–ñ–ò',
    'KABINET-ZHITELYA', 'ETAZHI', 'PITER-LEND', 'UK PITER', 'BERI ZARYAD',
    '–≠–õ–ï–ö–¢–†–ò–ß–ï–°–¢–í–û', '–û–¢–û–ü–õ–ï–ù–ò–ï', '–í–û–î–û–°–ù–ê–ë–ñ', '–¢–ö–û', '–ö–ê–ü–†–ï–ú–û–ù–¢',
    'EPR_GIS', '–ï–ò–†–¶', '–ï–†–ö–¶'
  ]},
  { category: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', patterns: [
    '–ö–ò–ù–û', 'CINEMA', '–¢–ï–ê–¢–†', '–ö–û–ù–¶–ï–†–¢', 'STEAM', 'PLAYSTATION',
    '–ú–£–ó–ï–ô', '–ë–û–£–õ–ò–ù–ì', '–ö–í–ï–°–¢', '–ö–ê–†–¢–ò–ù–ì', '–ü–ê–†–ö',
    'OTELLO', 'ARENA', 'TVEL-SPORT', 'TROYA-LYUKS', 'GRACHEV', 'SHTUMF',
    '–ë–ò–õ–ï–¢', 'TICKET', '–ê–¢–¢–†–ê–ö–¶–ò–û–ù', '–†–ê–ó–í–õ–ï–ß',
    'DDX', '–ö–ê–†–û', 'KARO', '–§–û–†–ú–£–õ–ê –ö–ò–ù–û', '–ú–ò–†–ê–ñ', 'MIRAGE',
    'URBANFIT', '–§–ò–¢–ù–ï–°', 'FITNESS', 'GYM ', '–°–ü–û–†–¢–ó–ê–õ', '–¢–†–ï–ù–ê–ñ–ï–†',
    'XXI VEK', 'XXI –í–ï–ö', '–ü–õ–ê–ù–ï–¢–ê –ö–ò–ù–û'
  ]},
  { category: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', patterns: [
    '–û–¢–ï–õ–¨', 'HOTEL', '–ê–í–ò–ê', 'AEROFLOT', '–ê–≠–†–û–§–õ–û–¢', 'S7', 
    '–ü–û–ë–ï–î–ê', 'POBEDA', '–†–ñ–î', 'RZD', 'BOOKING', 'AIRBNB', 
    'OSTROVOK', '–û–°–¢–†–û–í–û–ö', 'TUTU', '–¢–£–¢–£', '–•–û–°–¢–ï–õ', 'HOSTEL',
    '–°–ê–ù–ê–¢–û–†–ò–ô', '–ö–£–†–û–†–¢', 'TRAVEL',
    '–ö–û–ú–§–û–†–¢ –ë–£–ö–ò–ù–ì', 'BRONEVIK', '–ë–†–û–ù–ï–í–ò–ö', 'SUTOCHNO', '–°–£–¢–û–ß–ù–û'
  ]},
  { category: '–ö–Ω–∏–≥–∏', patterns: [
    'BUKVOED', '–ë–£–ö–í–û–ï–î', '–ß–ò–¢–ê–ô-–ì–û–†–û–î', 'CHITAI', '–ö–ù–ò–ì–ê', 'BOOK',
    '–õ–ò–¢–†–ï–°', 'LITRES', '–ë–ò–ë–õ–ò–û–¢–ï–ö–ê', 'LIBRARY', '–õ–ê–ë–ò–†–ò–ù–¢'
  ]},
  { category: '–û–¥–µ–∂–¥–∞', patterns: [
    'ZARA', 'H&M', 'HM ', 'UNIQLO', '–û–î–ï–ñ–î–ê', '–û–ë–£–í–¨', 'ADIDAS', 'NIKE',
    '–°–ü–û–†–¢–ú–ê–°–¢–ï–†', 'SPORTMASTER', 'DECATHLON', '–î–ï–ö–ê–¢–õ–û–ù', 
    'KARI', '–ö–ê–†–ò', 'GLORIA JEANS', 'BEFREE', '–ë–ò–§–†–ò',
    'RESERVED', 'MASSIMO', 'BERSHKA', 'PULL&BEAR', '–û–°–¢–ò–ù', 'OSTIN',
    'GASUITS', 'SOMIASLEEP', '–ë–ï–õ–¨–ï', 'INTIMISSIMI', 'CALZEDONIA',
    'HENDERSON', 'MANGO', '–¢–í–û–ï', '–¢–í–û–Å', 'LC WAIKIKI'
  ]},
  { category: '–ü–æ–¥–ø–∏—Å–∫–∏', patterns: [
    '–ü–û–î–ü–ò–°–ö–ê', 'PLUS', '–ü–õ–Æ–°', 'PRIME', 'VPN', 'NETFLIX', 'SPOTIFY',
    'YOUTUBE', 'KINOPOISK', '–ö–ò–ù–û–ü–û–ò–°–ö', 'IVI', 'OKKO', 'YANDEX PLUS',
    'SBSCR', '–ú–û–ú–ï–ù–¢–ê–õ–¨–ù–´–ï',
    'SUBSCRIBE', 'PREMIUM', '–ú–£–ó–´–ö–ê', 'MUSIC', '–û–ë–õ–ê–ö–û', 'CLOUD',
    'T-BUNDLE', 'BUNDLE', '–°–ï–†–í–ò–°–´ –Ø–ù–î–ï–ö–°–ê', 'YANDEX SERVICES'
  ]},
  { category: '–¶–≤–µ—Ç—ã/–ü–æ–¥–∞—Ä–∫–∏', patterns: [
    'BOUQUET', '–ë–£–ö–ï–¢', '–¶–í–ï–¢–´', 'FLOWERS', '–§–õ–û–†–ò–°–¢', 'FLORIST',
    '–ü–û–î–ê–†–û–ö', 'GIFT', '–°–£–í–ï–ù–ò–†', '–û–¢–ö–†–´–¢–ö–ê'
  ]},
  { category: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', patterns: [
    '–ö–£–†–°', 'COURSE', '–®–ö–û–õ–ê', 'SCHOOL', '–û–ë–£–ß–ï–ù', '–£–†–û–ö',
    '–†–ï–ü–ï–¢–ò–¢–û–†', 'TUTOR', '–£–ù–ò–í–ï–†–°–ò–¢–ï–¢', '–õ–ï–ö–¶–ò–Ø', '–°–ï–ú–ò–ù–ê–†',
    'SKILLBOX', '–ù–ï–¢–û–õ–û–ì–ò–Ø', 'GEEKBRAINS', 'COURSERA', 'UDEMY',
    'DISTANT-COLLEGE', '–û–ù–õ–ê–ô–ù –®–ö–û–õ–ê', '–í–ï–ë–ò–ù–ê–†', '–ú–ê–°–¢–ï–†-–ö–õ–ê–°–°',
    '–î–ï–¢–°–ö–ò–ô –°–ê–î', 'KINDERGARTEN', '–û–ë–†–ê–ó–û–í–ê–ù–ò–ï', 'EDUCATION'
  ]},
];

// ==================== –ü–ê–¢–¢–ï–†–ù–´ –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô ====================

// ==================== –í–Å–î–†–ê (–§–ê–ó–ê 2) ====================
// –ö–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –≤–µ–¥—Ä—É: business / transit / unassigned

const BUCKET_PATTERNS = {
  business: [
    'AVITO', '–ê–í–ò–¢–û',
    'YANDEX BUSINESS', '–Ø–ù–î–ï–ö–° –ë–ò–ó–ù–ï–°',
    'VK –†–ï–ö–õ–ê–ú–ê', 'DOMCLICK', '–î–û–ú–ö–õ–ò–ö', 'YCLIENTS',
    '–ù–ê–õ–û–ì', 'NALOG', '–§–ù–°', '–ì–û–°–£–°–õ–£–ì–ò',
    '–ò–ù–ì–û–°–°–¢–†–ê–•', 'INGOSSTRAKH', '–°–¢–†–ê–•–û–í'
  ],
  transit: [
    'T-BANK', 'TBANK', '–¢-–ë–ê–ù–ö', 'TINKOFF', '–¢–ò–ù–¨–ö–û–§–§',
    'NETMONET', '–ù–ï–¢–ú–û–ù–ï–¢', '–ê–õ–¨–§–ê-–ë–ê–ù–ö', 'ALFA-BANK', 'MAPP_SBERBANK',
    '–ù–ê–õ–ò–ß–ù–´–ï', 'CASH', 'ATM', '–ë–ê–ù–ö–û–ú–ê–¢', '–í–´–î–ê–ß–ê –ù–ê–õ–ò–ß–ù–´–•',
    '–í–û–ó–í–†–ê–¢', 'REFUND', '–ö–≠–®–ë–≠–ö', 'CASHBACK',
    '–ö–û–ú–ò–°–°–ò–Ø', 'COMMISSION', '–û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï –ö–ê–†–¢–´',
    'DOLYAME', '–î–û–õ–Ø–ú–ò', 'PODELI', '–ü–û–î–ï–õ–ò',
    'HALVA', '–•–ê–õ–í–ê', 'SPLIT', '–°–ü–õ–ò–¢', 'BRANCH'
  ],
  unassigned: [
    'LEROY', 'LERUA', '–õ–ï–†–£–ê', '–õ–ï–ú–ê–ù–ê', 'LEMANPRO', 'LEMANA PRO', 'LEMANAPROG',
    'PETROVICH', '–ü–ï–¢–†–û–í–ò–ß', 'AFONYA', '–ê–§–û–ù–Ø', 'ASKONA', '–ê–°–ö–û–ù–ê',
    'IKEA', '–ò–ö–ï–ê', 'HOFF', '–•–û–§–§', 'OBI', '–û–ë–ò', 'CASTORAMA', '–ú–ê–ö–°–ò–î–û–ú',
    'TACHKA', '–¢–ê–ß–ö–ê'
  ]
};

// –ü–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å shouldExclude()
const EXCLUSION_PATTERNS = [...BUCKET_PATTERNS.business, ...BUCKET_PATTERNS.transit, ...BUCKET_PATTERNS.unassigned];

// –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—ë–¥–µ—Ä
const BUCKET_META = {
  unassigned: { name: '–ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ', icon: '‚ùì', color: '#F59E0B', bgColor: '#FFFBEB', borderColor: '#FCD34D' },
  business:   { name: '–ë–∏–∑–Ω–µ—Å',           icon: 'üíº', color: '#8B5CF6', bgColor: '#F5F3FF', borderColor: '#C4B5FD' },
  transit:    { name: '–¢—Ä–∞–Ω–∑–∏—Ç',           icon: 'üîÑ', color: '#6B7280', bgColor: '#F9FAFB', borderColor: '#D1D5DB' },
  family:     { name: '–°–µ–º—å—è',             icon: 'üë®‚Äçüë©‚Äçüëß', color: '#10B981', bgColor: '#ECFDF5', borderColor: '#6EE7B7' }
};

const TRANSFER_PATTERNS = [
  '–ü–ï–†–ï–í–û–î', 'TRANSFER', 'P2P', 'CARD2CARD', '–°–ë–ü', 'SBP', 'C2C',
  'KOPILKA', '–ö–û–ü–ò–õ–ö–ê', 'KARTA-VKLAD', '–ö–ê–†–¢–ê-–í–ö–õ–ê–î',
  'SBERBANK ONL@IN', '–ü–û –î–û–ì–û–í–û–†–£', '–î–û–ì–û–í–û–† –ö–†–ï–î–ò–¢–ê',
  '–ù–û–ú–ï–†–£ –¢–ï–õ–ï–§–û–ù–ê', '"T-–ë–ê–ù–ö"', 'GCUP'
];

const TRAINER_PATTERNS = ['LOGINOVA', '–õ–û–ì–ò–ù–û–í–ê', '–¢–†–ï–ù–ï–†', 'TRAINER', '–Æ–õ–ò–Ø –ò–õ–¨–ò–ù–ò–ß–ù–ê', 'K. YULIA'];
const EXCLUDE_PHONES = ['+79111763164', '79111763164', '89111763164'];
const LARGE_AMOUNT_THRESHOLD = 40000;

// ==================== –ù–û–†–ú–´ 2025 (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –∏–∑ –≤—ã–ø–∏—Å–æ–∫) ====================

const DEFAULT_NORMS = {
  "–†–µ—Å—Ç–æ—Ä–∞–Ω—ã/–∫–∞—Ñ–µ": { "monthly_avg": 64481, "yearly_total": 838264 },
  "–ü—Ä–æ–¥—É–∫—Ç—ã": { "monthly_avg": 53972, "yearly_total": 701645 },
  "–ó–¥–æ—Ä–æ–≤—å–µ": { "monthly_avg": 45307, "yearly_total": 589003 },
  "–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ": { "monthly_avg": 17338, "yearly_total": 225395 },
  "–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è": { "monthly_avg": 13818, "yearly_total": 179645 },
  "–ê–≤—Ç–æ": { "monthly_avg": 10618, "yearly_total": 138045 },
  "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã": { "monthly_avg": 9255, "yearly_total": 120315 },
  "–¢–∞–∫—Å–∏": { "monthly_avg": 7836, "yearly_total": 101875 },
  "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è": { "monthly_avg": 4769, "yearly_total": 62004 },
  "–î–µ—Ç—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã": { "monthly_avg": 3990, "yearly_total": 51872 },
  "–ü–æ–¥–ø–∏—Å–∫–∏": { "monthly_avg": 3787, "yearly_total": 49242 },
  "–¢–∞–±–∞–∫": { "monthly_avg": 3289, "yearly_total": 42759 },
  "–û–¥–µ–∂–¥–∞": { "monthly_avg": 2189, "yearly_total": 28459 },
  "–ö–Ω–∏–≥–∏": { "monthly_avg": 1754, "yearly_total": 22802 },
  "–î–æ–º/–•–æ–∑—Ç–æ–≤–∞—Ä—ã": { "monthly_avg": 1466, "yearly_total": 19065 },
  "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": { "monthly_avg": 1430, "yearly_total": 18600 },
  "–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã": { "monthly_avg": 1352, "yearly_total": 17585 },
  "–¶–≤–µ—Ç—ã/–ü–æ–¥–∞—Ä–∫–∏": { "monthly_avg": 918, "yearly_total": 11940 }
};

// ==================== –ê–í–¢–û-–†–ê–°–ß–Å–¢ –ù–û–†–ú ====================

function calculateNormsFromData(transactions) {
  if (!transactions || transactions.length === 0) return {};
  
  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –º–µ—Å—è—Ü—É
  const catMonths = {};
  transactions.forEach(tx => {
    if (!tx.category || !tx.monthKey) return;
    if (!catMonths[tx.category]) catMonths[tx.category] = {};
    catMonths[tx.category][tx.monthKey] = (catMonths[tx.category][tx.monthKey] || 0) + tx.amount;
  });
  
  // –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–∏–µ
  const norms = {};
  Object.entries(catMonths).forEach(([cat, months]) => {
    const values = Object.values(months);
    const total = values.reduce((a, b) => a + b, 0);
    const monthCount = Object.keys(months).length;
    norms[cat] = {
      monthly_avg: Math.round(total / monthCount),
      yearly_total: Math.round(total / monthCount * 12)
    };
  });
  
  return norms;
}

function updateNorms() {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  const mode = settings.normsMode || 'fixed'; // fixed –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  
  if (mode === 'auto' && budgetData.transactions && budgetData.transactions.length > 0) {
    budgetData.norms = calculateNormsFromData(budgetData.transactions);
  } else {
    budgetData.norms = DEFAULT_NORMS;
  }
}

// ==================== STATE ====================

let budgetData = {
  transactions: [],
  norms: {},
  lastUpdate: null
};

// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã—à–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤)
let userCategoryRules = {};

// –ë–∏–∑–Ω–µ—Å-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∞—Ç–µ–ª—å–µ
const BIZ_EXPENSE_CATS = {
  'rent':        { name: '–ê—Ä–µ–Ω–¥–∞',              icon: 'üè†', color: '#E17055' },
  'supplies':    { name: '–ó–∞–∫—É–ø–∫–∏',             icon: 'üßµ', color: '#FDCB6E' },
  'drycleaning': { name: '–•–∏–º—á–∏—Å—Ç–∫–∞',           icon: 'üëî', color: '#74B9FF' },
  'taxes':       { name: '–ö–æ–º–∏—Å—Å–∏–∏/–ù–∞–ª–æ–≥–∏',     icon: 'üè¶', color: '#A29BFE' },
  'maintenance': { name: '–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è',         icon: 'üîß', color: '#55EFC4' },
  'bonuses':     { name: '–ü—Ä–µ–º–∏–∏/–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤—ã',  icon: 'üéâ', color: '#FF7675' }
};

// –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è ‚Üí –±–∏–∑–Ω–µ—Å-–∫–∞—Ç–µ–≥–æ—Ä–∏—è  { "–ü–û–õ–£–ß–ê–¢–ï–õ–¨": "rent" }
let businessRules = {};

// –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è ‚Üí –≤–µ–¥—Ä–æ { "MERCHANT": "business" | "transit" | "family" }
let bucketRules = {};

let currentMonth = '2026-01';
let currentOwner = 'all';
let pendingTransactions = [];
let pendingExcluded = [];
let charts = {};

// –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏–π (–º–∞–∫—Å–∏–º—É–º 20 —à–∞–≥–æ–≤)
let undoHistory = [];
const MAX_UNDO_STEPS = 20;

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
function saveToHistory(actionName) {
  const state = {
    action: actionName,
    timestamp: new Date().toISOString(),
    transactions: JSON.parse(JSON.stringify(budgetData.transactions)),
    excludedTransactions: JSON.parse(JSON.stringify(budgetData.excludedTransactions || [])),
    userCategoryRules: JSON.parse(JSON.stringify(userCategoryRules)),
    userCategories: JSON.parse(localStorage.getItem('userCategories') || '[]'),
    budgetSettings: JSON.parse(localStorage.getItem('budgetSettings') || '{}')
  };
  
  undoHistory.push(state);
  
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
  if (undoHistory.length > MAX_UNDO_STEPS) {
    undoHistory.shift();
  }
  
  updateUndoButton();
}

// –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
function undo() {
  if (undoHistory.length === 0) {
    showToast({ icon: 'üí°', title: '–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å', message: '–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø—É—Å—Ç–∞.', type: 'info', showUndo: false, duration: 3000 });
    return;
  }
  
  const state = undoHistory.pop();
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  budgetData.transactions = state.transactions;
  if (state.excludedTransactions) budgetData.excludedTransactions = state.excludedTransactions;
  userCategoryRules = state.userCategoryRules;
  localStorage.setItem('userCategories', JSON.stringify(state.userCategories));
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
  if (state.budgetSettings) {
    localStorage.setItem('budgetSettings', JSON.stringify(state.budgetSettings));
    loadSavedSettings();
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  saveData();
  saveUserRules();
  
  updateUI();
  updateUndoButton();
  
  showToast({
    icon: '‚Ü©Ô∏è',
    title: '–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ',
    message: `–û—Ç–º–µ–Ω–µ–Ω–æ: ${state.action}\n–í—Å—ë –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∫ –±—ã–ª–æ.`,
    type: 'undo',
    showUndo: false
  });
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
function updateUndoButton() {
  const btn = document.getElementById('undoBtn');
  const tooltip = document.getElementById('undoTooltip');
  
  if (btn) {
    if (undoHistory.length > 0) {
      btn.classList.remove('opacity-50', 'cursor-not-allowed');
      btn.classList.add('hover:bg-white/30');
      
      const lastAction = undoHistory[undoHistory.length - 1].action;
      if (tooltip) {
        tooltip.innerHTML = `–û—Ç–º–µ–Ω–∏—Ç—å: ${lastAction}<div class="absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-gray-900"></div>`;
      }
    } else {
      btn.classList.add('opacity-50', 'cursor-not-allowed');
      btn.classList.remove('hover:bg-white/30');
      
      if (tooltip) {
        tooltip.innerHTML = `–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã<div class="absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-gray-900"></div>`;
      }
    }
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª –∏–∑ localStorage
function loadUserRules() {
  try {
    const saved = localStorage.getItem('userCategoryRules');
    if (saved) userCategoryRules = JSON.parse(saved);
    const savedBiz = localStorage.getItem('businessRules');
    if (savedBiz) businessRules = JSON.parse(savedBiz);
    const savedBuckets = localStorage.getItem('bucketRules');
    if (savedBuckets) bucketRules = JSON.parse(savedBuckets);
  } catch (e) {
    console.error('Error loading user rules:', e);
    userCategoryRules = {};
    businessRules = {};
    bucketRules = {};
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª
function saveUserRules() {
  localStorage.setItem('userCategoryRules', JSON.stringify(userCategoryRules));
  localStorage.setItem('businessRules', JSON.stringify(businessRules));
  uploadAllDataDebounced();
}

// –î–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –º–µ—Ä—á–∞–Ω—Ç–∞
function setMerchantCategory(merchant, category) {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
  saveToHistory(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${merchant}" ‚Üí ${category}`);
  
  const key = merchant.toUpperCase().trim();
  userCategoryRules[key] = category;
  saveUserRules();
  
  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å —ç—Ç–∏–º –º–µ—Ä—á–∞–Ω—Ç–æ–º
  let changed = 0;
  budgetData.transactions.forEach(tx => {
    const txMerchant = (tx.merchant || '').toUpperCase().trim();
    if (txMerchant === key || txMerchant.includes(key) || key.includes(txMerchant)) {
      if (tx.category !== category) {
        tx.category = category;
        changed++;
      }
    }
  });
  
  saveData();
  updateUI();
  return changed;
}

// –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –º–µ—Ä—á–∞–Ω—Ç–∞
function removeMerchantRule(merchant) {
  const key = merchant.toUpperCase().trim();
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
  saveToHistory(`–£–¥–∞–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è "${merchant}"`);
  
  delete userCategoryRules[key];
  saveUserRules();
}

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞
function getAllCategories() {
  return getUserCategories();
}

// ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================

function showSettingsModal() {
  document.getElementById('settingsModal').classList.remove('hidden');
  document.getElementById('settingsModal').classList.add('flex');
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  loadSettingsUI();
  loadPhotoSettingsUI();
}

function hideSettingsModal() {
  document.getElementById('settingsModal').classList.add('hidden');
  document.getElementById('settingsModal').classList.remove('flex');
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ UI
function loadSettingsUI() {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  
  // –¢–µ–º–∞
  updateThemeButtons(settings.theme || 'light');
  
  // –¶–≤–µ—Ç
  document.getElementById('colorPrimary').value = settings.primaryColor || '#8b5cf6';
  
  // –®—Ä–∏—Ñ—Ç
  document.getElementById('fontSelect').value = settings.font || 'system';
}

// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–º—É
function setTheme(theme) {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  settings.theme = theme;
  saveBudgetSettings(settings);
  
  applyTheme(theme);
  updateThemeButtons(theme);
}

function updateThemeButtons(theme) {
  const lightBtn = document.getElementById('themeLightBtn');
  const darkBtn = document.getElementById('themeDarkBtn');
  
  if (theme === 'dark') {
    darkBtn.classList.add('border-purple-500');
    darkBtn.classList.remove('border-transparent');
    lightBtn.classList.remove('border-purple-500');
    lightBtn.classList.add('border-transparent');
  } else {
    lightBtn.classList.add('border-purple-500');
    lightBtn.classList.remove('border-transparent');
    darkBtn.classList.remove('border-purple-500');
    darkBtn.classList.add('border-transparent');
  }
}

function applyTheme(theme) {
  const root = document.documentElement;
  const body = document.body;
  
  if (theme === 'dark') {
    body.classList.add('dark-theme');
    root.style.setProperty('--bg-main', '#1a1a2e');
    root.style.setProperty('--bg-card', '#16213e');
    root.style.setProperty('--text-main', '#eee');
    root.style.setProperty('--text-secondary', '#aaa');
  } else {
    body.classList.remove('dark-theme');
    root.style.setProperty('--bg-main', '#f3f4f6');
    root.style.setProperty('--bg-card', '#ffffff');
    root.style.setProperty('--text-main', '#1f2937');
    root.style.setProperty('--text-secondary', '#6b7280');
  }
}

// –¶–≤–µ—Ç–æ–≤—ã–µ —Å—Ö–µ–º—ã
const colorSchemes = {
  purple: { primary: '#8b5cf6', secondary: '#d946ef' },
  blue: { primary: '#3b82f6', secondary: '#06b6d4' },
  green: { primary: '#22c55e', secondary: '#10b981' },
  orange: { primary: '#f97316', secondary: '#ef4444' },
  pink: { primary: '#ec4899', secondary: '#f43f5e' },
  teal: { primary: '#14b8a6', secondary: '#06b6d4' },
  indigo: { primary: '#6366f1', secondary: '#8b5cf6' },
  gray: { primary: '#6b7280', secondary: '#475569' }
};

function setColorScheme(scheme) {
  const colors = colorSchemes[scheme];
  if (!colors) return;
  
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  settings.colorScheme = scheme;
  settings.primaryColor = colors.primary;
  settings.secondaryColor = colors.secondary;
  saveBudgetSettings(settings);
  
  applyColorScheme(colors.primary, colors.secondary);
  document.getElementById('colorPrimary').value = colors.primary;
}

function applyCustomColor() {
  const primary = document.getElementById('colorPrimary').value;
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  settings.primaryColor = primary;
  settings.colorScheme = 'custom';
  saveBudgetSettings(settings);
  
  applyColorScheme(primary, primary);
}

function applyColorScheme(primary, secondary) {
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –≥—Ä–∞–¥–∏–µ–Ω—Ç—É —à–∞–ø–∫–∏
  const header = document.getElementById('mainHeader');
  if (header) {
    header.style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
  }
  
  // CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  document.documentElement.style.setProperty('--color-primary', primary);
  document.documentElement.style.setProperty('--color-secondary', secondary);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  document.querySelectorAll('.tab-active').forEach(tab => {
    tab.style.background = `linear-gradient(135deg, ${primary}, ${secondary})`;
  });
}

// –®—Ä–∏—Ñ—Ç—ã
const fontFamilies = {
  'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
  'inter': '"Inter", sans-serif',
  'roboto': '"Roboto", sans-serif',
  'open-sans': '"Open Sans", sans-serif',
  'montserrat': '"Montserrat", sans-serif',
  'nunito': '"Nunito", sans-serif'
};

function setFont(font) {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  settings.font = font;
  saveBudgetSettings(settings);
  
  applyFont(font);
}

function applyFont(font) {
  const family = fontFamilies[font] || fontFamilies['system'];
  document.body.style.fontFamily = family;
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º Google Font –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  if (font !== 'system') {
    loadGoogleFont(font);
  }
}

function loadGoogleFont(font) {
  const fontName = font.replace('-', '+');
  const link = document.createElement('link');
  link.href = `https://fonts.googleapis.com/css2?family=${fontName.charAt(0).toUpperCase() + fontName.slice(1).replace('+', ' ')}:wght@400;500;600;700&display=swap`;
  link.rel = 'stylesheet';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–∞–∫–æ–π —à—Ä–∏—Ñ—Ç –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  if (!document.querySelector(`link[href*="${fontName}"]`)) {
    document.head.appendChild(link);
  }
}

// –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞
function setFontSize(size) {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  settings.fontSize = size;
  saveBudgetSettings(settings);
  
  applyFontSize(size);
}

function applyFontSize(size) {
  const root = document.documentElement;
  switch (size) {
    case 'small':
      root.style.fontSize = '14px';
      break;
    case 'large':
      root.style.fontSize = '18px';
      break;
    default:
      root.style.fontSize = '16px';
  }
}

// –°–±—Ä–æ—Å –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
function resetAllSettings() {
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è?')) return;
  
  // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Ñ–æ—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ (–±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é)
  const header = document.getElementById('mainHeader');
  if (header) {
    const photoLayer = header.querySelector('.header-photo-layer');
    if (photoLayer) photoLayer.remove();
  }
  
  const bgLayer = document.getElementById('bgPhotoLayer');
  if (bgLayer) bgLayer.remove();
  
  document.getElementById('headerPhotoPreview')?.classList.add('hidden');
  document.getElementById('bgPhotoPreview')?.classList.add('hidden');
  
  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  const defaultSettings = {
    theme: 'light',
    primaryColor: '#8b5cf6',
    secondaryColor: '#d946ef',
    colorScheme: 'purple',
    font: 'system',
    fontSize: 'medium',
    blurAmount: 10
  };
  saveBudgetSettings(defaultSettings);
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç—ã –≤–∏–∑—É–∞–ª—å–Ω–æ
  applyTheme('light');
  applyColorScheme('#8b5cf6', '#d946ef');
  applyFont('system');
  applyFontSize('medium');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º UI –Ω–∞—Å—Ç—Ä–æ–µ–∫
  loadSettingsUI();
  loadPhotoSettingsUI();
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä —Ä–∞–∑–º—ã—Ç–∏—è
  const slider = document.getElementById('blurSlider');
  const valueDisplay = document.getElementById('blurValue');
  if (slider) slider.value = 10;
  if (valueDisplay) valueDisplay.textContent = '10';
}

// ==================== –§–û–¢–û –ù–ê –§–û–ù ====================

// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ –≤ —à–∞–ø–∫—É
function setHeaderPhoto(files) {
  if (!files || !files[0]) return;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
  saveToHistory('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ—Ç–æ –≤ —à–∞–ø–∫—É');
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const base64 = e.target.result;
    
    const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
    settings.headerPhoto = base64;
    saveBudgetSettings(settings);
    
    applyHeaderPhoto(base64, settings.blurAmount || 10);
    updatePhotoPreview('header', base64);
  };
  reader.readAsDataURL(files[0]);
}

// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ –Ω–∞ —Ñ–æ–Ω
function setBackgroundPhoto(files) {
  if (!files || !files[0]) return;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
  saveToHistory('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ—Ç–æ –Ω–∞ —Ñ–æ–Ω');
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const base64 = e.target.result;
    
    const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
    settings.bgPhoto = base64;
    saveBudgetSettings(settings);
    
    applyBackgroundPhoto(base64, settings.blurAmount || 10);
    updatePhotoPreview('bg', base64);
  };
  reader.readAsDataURL(files[0]);
}

// –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ –∏–∑ —à–∞–ø–∫–∏
function removeHeaderPhoto() {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  
  // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  if (!settings.headerPhoto) return;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
  saveToHistory('–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –∏–∑ —à–∞–ø–∫–∏');
  
  delete settings.headerPhoto;
  saveBudgetSettings(settings);
  
  const header = document.getElementById('mainHeader');
  if (header) {
    // –£–¥–∞–ª—è–µ–º —Å–ª–æ–π —Å —Ñ–æ—Ç–æ
    const photoLayer = header.querySelector('.header-photo-layer');
    if (photoLayer) photoLayer.remove();
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç
    const primary = settings.primaryColor || '#8b5cf6';
    const secondary = settings.secondaryColor || '#d946ef';
    header.style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
  }
  
  document.getElementById('headerPhotoPreview')?.classList.add('hidden');
}

// –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ —Å —Ñ–æ–Ω–∞
function removeBackgroundPhoto() {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  
  // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  if (!settings.bgPhoto) return;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
  saveToHistory('–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ —Å —Ñ–æ–Ω–∞');
  
  delete settings.bgPhoto;
  saveBudgetSettings(settings);
  
  // –£–¥–∞–ª—è–µ–º —Ñ–æ–Ω–æ–≤—ã–π —Å–ª–æ–π
  const bgLayer = document.getElementById('bgPhotoLayer');
  if (bgLayer) bgLayer.remove();
  
  document.getElementById('bgPhotoPreview')?.classList.add('hidden');
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å–∏–ª—É —Ä–∞–∑–º—ã—Ç–∏—è
function updateBlur(value) {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  settings.blurAmount = parseInt(value);
  saveBudgetSettings(settings);
  
  document.getElementById('blurValue').textContent = value;
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ —à–∞–ø–∫–µ
  if (settings.headerPhoto) {
    applyHeaderPhoto(settings.headerPhoto, value);
  }
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ —Ñ–æ–Ω—É
  if (settings.bgPhoto) {
    applyBackgroundPhoto(settings.bgPhoto, value);
  }
}

// –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ –∫ —à–∞–ø–∫–µ
function applyHeaderPhoto(base64, blur) {
  const header = document.getElementById('mainHeader');
  if (!header) return;
  
  // –°–æ–∑–¥–∞—ë–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Å–µ–≤–¥–æ-—ç–ª–µ–º–µ–Ω—Ç —á–µ—Ä–µ–∑ —Å—Ç–∏–ª—å
  header.style.position = 'relative';
  header.style.overflow = 'hidden';
  
  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª–æ–π –µ—Å–ª–∏ –µ—Å—Ç—å
  let photoLayer = header.querySelector('.header-photo-layer');
  if (!photoLayer) {
    photoLayer = document.createElement('div');
    photoLayer.className = 'header-photo-layer';
    photoLayer.style.cssText = `
      position: absolute;
      top: -20px; left: -20px; right: -20px; bottom: -20px;
      background-size: cover;
      background-position: center;
      z-index: 0;
    `;
    header.insertBefore(photoLayer, header.firstChild);
    
    // –î–µ–ª–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–≤–µ—Ä—Ö
    Array.from(header.children).forEach(child => {
      if (child !== photoLayer) {
        child.style.position = 'relative';
        child.style.zIndex = '1';
      }
    });
  }
  
  photoLayer.style.backgroundImage = `url(${base64})`;
  photoLayer.style.filter = `blur(${blur}px) brightness(0.7)`;
}

// –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ –∫ —Ñ–æ–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function applyBackgroundPhoto(base64, blur) {
  let bgLayer = document.getElementById('bgPhotoLayer');
  
  if (!bgLayer) {
    bgLayer = document.createElement('div');
    bgLayer.id = 'bgPhotoLayer';
    bgLayer.style.cssText = `
      position: fixed;
      top: -30px; left: -30px; right: -30px; bottom: -30px;
      background-size: cover;
      background-position: center;
      z-index: -1;
    `;
    document.body.insertBefore(bgLayer, document.body.firstChild);
  }
  
  bgLayer.style.backgroundImage = `url(${base64})`;
  bgLayer.style.filter = `blur(${blur}px) brightness(0.8)`;
}

// –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é
function updatePhotoPreview(type, base64) {
  if (type === 'header') {
    const preview = document.getElementById('headerPhotoPreview');
    const img = document.getElementById('headerPhotoImg');
    if (preview && img) {
      img.src = base64;
      preview.classList.remove('hidden');
    }
  } else {
    const preview = document.getElementById('bgPhotoPreview');
    const img = document.getElementById('bgPhotoImg');
    if (preview && img) {
      img.src = base64;
      preview.classList.remove('hidden');
    }
  }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ç–æ –≤ UI
function loadPhotoSettingsUI() {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  
  // –°–ª–∞–π–¥–µ—Ä —Ä–∞–∑–º—ã—Ç–∏—è
  const slider = document.getElementById('blurSlider');
  const valueDisplay = document.getElementById('blurValue');
  if (slider && valueDisplay) {
    slider.value = settings.blurAmount || 10;
    valueDisplay.textContent = settings.blurAmount || 10;
  }
  
  // –ü—Ä–µ–≤—å—é —à–∞–ø–∫–∏
  const headerPreview = document.getElementById('headerPhotoPreview');
  if (settings.headerPhoto) {
    updatePhotoPreview('header', settings.headerPhoto);
  } else if (headerPreview) {
    headerPreview.classList.add('hidden');
  }
  
  // –ü—Ä–µ–≤—å—é —Ñ–æ–Ω–∞
  const bgPreview = document.getElementById('bgPhotoPreview');
  if (settings.bgPhoto) {
    updatePhotoPreview('bg', settings.bgPhoto);
  } else if (bgPreview) {
    bgPreview.classList.add('hidden');
  }
}

function loadSavedSettings() {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
  applyTheme(settings.theme || 'light');
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞
  if (settings.primaryColor) {
    applyColorScheme(settings.primaryColor, settings.secondaryColor || settings.primaryColor);
  }
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º —à—Ä–∏—Ñ—Ç
  if (settings.font) {
    applyFont(settings.font);
  }
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä
  if (settings.fontSize) {
    applyFontSize(settings.fontSize);
  }
  
  // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ
  const header = document.getElementById('mainHeader');
  if (header) {
    const photoLayer = header.querySelector('.header-photo-layer');
    if (photoLayer) photoLayer.remove();
  }
  const bgLayer = document.getElementById('bgPhotoLayer');
  if (bgLayer) bgLayer.remove();
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ç–æ —à–∞–ø–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
  if (settings.headerPhoto) {
    applyHeaderPhoto(settings.headerPhoto, settings.blurAmount || 10);
  } else {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç
    if (header) {
      const primary = settings.primaryColor || '#8b5cf6';
      const secondary = settings.secondaryColor || '#d946ef';
      header.style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
    }
  }
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ç–æ —Ñ–æ–Ω–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
  if (settings.bgPhoto) {
    applyBackgroundPhoto(settings.bgPhoto, settings.blurAmount || 10);
  }
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –Ω–æ—Ä–º
  loadNormsUI(settings.normsMode || 'fixed');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  setTimeout(() => {
    const activeTab = document.querySelector('.tab-active');
    if (activeTab && settings.primaryColor) {
      activeTab.style.background = `linear-gradient(135deg, ${settings.primaryColor}, ${settings.secondaryColor || settings.primaryColor})`;
    }
  }, 100);
}

function setNormsMode(mode) {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  settings.normsMode = mode;
  saveBudgetSettings(settings);
  
  updateNorms();
  loadNormsUI(mode);
  
  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–∫–ª–∞–¥–∫—É
  const activeTab = document.querySelector('.tab-btn.tab-active')?.dataset.tab || 'overview';
  renderTab(activeTab);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–ø–∫—É
  const norm = Object.values(budgetData.norms || {}).reduce((sum, n) => sum + (n.monthly_avg || 0), 0);
  document.getElementById('monthNorm').textContent = formatMoney(norm);
}

function loadNormsUI(mode) {
  const fixedBtn = document.getElementById('normsFixedBtn');
  const autoBtn = document.getElementById('normsAutoBtn');
  const hint = document.getElementById('normsHint');
  
  if (!fixedBtn || !autoBtn) return;
  
  if (mode === 'auto') {
    autoBtn.classList.add('border-purple-500', 'bg-purple-50', 'text-purple-700');
    autoBtn.classList.remove('border-transparent', 'bg-gray-200', 'text-gray-600');
    fixedBtn.classList.remove('border-purple-500', 'bg-purple-50', 'text-purple-700');
    fixedBtn.classList.add('border-transparent', 'bg-gray-200', 'text-gray-600');
    const monthCount = new Set(budgetData.transactions?.map(tx => tx.monthKey).filter(Boolean)).size;
    if (hint) hint.textContent = `–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –∏–∑ ${monthCount} –º–µ—Å. –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö`;
  } else {
    fixedBtn.classList.add('border-purple-500', 'bg-purple-50', 'text-purple-700');
    fixedBtn.classList.remove('border-transparent', 'bg-gray-200', 'text-gray-600');
    autoBtn.classList.remove('border-purple-500', 'bg-purple-50', 'text-purple-700');
    autoBtn.classList.add('border-transparent', 'bg-gray-200', 'text-gray-600');
    if (hint) hint.textContent = '–ù–æ—Ä–º—ã –∑–∞–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é (DEFAULT_NORMS)';
  }
}

function importData(files) {
  if (!files.length) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      
      if (data.transactions) {
        const confirmed = confirm(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${data.transactions.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?\n–≠—Ç–æ –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.`);
        if (!confirmed) return;
        
        budgetData.transactions = data.transactions;
        if (data.excludedTransactions) {
          budgetData.excludedTransactions = data.excludedTransactions;
        }
        if (data.userRules) {
          Object.assign(userCategoryRules, data.userRules);
          saveUserRules();
        }
        if (data.norms) {
          budgetData.norms = data.norms;
        }
        
        updateNorms();
        saveData();
        updateUI();
        hideSettingsModal();
        alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
      }
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message);
    }
  };
  reader.readAsText(files[0]);
}

function clearAllRules() {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π?')) return;
  
  Object.keys(userCategoryRules).forEach(key => delete userCategoryRules[key]);
  saveUserRules();
  updateRulesList();
  showToast({ icon: 'üóëÔ∏è', title: '–ü—Ä–∞–≤–∏–ª–∞ —É–¥–∞–ª–µ–Ω—ã', message: '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å–±—Ä–æ—à–µ–Ω—ã.', type: 'delete', showUndo: false });
}

// ==================== –£–¢–ò–õ–ò–¢–´ ====================

function formatMoney(num) {
  if (!num || isNaN(num)) return '0‚ÇΩ';
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M‚ÇΩ';
  if (num >= 1000) return Math.round(num / 1000) + 'K‚ÇΩ';
  return Math.round(num).toLocaleString('ru-RU') + '‚ÇΩ';
}

function getMonthKey(dateStr) {
  if (!dateStr) return null;
  const parts = dateStr.split('.');
  if (parts.length >= 3) {
    let year = parseInt(parts[2]);
    if (year < 100) year += 2000;
    return year + '-' + parts[1].padStart(2, '0');
  }
  return null;
}

function getMonthName(monthKey) {
  const names = {
    '01': '–Ø–Ω–≤–∞—Ä—å', '02': '–§–µ–≤—Ä–∞–ª—å', '03': '–ú–∞—Ä—Ç', '04': '–ê–ø—Ä–µ–ª—å',
    '05': '–ú–∞–π', '06': '–ò—é–Ω—å', '07': '–ò—é–ª—å', '08': '–ê–≤–≥—É—Å—Ç',
    '09': '–°–µ–Ω—Ç—è–±—Ä—å', '10': '–û–∫—Ç—è–±—Ä—å', '11': '–ù–æ—è–±—Ä—å', '12': '–î–µ–∫–∞–±—Ä—å'
  };
  if (!monthKey) return '';
  const [year, month] = monthKey.split('-');
  return (names[month] || month) + ' ' + year;
}

// ==================== –ö–ê–¢–ï–ì–û–†–ò–ó–ê–¶–ò–Ø ====================

function categorize(desc, merchant = null) {
  if (!desc && !merchant) return '–ü—Ä–æ—á–µ–µ';
  
  // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ (–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
  const checkText = (merchant || desc || '').toUpperCase().trim();
  for (const [rule, category] of Object.entries(userCategoryRules)) {
    if (checkText.includes(rule) || rule.includes(checkText)) {
      return category;
    }
  }
  
  // 2. –ó–∞—Ç–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
  const upper = (desc || '').toUpperCase();
  for (const cat of CATEGORY_PATTERNS) {
    for (const pattern of cat.patterns) {
      if (upper.includes(pattern.toUpperCase())) {
        return cat.category;
      }
    }
  }
  return '–ü—Ä–æ—á–µ–µ';
}

function isTrainer(desc) {
  const upper = (desc || '').toUpperCase();
  return TRAINER_PATTERNS.some(p => upper.includes(p.toUpperCase()));
}

function isTransfer(desc) {
  const upper = (desc || '').toUpperCase();
  return TRANSFER_PATTERNS.some(p => upper.includes(p.toUpperCase()));
}

function shouldExclude(desc, amount) {
  const upper = (desc || '').toUpperCase();
  
  // –ü–µ—Ä–µ–≤–æ–¥—ã ‚Äî –∏—Å–∫–ª—é—á–∞–µ–º, –∫—Ä–æ–º–µ —Ç—Ä–µ–Ω–µ—Ä–∞
  if (isTransfer(desc)) {
    if (isTrainer(desc)) return { exclude: false };
    return { exclude: true, reason: 'transfer', bucket: 'transit' };
  }
  
  // –ö—Ä—É–ø–Ω—ã–µ —Ç—Ä–∞—Ç—ã ‚Üí –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ (–ö–∏—Ä–∏–ª–ª —Ä–µ—à–∞–µ—Ç)
  if (amount > LARGE_AMOUNT_THRESHOLD) {
    return { exclude: true, reason: 'large_amount', bucket: 'unassigned' };
  }
  
  // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ–¥—Ä–æ
  for (const pattern of EXCLUSION_PATTERNS) {
    if (upper.includes(pattern.toUpperCase())) {
      const bucket = getBucketForPattern(pattern);
      return { exclude: true, reason: 'pattern', bucket };
    }
  }
  
  // –¢–µ–ª–µ—Ñ–æ–Ω—ã
  for (const phone of EXCLUDE_PHONES) {
    if (desc && desc.includes(phone)) {
      return { exclude: true, reason: 'phone', bucket: 'transit' };
    }
  }
  
  return { exclude: false };
}

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ–¥—Ä–æ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É
function getBucketForPattern(pattern) {
  const p = pattern.toUpperCase();
  for (const [bucket, patterns] of Object.entries(BUCKET_PATTERNS)) {
    if (patterns.some(bp => bp.toUpperCase() === p)) return bucket;
  }
  return 'unassigned';
}

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ–¥—Ä–æ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Å —É—á—ë—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª)
function getBucketForTx(tx) {
  const merchant = (tx.merchant || tx.description || '').toUpperCase().trim();
  
  // 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤–µ–¥—Ä–∞ (–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
  if (bucketRules[merchant]) return bucketRules[merchant];
  
  // 2. –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å bucket ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º
  if (tx.bucket && tx.bucket !== 'unassigned') return tx.bucket;
  
  // 3. –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ (tagAsBusiness)
  if (businessRules[merchant]) return 'business';
  
  // 4. –ü–æ –ø—Ä–∏—á–∏–Ω–µ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º
  const reason = tx.reason || 'pattern';
  if (reason === 'transfer' || reason === 'phone') return 'transit';
  
  const desc = (tx.description || '').toUpperCase();
  for (const pattern of EXCLUSION_PATTERNS) {
    if (desc.includes(pattern.toUpperCase())) {
      return getBucketForPattern(pattern);
    }
  }
  
  if (reason === 'large_amount') return 'unassigned';
  return 'unassigned';
}

// –†–µ—Ç—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –≤–µ–¥—Ä–∞ –≤—Å–µ–º excluded —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
function assignBucketsToAll() {
  if (!budgetData.excludedTransactions) return;
  budgetData.excludedTransactions.forEach(tx => {
    tx.bucket = getBucketForTx(tx);
  });
}

function extractMerchant(desc) {
  if (!desc) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  let clean = desc.replace(/^(–ò–ü|–û–û–û|–ê–û|–ü–ê–û)\s+/i, '')
                  .replace(/\s+(RUS|RU|RUSSIA|MOSKVA|MOSCOW|SPB)\.?\s*$/i, '')
                  .replace(/\s+\d{5,}.*$/, '')
                  .replace(/\.\s*–û–ø–µ—Ä–∞—Ü–∏—è –ø–æ.*$/i, '');
  return clean.substring(0, 40).trim() || desc.substring(0, 30);
}

// ==================== –ü–ê–†–°–ò–ù–ì PDF ====================

async function parsePDF(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let text = '';
  
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(item => item.str).join(' ') + '\n';
  }
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤—ã–ø–∏—Å–∫–∏
  if (text.includes('–∫—Ä–µ–¥–∏—Ç–Ω–æ–π –∫–∞—Ä—Ç—ã') || text.includes('–ö–†–ï–î–ò–¢–ù–û–ô –ö–ê–†–¢–´')) {
    return parseSberCreditText(text, file.name);
  }
  return parseSberText(text, file.name);
}

// –ü–∞—Ä—Å–µ—Ä –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –≤—ã–ø–∏—Å–∫–∏ –°–±–µ—Ä–±–∞–Ω–∫–∞
function parseSberCreditText(text, filename) {
  const transactions = [];
  const excluded = [];
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
  let owner = 'Unknown';
  if (text.toUpperCase().includes('–°–ö–ê–ß–ö–û–í–ê –ê–õ–Å–ù–ê') || text.toUpperCase().includes('–°–ö–ê–ß–ö–û–í–ê –ê–õ–ï–ù–ê')) {
    owner = '–ê–ª—ë–Ω–∞';
  } else if (text.toUpperCase().includes('–°–ö–ê–ß–ö–û–í –ö–ò–†–ò–õ–õ')) {
    owner = '–ö–∏—Ä–∏–ª–ª';
  }
  
  // –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –≤—ã–ø–∏—Å–∫–∏: DD.MM.YYYY HH:MM –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å—É–º–º–∞ –æ—Å—Ç–∞—Ç–æ–∫
  // –§–æ—Ä–º–∞—Ç: "30.01.2026 20:39 –†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –∫–∞—Ñ–µ 4 130,00 188 048,88"
  // –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞: "30.01.2026 494139 Murino CHAJKHONA.. –û–ø–µ—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ä—Ç–µ ****0392"
  
  const txPattern = /(\d{2}\.\d{2}\.\d{4})\s+(\d{2}:\d{2})\s+([–ê-–Ø–∞-—è—ë–ÅA-Za-z,\s]+?)\s+([\+\-]?[\d\s]+,\d{2})\s+([\d\s]+,\d{2})\s+\d{2}\.\d{2}\.\d{4}\s+\d+\s+(.+?)(?=\d{2}\.\d{2}\.\d{4}\s+\d{2}:\d{2}|–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ|–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è|–ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫|$)/gs;
  
  let match;
  while ((match = txPattern.exec(text)) !== null) {
    const date = match[1];
    const bankCategory = match[3].trim();
    const amountStr = match[4].replace(/\s/g, '').replace(',', '.');
    const description = match[6].replace(/\s+/g, ' ').trim();
    
    const isIncome = amountStr.includes('+');
    const amount = Math.abs(parseFloat(amountStr.replace('+', '').replace('-', '')));
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    if (isIncome || amount <= 0) continue;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    const exclusion = shouldExclude(description, amount);
    if (exclusion.exclude) {
      excluded.push({
        date,
        description: description.substring(0, 100),
        merchant: extractMerchant(description),
        amount,
        reason: exclusion.reason,
        bucket: exclusion.bucket || 'unassigned',
        monthKey: getMonthKey(date),
        owner,
        source: filename + ' (–∫—Ä–µ–¥–∏—Ç–Ω–∞—è)'
      });
      continue;
    }
    
    const category = categorize(description);
    const monthKey = getMonthKey(date);
    
    transactions.push({
      date,
      description: description.substring(0, 100),
      merchant: extractMerchant(description),
      amount,
      category,
      monthKey,
      owner,
      source: filename + ' (–∫—Ä–µ–¥–∏—Ç–Ω–∞—è)'
    });
  }
  
  // –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π
  if (transactions.length === 0) {
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω - –ø–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    const lines = text.split(/(?=\d{2}\.\d{2}\.\d{4}\s+\d{2}:\d{2})/);
    
    for (const block of lines) {
      const headerMatch = block.match(/^(\d{2}\.\d{2}\.\d{4})\s+(\d{2}:\d{2})\s+(.+?)\s+([\d\s]+,\d{2})\s+([\d\s]+,\d{2})/);
      if (!headerMatch) continue;
      
      const date = headerMatch[1];
      const amountStr = headerMatch[4].replace(/\s/g, '').replace(',', '.');
      const amount = Math.abs(parseFloat(amountStr));
      
      // –ò—â–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –≤–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ
      const descMatch = block.match(/\d{2}\.\d{2}\.\d{4}\s+\d+\s+(.+?)(?:–û–ø–µ—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ä—Ç–µ|$)/s);
      const description = descMatch ? descMatch[1].replace(/\s+/g, ' ').trim() : headerMatch[3];
      
      if (amount <= 0) continue;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è
      const exclusion = shouldExclude(description, amount);
      if (exclusion.exclude) {
        excluded.push({
          date,
          description: description.substring(0, 100),
          merchant: extractMerchant(description),
          amount,
          reason: exclusion.reason,
          bucket: exclusion.bucket || 'unassigned',
          monthKey: getMonthKey(date),
          owner,
          source: filename + ' (–∫—Ä–µ–¥–∏—Ç–Ω–∞—è)'
        });
        continue;
      }
      
      const category = categorize(description);
      const monthKey = getMonthKey(date);
      
      transactions.push({
        date,
        description: description.substring(0, 100),
        merchant: extractMerchant(description),
        amount,
        category,
        monthKey,
        owner,
        source: filename + ' (–∫—Ä–µ–¥–∏—Ç–Ω–∞—è)'
      });
    }
  }
  
  console.log(`–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –≤—ã–ø–∏—Å–∫–∞: –Ω–∞–π–¥–µ–Ω–æ ${transactions.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, ${excluded.length} –∏—Å–∫–ª—é—á–µ–Ω–æ`);
  return { transactions, excluded };
}

function parseSberText(text, filename) {
  const transactions = [];
  const excluded = [];
  const lines = text.split('\n');
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
  let owner = 'Unknown';
  if (text.toUpperCase().includes('–°–ö–ê–ß–ö–û–í–ê –ê–õ–Å–ù–ê') || text.toUpperCase().includes('–°–ö–ê–ß–ö–û–í–ê –ê–õ–ï–ù–ê')) {
    owner = '–ê–ª—ë–Ω–∞';
  } else if (text.toUpperCase().includes('–°–ö–ê–ß–ö–û–í –ö–ò–†–ò–õ–õ')) {
    owner = '–ö–∏—Ä–∏–ª–ª';
  }
  
  // –ü–∞—Ç—Ç–µ—Ä–Ω: DD.MM.YYYY HH:MM CODE CATEGORY AMOUNT BALANCE
  const txPattern = /(\d{2}\.\d{2}\.\d{4})\s+(\d{2}:\d{2})\s+(\d+)\s+(.+?)\s+([\+\-]?[\d\s]+[,\.]\d{2})\s+([\d\s]+[,\.]\d{2})/g;
  
  let match;
  while ((match = txPattern.exec(text)) !== null) {
    const date = match[1];
    const amountStr = match[5].replace(/\s/g, '').replace(',', '.');
    const isIncome = amountStr.includes('+');
    const amount = Math.abs(parseFloat(amountStr.replace('+', '').replace('-', '')));
    
    if (isIncome || amount <= 0) continue;
    
    // –ò—â–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–ª–µ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
    const afterMatch = text.substring(match.index + match[0].length, match.index + match[0].length + 500);
    const descMatch = afterMatch.match(/\d{2}\.\d{2}\.\d{4}\s+(.+?)(?=\d{2}\.\d{2}\.\d{4}|\n\n|$)/s);
    const description = descMatch ? descMatch[1].replace(/\s+/g, ' ').trim() : match[4];
    
    const exclusion = shouldExclude(description, amount);
    if (exclusion.exclude) {
      excluded.push({
        date,
        description: description.substring(0, 100),
        merchant: extractMerchant(description),
        amount,
        reason: exclusion.reason,
        bucket: exclusion.bucket || 'unassigned',
        monthKey: getMonthKey(date),
        owner,
        source: filename
      });
      continue;
    }
    
    const category = categorize(description);
    const monthKey = getMonthKey(date);
    
    transactions.push({
      date,
      description: description.substring(0, 100),
      merchant: extractMerchant(description),
      amount,
      category,
      monthKey,
      owner,
      source: filename
    });
  }
  
  return { transactions, excluded };
}

// ==================== GOOGLE SHEETS ====================

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç—ã –∫ —Ñ–æ—Ä–º–∞—Ç—É YYYY-MM-DD
function normalizeDate(dateStr) {
  if (!dateStr) return '';
  const str = String(dateStr).trim();
  
  // ISO —Ñ–æ—Ä–º–∞—Ç: 2025-06-28T21:00:00.000Z –∏–ª–∏ 2025-01-31T22:35:46.503Z
  // –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –õ–û–ö–ê–õ–¨–ù–û–ï –≤—Ä–µ–º—è (getFullYear/getMonth/getDate),
  // –∞ –ù–ï UTC (toISOString), —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–¥–≤–∏–≥–∞ –¥–Ω—è –∏–∑-–∑–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞.
  // Google Sheets —Ö—Ä–∞–Ω–∏—Ç –¥–∞—Ç—É –≤ TZ —Ç–∞–±–ª–∏—Ü—ã, –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç UTC ISO —Å—Ç—Ä–æ–∫—É,
  // —á—Ç–æ –º–æ–∂–µ—Ç —Å–¥–≤–∏–Ω—É—Ç—å –¥–µ–Ω—å –Ω–∞–∑–∞–¥ (–Ω–∞–ø—Ä. –ø–æ–ª–Ω–æ—á—å –ú–æ—Å–∫–≤—ã = 21:00 UTC –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è).
  if (str.includes('T')) {
    const d = new Date(str);
    if (!isNaN(d)) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
  }
  
  // –§–æ—Ä–º–∞—Ç DD.MM.YYYY
  if (str.includes('.')) {
    const parts = str.split('.');
    if (parts.length >= 3) {
      let year = parts[2].split(' ')[0]; // –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è –µ—Å–ª–∏ –µ—Å—Ç—å
      if (year.length === 2) year = '20' + year;
      return `${year}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
    }
  }
  
  // –£–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
  if (str.match(/^\d{4}-\d{2}-\d{2}/)) {
    return str.split('T')[0];
  }
  
  return str;
}

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è monthKey –∫ —Ñ–æ—Ä–º–∞—Ç—É YYYY-MM (–≤—Å–µ–≥–¥–∞ 2 —Ü–∏—Ñ—Ä—ã –º–µ—Å—è—Ü–∞)
function normalizeMonthKey(mk) {
  if (!mk) return '';
  const str = String(mk).trim();
  const parts = str.split('-');
  if (parts.length === 2) {
    const year = parts[0].length === 2 ? '20' + parts[0] : parts[0];
    const month = parts[1].padStart(2, '0');
    return `${year}-${month}`;
  }
  return str;
}

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª—é—á–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
function getTxKey(tx) {
  const date = normalizeDate(tx.date);
  const amount = Math.round(parseFloat(tx.amount) || 0);
  const desc = String(tx.description || '').substring(0, 25).trim().toUpperCase();
  return `${date}|${amount}|${desc}`;
}

// –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–µ–π –∏–∑ –º–∞—Å—Å–∏–≤–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
function deduplicateTransactions(transactions) {
  const seen = new Map();
  const result = [];
  
  for (const tx of transactions) {
    const key = getTxKey(tx);
    if (!seen.has(key)) {
      seen.set(key, true);
      result.push(tx);
    }
  }
  
  return result;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ JSONP (–æ–±—Ö–æ–¥ CORS)
// type: 'transactions' | 'excluded' | 'rules' | 'settings'
function fetchFromSheets(type = 'transactions') {
  return new Promise((resolve, reject) => {
    const callbackName = 'sheetsCallback_' + type + '_' + Date.now();
    const script = document.createElement('script');
    
    const cleanup = () => {
      delete window[callbackName];
      if (script.parentNode) script.remove();
    };
    
    const timeout = setTimeout(() => {
      cleanup();
      reject(new Error('Timeout fetching ' + type));
    }, 60000);
    
    window[callbackName] = (data) => {
      clearTimeout(timeout);
      cleanup();
      resolve(data);
    };
    
    script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&type=' + type;
    script.onerror = () => {
      clearTimeout(timeout);
      cleanup();
      reject(new Error('Script load error for ' + type));
    };
    document.body.appendChild(script);
  });
}

async function syncWithSheets() {
  const btn = document.querySelector('button[onclick="syncWithSheets()"]');
  if (btn) { btn.textContent = '‚è≥'; btn.disabled = true; }
  
  showToast({ icon: 'üîÑ', title: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', message: '–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Google Sheets...', type: 'info', showUndo: false, duration: 60000 });
  
  try {
    // –®–ê–ì 1: PULL –∏–∑ –æ–±–ª–∞–∫–∞
    const [txData, exData, rulesData, settingsData, bizRulesData, bucketRulesData] = await Promise.all([
      fetchFromSheets('transactions'), fetchFromSheets('excluded'),
      fetchFromSheets('rules'), fetchFromSheets('settings'),
      fetchFromSheets('bizrules'), fetchFromSheets('bucketrules')
    ]);
    
    // –®–ê–ì 2: Merge + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è + –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
    if (txData.success && txData.data) {
      budgetData.transactions = mergeTransactions(budgetData.transactions, txData.data);
    }
    if (exData.success && exData.data) {
      budgetData.excludedTransactions = mergeTransactions(budgetData.excludedTransactions || [], exData.data);
    }
    if (rulesData.success && rulesData.data && Object.keys(rulesData.data).length > 0) {
      userCategoryRules = { ...userCategoryRules, ...rulesData.data };
      saveUserRules();
    }
    if (bizRulesData && bizRulesData.success && bizRulesData.data && Object.keys(bizRulesData.data).length > 0) {
      businessRules = { ...businessRules, ...bizRulesData.data };
      localStorage.setItem('businessRules', JSON.stringify(businessRules));
    }
    if (bucketRulesData && bucketRulesData.success && bucketRulesData.data && Object.keys(bucketRulesData.data).length > 0) {
      bucketRules = { ...bucketRules, ...bucketRulesData.data };
      localStorage.setItem('bucketRules', JSON.stringify(bucketRules));
    }
    if (settingsData.success && settingsData.data && Object.keys(settingsData.data).length > 0) {
      applyCloudSettings(settingsData.data);
    }
    
    budgetData.lastUpdate = new Date().toISOString();
    updateNorms();
    saveDataLocal();
    updateUI();
    
    // –®–ê–ì 3: PUSH —á–∏—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±–ª–∞–∫–æ
    // (–ø–æ—Å–ª–µ merge+dedup –¥–∞–Ω–Ω—ã–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±–ª–∞–∫–æ —á–∏—Å—Ç–æ–π –∫–æ–ø–∏–µ–π)
    await uploadAllData();
    
    showToast({ icon: '‚òÅÔ∏è', title: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', message: `–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${budgetData.transactions.length} | –ò—Å–∫–ª—é—á—ë–Ω–Ω—ã—Ö: ${(budgetData.excludedTransactions || []).length}`, type: 'success', showUndo: false });
  } catch (e) {
    console.error('Sync error:', e);
    showToast({ icon: '‚ö†Ô∏è', title: '–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º', message: '–†–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏.', type: 'info', showUndo: false, duration: 5000 });
  } finally {
    if (btn) { btn.textContent = 'üîÑ'; btn.disabled = false; }
  }
}

// === –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ===

function mergeTransactions(local, cloud) {
  const cloudArray = Array.isArray(cloud) ? cloud : [];
  const localArray = Array.isArray(local) ? local : [];
  if (cloudArray.length === 0) return localArray;
  
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ–±–ª–∞—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –¥–∞—Ç—ã ‚Üí DD.MM.YYYY, monthKey ‚Üí YYYY-MM, amount ‚Üí number
  // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ: Google Sheets –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç (ISO –≤–º–µ—Å—Ç–æ DD.MM.YYYY),
  // —á–∏—Å–µ–ª –∏ —Å—Ç—Ä–æ–∫, —á—Ç–æ –ª–æ–º–∞–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π –≤ getTxKey()
  const normalizedCloud = cloudArray.map(tx => {
    const n = {...tx};
    if (n.date) n.date = normalizeDateForStorage(n.date);
    if (n.date && !n.monthKey) n.monthKey = getMonthKeyFromDate(n.date);
    if (n.monthKey) n.monthKey = normalizeMonthKey(n.monthKey);
    if (n.amount !== undefined) n.amount = parseFloat(n.amount) || 0;
    return n;
  });
  
  if (localArray.length === 0) {
    return deduplicateTransactions(normalizedCloud);
  }
  
  // –ö–ª—é—á–∏ –û–ë–õ–ê–ß–ù–´–• —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (—É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö)
  const cloudKeys = new Set(normalizedCloud.map(tx => getTxKey(tx)));
  // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –õ–û–ö–ê–õ–¨–ù–´–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ –æ–±–ª–∞–∫–µ
  const localOnly = localArray.filter(tx => !cloudKeys.has(getTxKey(tx)));
  // –û–±—ä–µ–¥–∏–Ω—è–µ–º: –æ–±–ª–∞–∫–æ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) + —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ
  const merged = [...normalizedCloud, ...localOnly];
  merged.forEach(tx => { if (tx.monthKey) tx.monthKey = normalizeMonthKey(tx.monthKey); });
  return deduplicateTransactions(merged);
}

function getSettingsForSync() {
  const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  const { headerPhoto, bgPhoto, ...syncable } = settings;
  syncable.updatedAt = new Date().toISOString();
  return syncable;
}

function applyCloudSettings(cloudSettings) {
  const localSettings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
  const merged = { ...localSettings, ...cloudSettings };
  if (localSettings.headerPhoto) merged.headerPhoto = localSettings.headerPhoto;
  if (localSettings.bgPhoto) merged.bgPhoto = localSettings.bgPhoto;
  localStorage.setItem('budgetSettings', JSON.stringify(merged));
  loadSavedSettings();
}

async function uploadAllData() {
  const promises = [];
  if (budgetData.transactions && budgetData.transactions.length > 0) {
    promises.push(uploadToSheets(budgetData.transactions, 'transactions'));
  }
  if (budgetData.excludedTransactions && budgetData.excludedTransactions.length > 0) {
    promises.push(uploadToSheets(budgetData.excludedTransactions, 'excluded'));
  }
  if (Object.keys(userCategoryRules).length > 0) {
    promises.push(uploadToSheets(userCategoryRules, 'rules'));
  }
  if (Object.keys(businessRules).length > 0) {
    promises.push(uploadToSheets(businessRules, 'bizrules'));
  }
  if (Object.keys(bucketRules).length > 0) {
    promises.push(uploadToSheets(bucketRules, 'bucketrules'));
  }
  promises.push(uploadToSheets(getSettingsForSync(), 'settings'));
  return Promise.all(promises);
}

let _uploadDebounceTimer = null;
let _uploadInProgress = false;
function uploadAllDataDebounced() {
  clearTimeout(_uploadDebounceTimer);
  _uploadDebounceTimer = setTimeout(async () => {
    if (_uploadInProgress) {
      console.log('Auto-sync: upload already in progress, will retry');
      uploadAllDataDebounced();
      return;
    }
    _uploadInProgress = true;
    try {
      await uploadAllData();
      console.log('Auto-sync: uploaded all data');
    } catch (e) {
      console.log('Auto-sync failed (offline?):', e.message);
    } finally {
      _uploadInProgress = false;
    }
  }, 2000);
}

function saveDataLocal() {
  localStorage.setItem('familyBudgetV19', JSON.stringify(budgetData));
}

function saveBudgetSettings(settings) {
  localStorage.setItem('budgetSettings', JSON.stringify(settings));
  uploadAllDataDebounced();
}

// –ü–µ—Ä–µ—Å—á—ë—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
function recategorizeAll() {
  if (!budgetData.transactions || budgetData.transactions.length === 0) {
    showToast({ icon: '‚ö†Ô∏è', title: '–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π', message: '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—ã–ø–∏—Å–∫–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.', type: 'info', showUndo: false });
    return;
  }
  
  const confirmed = confirm(`–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è ${budgetData.transactions.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?\n\n–≠—Ç–æ –ø—Ä–∏–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫–æ –≤—Å–µ–º –∑–∞–ø–∏—Å—è–º.`);
  if (!confirmed) return;
  
  saveToHistory(`–ü–µ—Ä–µ—Å—á—ë—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π`);
  
  let changed = 0;
  const changes = [];
  
  budgetData.transactions.forEach(tx => {
    const oldCategory = tx.category;
    const newCategory = categorize(tx.description || tx.merchant || '');
    
    if (oldCategory !== newCategory) {
      changes.push(`${tx.merchant || tx.description?.substring(0, 20)}: ${oldCategory} ‚Üí ${newCategory}`);
      tx.category = newCategory;
      changed++;
    }
  });
  
  if (changed > 0) {
    saveData();
    updateUI();
    
    const preview = changes.slice(0, 5).join('\n');
    const more = changes.length > 5 ? `\n...–∏ –µ—â—ë ${changes.length - 5}` : '';
    showToast({
      icon: 'üîÑ',
      title: `–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ: ${changed} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π`,
      message: preview + more,
      type: 'success',
      duration: 7000
    });
  } else {
    showToast({ icon: '‚úÖ', title: '–í—Å—ë –∞–∫—Ç—É–∞–ª—å–Ω–æ', message: '–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É–∂–µ –≤–µ—Ä–Ω—ã–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç.', type: 'success', showUndo: false });
  }
}

// –û—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–µ–π –≤—Ä—É—á–Ω—É—é
function cleanupDuplicates() {
  const before = budgetData.transactions.length;
  budgetData.transactions = deduplicateTransactions(budgetData.transactions);
  const after = budgetData.transactions.length;
  const removed = before - after;
  
  if (removed > 0) {
    saveData();
    updateUI();
    showToast({
      icon: 'üßπ',
      title: `–£–¥–∞–ª–µ–Ω–æ ${removed} –¥—É–±–ª–µ–π`,
      message: `–ë—ã–ª–æ: ${before} ‚Üí –°—Ç–∞–ª–æ: ${after} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π`,
      type: 'success',
      showUndo: false
    });
  } else {
    showToast({ icon: '‚úÖ', title: '–î—É–±–ª–µ–π –Ω–µ—Ç', message: '–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ.', type: 'success', showUndo: false });
  }
}

// Upload –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets
// type: 'transactions' | 'excluded' | 'rules' | 'settings'
async function uploadToSheets(data, type = 'transactions') {
  try {
    let body;
    
    if (type === 'rules' || type === 'settings') {
      body = JSON.stringify(data);
    } else {
      const items = Array.isArray(data) ? data : [];
      const normalized = items.map(tx => ({
        ...tx,
        date: normalizeDateForStorage(tx.date),
        monthKey: getMonthKeyFromDate(tx.date) || normalizeMonthKey(tx.monthKey)
      }));
      body = JSON.stringify(normalized);
    }
    
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 60000);
    
    const response = await fetch(GOOGLE_SHEETS_URL + '?type=' + type, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'text/plain' },
      body: body,
      signal: controller.signal
    });
    
    clearTimeout(timeout);
    
    const text = await response.text();
    try {
      return JSON.parse(text);
    } catch {
      console.log('Response ' + type + ':', text);
      return { success: true };
    }
  } catch (e) {
    console.error('Upload error (' + type + '):', e);
    return { success: false, error: e.message };
  }
}

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è (DD.MM.YYYY)
function normalizeDateForStorage(dateStr) {
  if (!dateStr) return '';
  const str = String(dateStr).trim();
  
  // ISO —Ñ–æ—Ä–º–∞—Ç: 2025-06-28T21:00:00.000Z
  if (str.includes('T')) {
    const d = new Date(str);
    if (!isNaN(d)) {
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}.${month}.${year}`;
    }
  }
  
  // –£–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
  if (str.match(/^\d{2}\.\d{2}\.\d{4}/)) {
    return str.split(' ')[0]; // –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è –µ—Å–ª–∏ –µ—Å—Ç—å
  }
  
  // –§–æ—Ä–º–∞—Ç YYYY-MM-DD
  if (str.match(/^\d{4}-\d{2}-\d{2}/)) {
    const parts = str.split('T')[0].split('-');
    return `${parts[2]}.${parts[1]}.${parts[0]}`;
  }
  
  return str;
}

// ==================== UI ====================

function showTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('tab-active');
    btn.classList.add('bg-white', 'text-gray-600');
    btn.style.background = ''; // –°–±—Ä–æ—Å –∏–Ω–ª–∞–π–Ω —Å—Ç–∏–ª—è
  });
  
  const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
  if (activeBtn) {
    activeBtn.classList.add('tab-active');
    activeBtn.classList.remove('bg-white', 'text-gray-600');
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É
    const settings = JSON.parse(localStorage.getItem('budgetSettings') || '{}');
    if (settings.primaryColor && settings.secondaryColor) {
      activeBtn.style.background = `linear-gradient(135deg, ${settings.primaryColor}, ${settings.secondaryColor})`;
    }
  }
  
  renderTab(tabName);
}

function renderTab(tabName) {
  const content = document.getElementById('tabContent');
  const filtered = getFilteredTransactions();
  
  switch(tabName) {
    case 'overview':
      content.innerHTML = renderOverview(filtered);
      renderCharts(filtered);
      break;
    case 'categories':
      content.innerHTML = renderCategories(filtered);
      break;
    case 'trends':
      content.innerHTML = renderTrends();
      renderTrendChart();
      break;
    case 'transactions':
      content.innerHTML = renderTransactions(filtered);
      break;
    case 'excluded':
      content.innerHTML = renderExcluded();
      break;
    case 'bizexpenses':
      content.innerHTML = renderBizExpenses();
      break;
  }
}

function getFilteredTransactions() {
  const monthFrom = document.getElementById('monthFilter').value;
  const monthTo = document.getElementById('monthFilterTo').value;
  const categoryFilter = document.getElementById('categoryFilter').value;
  
  return budgetData.transactions.filter(tx => {
    // –§–∏–ª—å—Ç—Ä –ø–æ –≤–ª–∞–¥–µ–ª—å—Ü—É
    if (currentOwner !== 'all' && tx.owner !== currentOwner) return false;
    
    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if (categoryFilter !== 'all' && tx.category !== categoryFilter) return false;
    
    // –§–∏–ª—å—Ç—Ä –ø–æ –º–µ—Å—è—Ü—É/–¥–∏–∞–ø–∞–∑–æ–Ω—É
    if (monthTo) {
      // –î–∏–∞–ø–∞–∑–æ–Ω –º–µ—Å—è—Ü–µ–≤
      if (tx.monthKey < monthFrom || tx.monthKey > monthTo) return false;
    } else {
      // –û–¥–∏–Ω –º–µ—Å—è—Ü
      if (currentMonth !== 'all' && tx.monthKey !== currentMonth) return false;
    }
    
    return true;
  });
}

function renderOverview(transactions) {
  const byCategory = {};
  let total = 0;
  
  transactions.forEach(tx => {
    byCategory[tx.category] = (byCategory[tx.category] || 0) + tx.amount;
    total += tx.amount;
  });
  
  const sorted = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);
  const norm = Object.values(budgetData.norms || {}).reduce((sum, n) => sum + (n.monthly_avg || 0), 0);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–ø–∫—É
  document.getElementById('monthTotal').textContent = formatMoney(total);
  document.getElementById('monthNorm').textContent = formatMoney(norm);
  document.getElementById('progressValues').textContent = `${formatMoney(total)} / ${formatMoney(norm)}`;
  const progressPct = norm > 0 ? Math.min(100, (total / norm * 100)) : 0;
  document.getElementById('progressBar').style.width = progressPct + '%';
  document.getElementById('progressPercent').textContent = Math.round(progressPct) + '%';
  document.getElementById('remainingBudget').textContent = norm > total ? `–û—Å—Ç–∞—Ç–æ–∫: ${formatMoney(norm - total)}` : `–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥: ${formatMoney(total - norm)}`;
  document.getElementById('progressBar').className = `progress-bar h-full rounded-full ${total > norm ? 'bg-red-400' : 'bg-white'}`;
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –æ–∫–Ω–æ (–¥–ª—è –ì–ª–∞–≤–Ω–æ–π –≤ index.html)
  if (window.parent !== window) {
    try { window.parent.postMessage({ type: 'familySummary', spent: total, budget: norm }, '*'); } catch(e) {}
    try { sendBizExpensesSummary(); } catch(e) {}
  }
  
  // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ–º –∏ –∑–∞–ø–∞—Å–æ–º
  const overBudget = [];
  const underBudget = [];
  
  // –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –Ω–æ—Ä–º–∞–º–∏
  Object.entries(budgetData.norms || {}).forEach(([cat, normData]) => {
    const amount = byCategory[cat] || 0;
    const catNorm = normData.monthly_avg || 0;
    if (catNorm > 0) {
      if (amount > catNorm) {
        overBudget.push({ cat, amount, norm: catNorm, diff: amount - catNorm });
      } else {
        underBudget.push({ cat, amount, norm: catNorm, diff: catNorm - amount });
      }
    }
  });
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞–∑–Ω–∏—Ü–µ
  overBudget.sort((a, b) => b.diff - a.diff);
  underBudget.sort((a, b) => b.diff - a.diff);
  
  return `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-white rounded-2xl p-4 shadow-sm">
        <h3 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">üî¥ –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ</h3>
        <div class="space-y-2">
          ${overBudget.slice(0, 5).map(item => `
            <div class="flex justify-between items-center p-2 bg-red-50 rounded-lg cursor-pointer hover:bg-red-100" onclick="showCategoryDrill('${item.cat}')">
              <div>
                <span class="text-sm font-medium text-red-700">${item.cat}</span>
                <div class="text-xs text-red-600 opacity-70">${formatMoney(item.amount)} / ${formatMoney(item.norm)}</div>
              </div>
              <span class="text-sm font-bold text-red-600">+${formatMoney(item.diff)}</span>
            </div>
          `).join('') || '<p class="text-gray-400 text-sm">–í—Å—ë –≤ –Ω–æ—Ä–º–µ! üéâ</p>'}
        </div>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-sm">
        <h3 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">üü¢ –í –∑–∞–ø–∞—Å–µ</h3>
        <div class="space-y-2">
          ${underBudget.slice(0, 5).map(item => `
            <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg cursor-pointer hover:bg-green-100" onclick="showCategoryDrill('${item.cat}')">
              <div>
                <span class="text-sm font-medium text-green-700">${item.cat}</span>
                <div class="text-xs text-green-600 opacity-70">${formatMoney(item.amount)} / ${formatMoney(item.norm)}</div>
              </div>
              <span class="text-sm font-bold text-green-600">${formatMoney(item.diff)}</span>
            </div>
          `).join('') || '<p class="text-gray-400 text-sm">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—ã–ø–∏—Å–∫–∏</p>'}
        </div>
      </div>
    </div>
    ${transactions.length > 0 ? `
    <div class="bg-white rounded-2xl p-4 shadow-sm">
      <h3 class="font-semibold text-gray-700 mb-3">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
      <canvas id="pieChart" height="200"></canvas>
    </div>
    ` : `
    <div class="bg-white rounded-2xl p-8 shadow-sm text-center">
      <div class="text-6xl mb-4">üì§</div>
      <h3 class="font-semibold text-gray-700 mb-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</h3>
      <p class="text-gray-500 text-sm mb-4">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—ã–ø–∏—Å–∫–∏ –°–±–µ—Ä–±–∞–Ω–∫–∞ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>
      <button onclick="showUploadModal()" class="bg-gradient-to-r from-purple-500 to-fuchsia-500 text-white px-6 py-3 rounded-xl font-semibold">
        –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫–∏
      </button>
    </div>
    `}
  `;
}

function renderCategories(transactions) {
  const byCategory = {};
  
  transactions.forEach(tx => {
    if (!byCategory[tx.category]) {
      byCategory[tx.category] = { total: 0, count: 0, merchants: {} };
    }
    byCategory[tx.category].total += tx.amount;
    byCategory[tx.category].count++;
    
    const m = tx.merchant;
    if (!byCategory[tx.category].merchants[m]) {
      byCategory[tx.category].merchants[m] = { total: 0, count: 0 };
    }
    byCategory[tx.category].merchants[m].total += tx.amount;
    byCategory[tx.category].merchants[m].count++;
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –Ω–æ—Ä–º (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
  Object.keys(budgetData.norms || {}).forEach(cat => {
    if (!byCategory[cat]) {
      byCategory[cat] = { total: 0, count: 0, merchants: {} };
    }
  });
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–æ—Ä–º–µ (—É–±—ã–≤–∞—è—Å—å)
  const sorted = Object.entries(byCategory).sort((a, b) => {
    const normA = (budgetData.norms || {})[a[0]]?.monthly_avg || 0;
    const normB = (budgetData.norms || {})[b[0]]?.monthly_avg || 0;
    return normB - normA;
  });
  
  const total = sorted.reduce((sum, [_, data]) => sum + data.total, 0);
  
  return `
    <div class="space-y-3">
      ${sorted.map(([cat, data]) => {
        const norm = (budgetData.norms || {})[cat]?.monthly_avg || 0;
        const pct = total > 0 ? (data.total / total * 100).toFixed(1) : 0;
        const status = data.total > 0 ? (data.total > norm ? 'üî¥' : 'üü¢') : '‚ö™';
        const diffText = norm > 0 ? (data.total > norm ? `+${formatMoney(data.total - norm)}` : `${formatMoney(norm - data.total)} –≤ –∑–∞–ø–∞—Å–µ`) : '';
        const progressPct = norm > 0 ? Math.min(100, data.total / norm * 100) : 0;
        
        return `
          <div class="category-card bg-white rounded-2xl p-4 shadow-sm cursor-pointer" onclick="showCategoryDrill('${cat}')">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-semibold text-gray-800">${status} ${cat}</div>
                <div class="text-sm text-gray-500">${data.count > 0 ? `${data.count} –æ–ø–µ—Ä–∞—Ü–∏–π` : '–Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π'}</div>
              </div>
              <div class="text-right">
                <div class="text-lg font-bold ${data.total > norm && norm > 0 ? 'text-red-600' : 'text-gray-800'}">${formatMoney(data.total)}</div>
                ${norm > 0 ? `<div class="text-xs text-gray-500">–Ω–æ—Ä–º–∞: ${formatMoney(norm)}</div>` : ''}
              </div>
            </div>
            ${norm > 0 ? `
              <div class="mt-3">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                  <span>${Math.round(progressPct)}% –æ—Ç –Ω–æ—Ä–º—ã</span>
                  <span class="${data.total > norm ? 'text-red-500' : 'text-green-500'}">${diffText}</span>
                </div>
                <div class="bg-gray-100 rounded-full h-2 overflow-hidden">
                  <div class="h-full rounded-full transition-all ${data.total > norm ? 'bg-red-400' : 'bg-green-400'}" style="width: ${progressPct}%"></div>
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function renderTrends() {
  // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º –º–µ—Å—è—Ü–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  const byMonth = {};
  const byMonthCategory = {};
  
  budgetData.transactions.forEach(tx => {
    if (!tx.monthKey) return;
    byMonth[tx.monthKey] = (byMonth[tx.monthKey] || 0) + tx.amount;
    
    if (!byMonthCategory[tx.category]) byMonthCategory[tx.category] = {};
    byMonthCategory[tx.category][tx.monthKey] = (byMonthCategory[tx.category][tx.monthKey] || 0) + tx.amount;
  });
  
  if (Object.keys(byMonth).length === 0) {
    return `
      <div class="bg-white rounded-2xl p-8 shadow-sm text-center">
        <div class="text-6xl mb-4">üìà</div>
        <h3 class="font-semibold text-gray-700 mb-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</h3>
        <p class="text-gray-500 text-sm">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—ã–ø–∏—Å–∫–∏ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∏–Ω–∞–º–∏–∫—É —Ä–∞—Å—Ö–æ–¥–æ–≤</p>
      </div>
    `;
  }
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  const categoryStats = {};
  Object.entries(byMonthCategory).forEach(([cat, months]) => {
    const values = Object.values(months);
    const total = values.reduce((a, b) => a + b, 0);
    const monthCount = Object.keys(months).length;
    const avg = monthCount > 0 ? total / monthCount : 0;
    const norm = budgetData.norms[cat]?.monthly_avg || 0;
    categoryStats[cat] = { total, avg, norm, monthCount };
  });
  
  const topCategories = Object.entries(categoryStats)
    .sort((a, b) => b[1].total - a[1].total)
    .slice(0, 8)
    .map(([cat]) => cat);
  
  return `
    <div class="space-y-4">
      <!-- –û–±—â–∏–π –≥—Ä–∞—Ñ–∏–∫ -->
      <div class="bg-white rounded-2xl p-4 shadow-sm">
        <h3 class="font-semibold text-gray-700 mb-3">üìà –û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
        <canvas id="trendChart" height="200"></canvas>
      </div>
      
      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
      <div class="bg-white rounded-2xl p-4 shadow-sm">
        <h3 class="font-semibold text-gray-700 mb-3">üìä –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${topCategories.map(cat => {
            const stats = categoryStats[cat];
            const avgVsNorm = stats.norm > 0 ? (stats.avg > stats.norm ? 'text-red-500' : 'text-green-500') : 'text-gray-500';
            return `
            <div class="border rounded-xl p-3 cursor-pointer hover:bg-purple-50 transition" onclick="showCategoryTrendDrill('${cat}')">
              <div class="flex justify-between items-center mb-1">
                <span class="font-medium text-sm">${cat}</span>
                <span class="text-xs text-gray-500">${formatMoney(stats.total)} –≤—Å–µ–≥–æ</span>
              </div>
              <div class="flex justify-between items-center mb-2 text-xs">
                <span class="text-gray-400">—Å—Ä: <span class="${avgVsNorm} font-medium">${formatMoney(stats.avg)}</span>/–º–µ—Å</span>
                ${stats.norm > 0 ? `<span class="text-gray-400">–Ω–æ—Ä–º–∞: ${formatMoney(stats.norm)}</span>` : ''}
              </div>
              <canvas id="catChart_${cat.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9]/g, '_')}" height="80"></canvas>
            </div>
          `}).join('')}
        </div>
      </div>
    </div>
  `;
}

function renderTransactions(transactions) {
  const sorted = [...transactions].sort((a, b) => {
    const dateA = a.date.split('.').reverse().join('-');
    const dateB = b.date.split('.').reverse().join('-');
    return dateB.localeCompare(dateA);
  });
  
  return `
    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
      <div class="p-3 bg-purple-50 text-xs text-purple-600">üí° –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å</div>
      <div class="divide-y divide-gray-100">
        ${sorted.slice(0, 100).map(tx => `
          <div class="p-3 hover:bg-purple-50 cursor-pointer transition" onclick="showMerchantCategoryModal('${tx.merchant.replace(/'/g, "\\'")}', '${tx.category}', '${tx.date}', ${tx.amount}, '${tx.owner.replace(/'/g, "\\'")}')">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="font-medium text-gray-800 text-sm">${tx.merchant}</div>
                <div class="text-xs text-gray-500">${tx.date} ‚Ä¢ ${tx.category} ‚Ä¢ ${tx.owner}</div>
              </div>
              <div class="text-right">
                <div class="font-semibold text-gray-800">${formatMoney(tx.amount)}</div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
      ${sorted.length > 100 ? `<div class="p-3 text-center text-gray-400 text-sm">–ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 100 –∏–∑ ${sorted.length}</div>` : ''}
    </div>
  `;
}

function renderExcluded() {
  const excl = budgetData.excludedTransactions || [];
  
  if (excl.length === 0) {
    return `
      <div class="bg-white rounded-2xl p-8 shadow-sm text-center">
        <div class="text-6xl mb-4">üîÄ</div>
        <h3 class="font-semibold text-gray-700 mb-2">–ù–µ—Ç –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
        <p class="text-gray-500 text-sm">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—ã–ø–∏—Å–∫–∏ ‚Äî –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –≤—ë–¥—Ä–∞–º</p>
      </div>
    `;
  }
  
  // –ù–∞–∑–Ω–∞—á–∞–µ–º –≤–µ–¥—Ä–∞ —Ä–µ—Ç—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ
  assignBucketsToAll();
  
  // –§–∏–ª—å—Ç—Ä –ø–æ –≤–ª–∞–¥–µ–ª—å—Ü—É
  const ownerFiltered = excl.filter(tx => currentOwner === 'all' || tx.owner === currentOwner);
  
  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≤–µ–¥—Ä–∞–º
  const buckets = { unassigned: [], business: [], transit: [] };
  ownerFiltered.forEach(tx => {
    const b = tx.bucket || 'unassigned';
    if (!buckets[b]) buckets[b] = [];
    buckets[b].push(tx);
  });
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  const bucketStats = {};
  let totalExcl = 0;
  Object.entries(buckets).forEach(([bk, txs]) => {
    const total = txs.reduce((s, t) => s + t.amount, 0);
    bucketStats[bk] = { count: txs.length, total };
    totalExcl += total;
  });
  
  const allIncluded = budgetData.transactions
    .filter(tx => currentOwner === 'all' || tx.owner === currentOwner)
    .reduce((s, tx) => s + tx.amount, 0);
  
  // –ü–æ—Ä—è–¥–æ–∫: –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–µ!) ‚Üí –±–∏–∑–Ω–µ—Å ‚Üí —Ç—Ä–∞–Ω–∑–∏—Ç
  const bucketOrder = ['unassigned', 'business', 'transit'];
  
  const bucketSections = bucketOrder.map(bk => {
    const meta = BUCKET_META[bk];
    const txs = buckets[bk] || [];
    const stats = bucketStats[bk] || { count: 0, total: 0 };
    if (txs.length === 0) return '';
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ—Ä—á–∞–Ω—Ç—É
    const byMerchant = {};
    txs.forEach(tx => {
      const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      if (!byMerchant[m]) byMerchant[m] = { total: 0, count: 0, items: [] };
      byMerchant[m].total += tx.amount;
      byMerchant[m].count++;
      byMerchant[m].items.push(tx);
    });
    
    const sortedMerchants = Object.entries(byMerchant).sort((a, b) => b[1].total - a[1].total);
    const isUnassigned = bk === 'unassigned';
    
    return `
      <div class="bg-white rounded-2xl shadow-sm mb-4 overflow-hidden" style="border-left:4px solid ${meta.color}">
        <div class="p-4 cursor-pointer" style="background:${meta.bgColor}" onclick="toggleExclSection('bucket_${bk}')">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="font-semibold text-gray-800">${meta.icon} ${meta.name} ${isUnassigned ? '<span class="text-xs bg-amber-500 text-white px-2 py-0.5 rounded-full ml-1">–¢—Ä–µ–±—É–µ—Ç —Ä–µ—à–µ–Ω–∏—è</span>' : ''}</h3>
              <div class="text-xs text-gray-500">${stats.count} –æ–ø–µ—Ä–∞—Ü–∏–π ‚Ä¢ ${sortedMerchants.length} –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold" style="color:${meta.color}">${formatMoney(stats.total)}</div>
              <div class="text-xs text-gray-400" id="bucket_${bk}_arrow">${isUnassigned ? '‚ñ≤' : '‚ñº'}</div>
            </div>
          </div>
        </div>
        
        <div id="bucket_${bk}" class="${isUnassigned ? '' : 'hidden'}">
          <div class="divide-y divide-gray-100">
            ${sortedMerchants.map(([merchant, data]) => {
              const bizTag = businessRules[(merchant || '').toUpperCase().trim()];
              const bizLabel = bizTag && BIZ_EXPENSE_CATS[bizTag] ? ' <span style="font-size:9px; background:' + BIZ_EXPENSE_CATS[bizTag].color + '20; color:' + BIZ_EXPENSE_CATS[bizTag].color + '; padding:1px 6px; border-radius:4px; font-weight:600;">' + BIZ_EXPENSE_CATS[bizTag].icon + ' ' + BIZ_EXPENSE_CATS[bizTag].name + '</span>' : '';
              
              return `
                <div class="p-3 hover:bg-gray-50 transition group">
                  <div class="flex justify-between items-start mb-1">
                    <div class="flex-1 cursor-pointer" onclick="showExcludedDrill('${merchant.replace(/'/g, "\\'")}', '${(data.items[0]?.reason || 'pattern')}')">
                      <div class="font-medium text-gray-800 text-sm">${merchant}${bizLabel}</div>
                      <div class="text-xs text-gray-400">${data.count} –æ–ø–µ—Ä–∞—Ü–∏–π</div>
                    </div>
                    <div class="flex items-center gap-1">
                      <div class="text-right mr-2 cursor-pointer" onclick="showExcludedDrill('${merchant.replace(/'/g, "\\'")}', '${(data.items[0]?.reason || 'pattern')}')">
                        <div class="font-bold text-gray-800 text-sm">${formatMoney(data.total)}</div>
                      </div>
                      ${renderBucketButtons(bk, merchant)}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  return `
    <!-- –ö–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞–º–∏ -->
    <div class="flex justify-end mb-3">
      <button onclick="showRulesManager()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-xl text-sm font-medium transition flex items-center gap-1">
        ‚öôÔ∏è –ú–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ <span class="text-xs text-gray-400">(${Object.keys(bucketRules).length + Object.keys(businessRules).length})</span>
      </button>
    </div>
    
    <!-- –°–≤–æ–¥–∫–∞ –ø–æ –≤—ë–¥—Ä–∞–º -->
    <div class="grid grid-cols-4 gap-2 mb-4">
      ${bucketOrder.map(bk => {
        const meta = BUCKET_META[bk];
        const stats = bucketStats[bk] || { count: 0, total: 0 };
        return `
          <div class="rounded-2xl p-3 shadow-sm text-center" style="background:${meta.bgColor}; border:1px solid ${meta.borderColor}">
            <div class="text-lg">${meta.icon}</div>
            <div class="text-xs text-gray-500">${meta.name}</div>
            <div class="text-sm font-bold" style="color:${meta.color}">${formatMoney(stats.total)}</div>
            <div class="text-[10px] text-gray-400">${stats.count} —à—Ç.</div>
          </div>
        `;
      }).join('')}
      <div class="bg-green-50 rounded-2xl p-3 shadow-sm text-center border border-green-200">
        <div class="text-lg">üë®‚Äçüë©‚Äçüëß</div>
        <div class="text-xs text-gray-500">–í –±—é–¥–∂–µ—Ç–µ</div>
        <div class="text-sm font-bold text-green-600">${formatMoney(allIncluded)}</div>
        <div class="text-[10px] text-gray-400">${budgetData.transactions.filter(tx => currentOwner === 'all' || tx.owner === currentOwner).length} —à—Ç.</div>
      </div>
    </div>
    
    ${buckets.unassigned.length > 0 ? '<div class="mb-2 text-xs text-amber-600 text-center font-medium">‚¨ÜÔ∏è –ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∂–¥—É—Ç –≤–∞—à–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</div>' : ''}
    
    ${bucketSections}
  `;
}

function renderBucketButtons(currentBucket, merchant) {
  const escapedM = merchant.replace(/'/g, "\\'");
  const buttons = [];
  
  if (currentBucket !== 'family') {
    buttons.push(`<button onclick="event.stopPropagation(); moveToBucket('${escapedM}', 'family')" class="text-[10px] px-2 py-1 rounded-lg bg-green-100 text-green-700 hover:bg-green-200 transition" title="–í —Å–µ–º—å—é">üë®‚Äçüë©‚Äçüëß</button>`);
  }
  if (currentBucket !== 'business') {
    buttons.push(`<button onclick="event.stopPropagation(); moveToBucket('${escapedM}', 'business')" class="text-[10px] px-2 py-1 rounded-lg bg-purple-100 text-purple-700 hover:bg-purple-200 transition" title="–í –±–∏–∑–Ω–µ—Å">üíº</button>`);
  }
  if (currentBucket !== 'transit') {
    buttons.push(`<button onclick="event.stopPropagation(); moveToBucket('${escapedM}', 'transit')" class="text-[10px] px-2 py-1 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition" title="–í —Ç—Ä–∞–Ω–∑–∏—Ç">üîÑ</button>`);
  }
  
  return `<div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">${buttons.join('')}</div>`;
}

function toggleExclSection(id) {
  const el = document.getElementById(id);
  const arrow = document.getElementById(id + '_arrow');
  if (el) {
    el.classList.toggle('hidden');
    if (arrow) arrow.textContent = el.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
  }
}

// ==================== –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï –ú–ï–ñ–î–£ –í–Å–î–†–ê–ú–ò ====================

function moveToBucket(merchant, targetBucket) {
  const key = (merchant || '').toUpperCase().trim();
  if (!key) return;
  
  if (targetBucket === 'family') {
    // –ü–µ—Ä–µ–Ω–æ—Å –≤ —Å–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    showExcludedDrill(merchant, '');
    return;
  }
  
  // –°–ø—Ä–∞—à–∏–≤–∞–µ–º: –∑–∞–ø–æ–º–Ω–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞?
  const meta = BUCKET_META[targetBucket];
  const remember = confirm(`–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ ¬´${merchant}¬ª ‚Üí ${meta.icon} ${meta.name}\n\n‚úÖ OK = –∑–∞–ø–æ–º–Ω–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞\n(–í—Å–µ –±—É–¥—É—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –º–µ—Ä—á–∞–Ω—Ç–∞ –±—É–¥—É—Ç –≤ ${meta.name})`);
  
  if (remember) {
    // –°–æ–∑–¥–∞—ë–º –ø—Ä–∞–≤–∏–ª–æ –≤–µ–¥—Ä–∞
    bucketRules[key] = targetBucket;
    saveBucketRules();
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ–¥—Ä–æ —É –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —ç—Ç–æ–≥–æ –º–µ—Ä—á–∞–Ω—Ç–∞
  saveToHistory(`–í–µ–¥—Ä–æ: ${merchant} ‚Üí ${meta.name}`);
  
  (budgetData.excludedTransactions || []).forEach(tx => {
    const m = (tx.merchant || tx.description || '').toUpperCase().trim();
    if (m === key) tx.bucket = targetBucket;
  });
  
  saveData();
  renderTab('excluded');
  
  showToast({
    icon: meta.icon,
    title: `‚Üí ${meta.name}`,
    message: `¬´${merchant.substring(0, 25)}¬ª ${remember ? '–Ω–∞–≤—Å–µ–≥–¥–∞' : '—Ä–∞–∑–æ–≤–æ'} –≤ ${meta.name}`,
    type: 'success',
    showUndo: true
  });
}

function saveBucketRules() {
  localStorage.setItem('bucketRules', JSON.stringify(bucketRules));
  uploadAllDataDebounced();
}

function loadBucketRules() {
  const saved = localStorage.getItem('bucketRules');
  if (saved) bucketRules = JSON.parse(saved);
}

// ==================== –≠–ö–†–ê–ù –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ê–í–ò–õ–ê–ú–ò ====================

function showRulesManager() {
  // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫
  const rules = [];
  
  // 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤—ë–¥–µ—Ä
  Object.entries(bucketRules).forEach(([pattern, bucket]) => {
    rules.push({ pattern, bucket, type: 'bucket', source: '–ö–∏—Ä–∏–ª–ª', editable: true });
  });
  
  // 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ (tagAsBusiness)
  Object.entries(businessRules).forEach(([pattern, bizCat]) => {
    const catInfo = BIZ_EXPENSE_CATS[bizCat];
    rules.push({ 
      pattern, 
      bucket: 'business', 
      type: 'biz', 
      bizCategory: bizCat,
      bizCatName: catInfo ? catInfo.icon + ' ' + catInfo.name : bizCat,
      source: '–ö–∏—Ä–∏–ª–ª', 
      editable: true 
    });
  });
  
  // 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–µ–º—å–∏
  Object.entries(userCategoryRules).forEach(([pattern, category]) => {
    rules.push({ pattern, bucket: 'family', type: 'category', category, source: '–ö–∏—Ä–∏–ª–ª', editable: true });
  });
  
  // 4. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤—ë–¥–µ—Ä (–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ)
  Object.entries(BUCKET_PATTERNS).forEach(([bucket, patterns]) => {
    patterns.forEach(p => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ
      if (bucketRules[p.toUpperCase()] || businessRules[p.toUpperCase()]) return;
      rules.push({ pattern: p, bucket, type: 'auto', source: '–∞–≤—Ç–æ', editable: false });
    });
  });
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–≤–µ—Ä—Ö—É
  rules.sort((a, b) => {
    if (a.editable !== b.editable) return a.editable ? -1 : 1;
    return a.pattern.localeCompare(b.pattern);
  });
  
  document.getElementById('drillModal').classList.remove('hidden');
  document.getElementById('drillModal').classList.add('flex');
  document.getElementById('drillTitle').textContent = '‚öôÔ∏è –ú–æ–∏ –ø—Ä–∞–≤–∏–ª–∞';
  
  const userRules = rules.filter(r => r.editable);
  const autoRules = rules.filter(r => !r.editable);
  
  document.getElementById('drillContent').innerHTML = `
    <div class="mb-4 p-3 bg-blue-50 rounded-xl">
      <div class="text-sm text-blue-800 font-medium">üìã ${rules.length} –ø—Ä–∞–≤–∏–ª –≤—Å–µ–≥–æ</div>
      <div class="text-xs text-blue-600">${userRules.length} –≤–∞—à–∏—Ö ‚Ä¢ ${autoRules.length} –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö</div>
    </div>
    
    <!-- –ü–æ–∏—Å–∫ -->
    <input type="text" id="rulesSearchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É..." 
           oninput="filterRulesList()" class="w-full p-3 border rounded-xl text-sm mb-3">
    
    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –≤–µ–¥—Ä—É -->
    <div class="flex gap-2 mb-4 flex-wrap">
      <button onclick="filterRulesByBucket('all')" class="rules-bucket-filter text-xs px-3 py-1.5 rounded-lg bg-gray-200 text-gray-700 font-medium">–í—Å–µ</button>
      ${Object.entries(BUCKET_META).map(([bk, meta]) => 
        `<button onclick="filterRulesByBucket('${bk}')" class="rules-bucket-filter text-xs px-3 py-1.5 rounded-lg font-medium" style="background:${meta.bgColor}; color:${meta.color}; border:1px solid ${meta.borderColor}">${meta.icon} ${meta.name}</button>`
      ).join('')}
    </div>
    
    <!-- –í–∞—à–∏ –ø—Ä–∞–≤–∏–ª–∞ -->
    ${userRules.length > 0 ? `
      <h4 class="font-semibold text-gray-800 mb-2">‚úèÔ∏è –í–∞—à–∏ –ø—Ä–∞–≤–∏–ª–∞ (${userRules.length})</h4>
      <div id="userRulesList" class="space-y-1 mb-4">
        ${userRules.map(r => renderRuleRow(r)).join('')}
      </div>
    ` : ''}
    
    <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ -->
    <div class="mt-2">
      <h4 class="font-semibold text-gray-800 mb-2 cursor-pointer" onclick="toggleExclSection('autoRulesSection')">
        ü§ñ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (${autoRules.length}) <span class="text-xs text-gray-400" id="autoRulesSection_arrow">‚ñº</span>
      </h4>
      <div id="autoRulesSection" class="hidden space-y-1">
        ${autoRules.map(r => renderRuleRow(r)).join('')}
      </div>
    </div>
    
    <!-- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ -->
    <div class="mt-4 pt-4 border-t border-gray-200">
      <h4 class="font-semibold text-gray-800 mb-2">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</h4>
      <div class="flex gap-2">
        <input type="text" id="newRulePattern" placeholder="–ü–∞—Ç—Ç–µ—Ä–Ω (–Ω–∞–ø—Ä. –õ–ï–†–£–ê)" class="flex-1 p-2 border rounded-lg text-sm">
        <select id="newRuleBucket" class="p-2 border rounded-lg text-sm">
          ${Object.entries(BUCKET_META).map(([bk, meta]) => 
            `<option value="${bk}">${meta.icon} ${meta.name}</option>`
          ).join('')}
        </select>
        <button onclick="addManualRule()" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-700 transition">+</button>
      </div>
    </div>
  `;
}

function renderRuleRow(rule) {
  const meta = BUCKET_META[rule.bucket] || BUCKET_META.unassigned;
  const extraInfo = rule.type === 'biz' ? ` ‚Üí ${rule.bizCatName}` : (rule.type === 'category' ? ` ‚Üí ${rule.category}` : '');
  
  return `
    <div class="rule-row flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 transition text-sm" data-bucket="${rule.bucket}" data-pattern="${rule.pattern.toLowerCase()}">
      <div class="flex items-center gap-2 flex-1 min-w-0">
        <span class="shrink-0 w-6 h-6 flex items-center justify-center rounded-md text-xs" style="background:${meta.bgColor}; border:1px solid ${meta.borderColor}">${meta.icon}</span>
        <span class="font-mono text-xs truncate">${rule.pattern}</span>
        <span class="text-[10px] text-gray-400">${extraInfo}</span>
      </div>
      <div class="flex items-center gap-1 shrink-0">
        <span class="text-[10px] text-gray-400">${rule.source}</span>
        ${rule.editable ? `<button onclick="deleteRule('${rule.pattern.replace(/'/g, "\\'")}', '${rule.type}')" class="text-red-400 hover:text-red-600 text-sm px-1" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>` : ''}
      </div>
    </div>
  `;
}

function filterRulesList() {
  const q = (document.getElementById('rulesSearchInput')?.value || '').toLowerCase();
  document.querySelectorAll('.rule-row').forEach(row => {
    const pattern = row.dataset.pattern || '';
    row.style.display = pattern.includes(q) ? '' : 'none';
  });
}

function filterRulesByBucket(bucket) {
  document.querySelectorAll('.rule-row').forEach(row => {
    row.style.display = (bucket === 'all' || row.dataset.bucket === bucket) ? '' : 'none';
  });
}

function deleteRule(pattern, type) {
  const key = pattern.toUpperCase().trim();
  
  if (type === 'bucket') {
    delete bucketRules[key];
    saveBucketRules();
  } else if (type === 'biz') {
    delete businessRules[key];
    saveUserRules();
  } else if (type === 'category') {
    delete userCategoryRules[key];
    saveUserRules();
  }
  
  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–µ–¥—Ä–∞
  assignBucketsToAll();
  saveData();
  
  showToast({ icon: 'üóëÔ∏è', title: '–ü—Ä–∞–≤–∏–ª–æ —É–¥–∞–ª–µ–Ω–æ', message: `¬´${pattern}¬ª ‚Äî —É–¥–∞–ª–µ–Ω–æ`, type: 'delete' });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–∞–≤–∏–ª
  showRulesManager();
}

function addManualRule() {
  const pattern = (document.getElementById('newRulePattern')?.value || '').trim();
  const bucket = document.getElementById('newRuleBucket')?.value;
  
  if (!pattern) { alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω'); return; }
  if (!bucket) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ–¥—Ä–æ'); return; }
  
  const key = pattern.toUpperCase();
  bucketRules[key] = bucket;
  saveBucketRules();
  
  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–µ–¥—Ä–∞
  assignBucketsToAll();
  saveData();
  
  const meta = BUCKET_META[bucket];
  showToast({ icon: '‚úÖ', title: '–ü—Ä–∞–≤–∏–ª–æ —Å–æ–∑–¥–∞–Ω–æ', message: `¬´${pattern}¬ª ‚Üí ${meta.icon} ${meta.name}`, type: 'success' });
  
  showRulesManager();
}

function formatMoneyCompact(amount) {
  if (amount >= 1000000) return Math.round(amount / 1000000) + '–ú';
  if (amount >= 1000) return Math.round(amount / 1000) + '–ö';
  return Math.round(amount) + '';
}

function getMonthShortName(monthKey) {
  const names = {'01':'–Ø–Ω–≤','02':'–§–µ–≤','03':'–ú–∞—Ä','04':'–ê–ø—Ä','05':'–ú–∞–π','06':'–ò—é–Ω','07':'–ò—é–ª','08':'–ê–≤–≥','09':'–°–µ–Ω','10':'–û–∫—Ç','11':'–ù–æ—è','12':'–î–µ–∫'};
  const m = monthKey?.split('-')[1];
  return names[m] || m || '?';
}

function showExcludedDrill(recipient, reason) {
  const excl = budgetData.excludedTransactions || [];
  const reasonLabels = {
    'transfer': 'üîÑ –ü–µ—Ä–µ–≤–æ–¥',
    'large_amount': 'üí∞ –ö—Ä—É–ø–Ω–∞—è –ø–æ–∫—É–ø–∫–∞',
    'pattern': 'üè¢ –ë–∏–∑–Ω–µ—Å/–†–∞—Å—Å—Ä–æ—á–∫–∞',
    'phone': 'üì± –ü–µ—Ä–µ–≤–æ–¥ —Å–µ–±–µ'
  };
  
  // –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–µ—Å–ª–∏ reason –ø—É—Å—Ç–æ–π ‚Äî –≤—Å–µ –ø—Ä–∏—á–∏–Ω—ã)
  const txs = excl.filter(tx => {
    const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    if (m !== recipient) return false;
    if (reason && reason !== '') return (tx.reason || 'pattern') === reason;
    return true;
  });
  
  if (txs.length === 0) return;
  
  // –¢–µ–∫—É—â–µ–µ –≤–µ–¥—Ä–æ –º–µ—Ä—á–∞–Ω—Ç–∞
  const currentBucket = txs[0].bucket || getBucketForTx(txs[0]);
  const currentMeta = BUCKET_META[currentBucket] || BUCKET_META.unassigned;
  const effectiveReason = reason || txs[0].reason || 'pattern';
  
  // –ü–æ –º–µ—Å—è—Ü–∞–º
  const byMonth = {};
  txs.forEach(tx => {
    if (!byMonth[tx.monthKey]) byMonth[tx.monthKey] = { total: 0, count: 0, items: [] };
    byMonth[tx.monthKey].total += tx.amount;
    byMonth[tx.monthKey].count++;
    byMonth[tx.monthKey].items.push(tx);
  });
  
  const months = Object.keys(byMonth).sort();
  const total = txs.reduce((s, tx) => s + tx.amount, 0);
  const avg = months.length > 0 ? Math.round(total / months.length) : 0;
  
  document.getElementById('drillModal').classList.remove('hidden');
  document.getElementById('drillModal').classList.add('flex');
  document.getElementById('drillTitle').textContent = recipient;
  
  const allCategories = getUserCategories();
  const escRecipient = recipient.replace(/'/g, "\\'");
  
  // –ö–Ω–æ–ø–∫–∏ –≤—ë–¥–µ—Ä –¥–ª—è –í–°–ï–• –æ–ø–µ—Ä–∞—Ü–∏–π
  const allBucketBtns = Object.entries(BUCKET_META).filter(([bk]) => bk !== currentBucket).map(([bk, meta]) => {
    if (bk === 'family') {
      // –°–µ–º—å—è ‚Äî –ø–µ—Ä–µ–Ω–æ—Å –≤ –±—é–¥–∂–µ—Ç (–ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑ –∫ —Å–µ–∫—Ü–∏–∏)
      return `<button onclick="document.getElementById('moveToBudgetSection').scrollIntoView({behavior:'smooth'})" 
                class="flex-1 py-3 rounded-xl text-sm font-bold transition border-2" 
                style="background:${meta.bgColor}; color:${meta.color}; border-color:${meta.borderColor}">
                ${meta.icon} –í —Å–µ–º—å—é
              </button>`;
    }
    return `<button onclick="moveAllToBucket('${escRecipient}', '${effectiveReason}', '${bk}')" 
              class="flex-1 py-3 rounded-xl text-sm font-bold transition border-2" 
              style="background:${meta.bgColor}; color:${meta.color}; border-color:${meta.borderColor}">
              ${meta.icon} ${meta.name}
            </button>`;
  }).join('');

  document.getElementById('drillContent').innerHTML = `
    <div class="mb-4 p-4 rounded-xl" style="background:${currentMeta.bgColor}; border:2px solid ${currentMeta.borderColor}">
      <div class="font-medium text-lg text-gray-800">${recipient}</div>
      <div class="text-sm mt-1 flex items-center gap-2">
        <span class="px-2 py-0.5 rounded-lg text-xs font-bold" style="background:${currentMeta.color}; color:white">${currentMeta.icon} ${currentMeta.name}</span>
        <span class="text-gray-400">${reasonLabels[effectiveReason] || effectiveReason}</span>
      </div>
      <div class="grid grid-cols-3 gap-3 mt-3">
        <div class="text-center">
          <div class="text-xs text-gray-500">–í—Å–µ–≥–æ</div>
          <div class="font-bold" style="color:${currentMeta.color}">${formatMoney(total)}</div>
        </div>
        <div class="text-center">
          <div class="text-xs text-gray-500">–í —Å—Ä–µ–¥–Ω–µ–º/–º–µ—Å</div>
          <div class="font-bold text-gray-700">${formatMoney(avg)}</div>
        </div>
        <div class="text-center">
          <div class="text-xs text-gray-500">–û–ø–µ—Ä–∞—Ü–∏–π</div>
          <div class="font-bold text-gray-700">${txs.length}</div>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê –ü–ï–†–ï–ú–ï–°–¢–ò–¢–¨ –í–°–ï –í –í–ï–î–†–û ‚ïê‚ïê‚ïê -->
    <div class="mb-4 p-4 bg-amber-50 rounded-xl border border-amber-200">
      <h4 class="font-semibold text-amber-800 mb-1">üîÄ –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –í–°–ï ${txs.length} –æ–ø–µ—Ä–∞—Ü–∏–π</h4>
      <p class="text-xs text-amber-600 mb-3">–í—Å–µ ¬´${recipient.substring(0, 25)}¬ª –Ω–∞–≤—Å–µ–≥–¥–∞ ‚Üí –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤–µ–¥—Ä–æ</p>
      <div class="flex gap-2">
        ${allBucketBtns}
      </div>
    </div>
    
    <!-- –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ —Ä–∞—Å—Ö–æ–¥ –∞—Ç–µ–ª—å–µ -->
    <div class="mb-4 p-4 bg-purple-50 rounded-xl border border-purple-200">
      <h4 class="font-semibold text-purple-800 mb-2">üíº –†–∞—Å—Ö–æ–¥ –∞—Ç–µ–ª—å–µ</h4>
      <p class="text-xs text-purple-600 mb-3">–ü–æ–º–µ—Ç–∏—Ç—å ¬´${recipient.substring(0, 25)}¬ª –∫–∞–∫ –±–∏–∑–Ω–µ—Å-—Ä–∞—Å—Ö–æ–¥</p>
      <select id="bizCategorySelect" class="w-full p-3 border rounded-xl text-sm mb-2">
        <option value="">‚Äî –ù–µ –±–∏–∑–Ω–µ—Å ‚Äî</option>
        ${Object.entries(BIZ_EXPENSE_CATS).map(([k, v]) => {
          const sel = businessRules[(recipient || '').toUpperCase().trim()] === k ? 'selected' : '';
          return '<option value="' + k + '" ' + sel + '>' + v.icon + ' ' + v.name + '</option>';
        }).join('')}
      </select>
      <button onclick="tagAsBusiness('${escRecipient}', document.getElementById('bizCategorySelect').value)" 
              class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl text-sm font-bold transition">
        üíº –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
      </button>
    </div>
    
    <!-- –ü–µ—Ä–µ–Ω–æ—Å –≤ –±—é–¥–∂–µ—Ç (—Å–µ–º—å—è) -->
    <div id="moveToBudgetSection" class="mb-4 p-4 bg-green-50 rounded-xl border border-green-200">
      <h4 class="font-semibold text-green-800 mb-2">üë®‚Äçüë©‚Äçüëß –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ —Å–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</h4>
      <p class="text-xs text-green-600 mb-3">–í—Å–µ ${txs.length} –æ–ø–µ—Ä–∞—Ü–∏–π ‚Üí –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</p>
      <select id="exclMoveCategorySelect" class="w-full p-3 border rounded-xl text-sm mb-2" onchange="handleExclCategorySelectChange()">
        ${allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
        <option value="__NEW__">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
      </select>
      <div id="exclNewCategoryInput" class="hidden mb-2">
        <input type="text" id="exclCustomCategoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" 
               class="w-full p-3 border rounded-xl text-sm" maxlength="30">
      </div>
      <button onclick="moveExcludedToCategory('${escRecipient}', '${effectiveReason}')" 
              class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl text-sm font-bold transition">
        ‚úÖ –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å–µ ${txs.length} –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –±—é–¥–∂–µ—Ç
      </button>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê –ü–û–ú–ï–°–Ø–ß–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê –° –ö–ù–û–ü–ö–ê–ú–ò ‚ïê‚ïê‚ïê -->
    <div class="space-y-2">
      ${months.map(mk => {
        const data = byMonth[mk];
        return `
          <div class="p-3 bg-gray-50 rounded-xl">
            <div class="flex justify-between items-center mb-1">
              <div class="font-medium text-gray-700">${getMonthName(mk)}</div>
              <div class="font-bold text-orange-600">${formatMoney(data.total)}</div>
            </div>
            <div class="text-xs text-gray-500">${data.count} –æ–ø–µ—Ä–∞—Ü–∏–π</div>
            <div class="mt-2 space-y-1">
              ${data.items.sort((a,b) => b.amount - a.amount).slice(0, 10).map((tx, idx) => {
                const txId = `${tx.date}_${tx.amount}_${(tx.owner||'').replace(/'/g,'')}`;
                return `
                <div class="flex justify-between items-center text-xs group py-0.5">
                  <span class="text-gray-500 truncate mr-1">${tx.date}${tx.owner !== 'Unknown' ? ' ‚Ä¢ ' + tx.owner : ''}</span>
                  <div class="flex items-center gap-1 shrink-0">
                    <span class="text-gray-600 font-medium">${formatMoney(tx.amount)}</span>
                    ${renderOneTxBucketBtns(tx, escRecipient, effectiveReason)}
                    <button onclick="moveOneExcludedPrompt('${tx.date}', '${escRecipient}', ${tx.amount}, '${(tx.owner || '').replace(/'/g, "\\'")}', '${effectiveReason}')" 
                            class="text-green-500 hover:text-green-700 opacity-0 group-hover:opacity-100 transition text-xs px-1" title="–í –±—é–¥–∂–µ—Ç (—Å–µ–º—å—è)">üì•</button>
                    <button onclick="deleteOneExcluded('${tx.date}', '${escRecipient}', ${tx.amount}, '${(tx.owner || '').replace(/'/g, "\\'")}', '${effectiveReason}')" 
                            class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition text-sm px-1" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                  </div>
                </div>
              `}).join('')}
              ${data.items.length > 10 ? `<div class="text-xs text-gray-400">...–∏ –µ—â—ë ${data.items.length - 10}</div>` : ''}
            </div>
          </div>
        `;
      }).join('')}
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è -->
    <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
      <button onclick="deleteAllExcludedRecipient('${escRecipient}', '${effectiveReason}')" 
              class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl text-sm font-bold transition">
        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å ¬´${recipient.substring(0, 25)}¬ª –∏–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è (${txs.length} —à—Ç.)
      </button>
      <p class="text-xs text-gray-400 text-center">–û–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç —É–±—Ä–∞–Ω—ã –∏–∑ –≤–∫–ª–∞–¥–∫–∏</p>
    </div>
  `;
}

// –ö–Ω–æ–ø–∫–∏ –≤—ë–¥–µ—Ä –¥–ª—è –û–î–ù–û–ô —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (inline, –≤ —Å–ø–∏—Å–∫–µ)
function renderOneTxBucketBtns(tx, escRecipient, reason) {
  const currentBucket = tx.bucket || 'unassigned';
  const btns = [];
  
  Object.entries(BUCKET_META).forEach(([bk, meta]) => {
    if (bk === currentBucket || bk === 'family') return; // family = —á–µ—Ä–µ–∑ üì•
    btns.push(`<button onclick="event.stopPropagation(); moveOneTxToBucket('${tx.date}', '${escRecipient}', ${tx.amount}, '${(tx.owner||'').replace(/'/g,"\\'")}', '${reason}', '${bk}')" 
      class="opacity-0 group-hover:opacity-100 transition text-[10px] px-1.5 py-0.5 rounded" 
      style="background:${meta.bgColor}; color:${meta.color}; border:1px solid ${meta.borderColor}" 
      title="${meta.name}">${meta.icon}</button>`);
  });
  
  return btns.join('');
}

// –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –í–°–ï –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–µ—Ä—á–∞–Ω—Ç–∞ –≤ –≤–µ–¥—Ä–æ (—Å –ø—Ä–∞–≤–∏–ª–æ–º –Ω–∞–≤—Å–µ–≥–¥–∞)
function moveAllToBucket(merchant, reason, targetBucket) {
  const key = (merchant || '').toUpperCase().trim();
  if (!key) return;
  
  const meta = BUCKET_META[targetBucket];
  const txs = (budgetData.excludedTransactions || []).filter(tx => {
    const m = (tx.merchant || tx.description?.substring(0, 35) || '').toUpperCase().trim();
    if (m !== key) return false;
    if (reason) return (tx.reason || 'pattern') === reason;
    return true;
  });
  
  if (txs.length === 0) return;
  
  const total = txs.reduce((s, t) => s + t.amount, 0);
  if (!confirm(`–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –í–°–ï ${txs.length} –æ–ø–µ—Ä–∞—Ü–∏–π ¬´${merchant}¬ª ‚Üí ${meta.icon} ${meta.name}?\n\n–°—É–º–º–∞: ${formatMoney(total)}\n\n‚úÖ –ü—Ä–∞–≤–∏–ª–æ –∑–∞–ø–æ–º–Ω–∏—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞`)) return;
  
  // –°–æ–∑–¥–∞—ë–º –ø—Ä–∞–≤–∏–ª–æ
  bucketRules[key] = targetBucket;
  saveBucketRules();
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ–¥—Ä–æ —É –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
  saveToHistory(`–í—Å–µ –≤–µ–¥—Ä–æ: ${merchant} ‚Üí ${meta.name} (${txs.length} —à—Ç.)`);
  txs.forEach(tx => { tx.bucket = targetBucket; });
  
  saveData();
  hideDrillModal();
  renderTab('excluded');
  
  showToast({
    icon: meta.icon,
    title: `–í—Å–µ ‚Üí ${meta.name}`,
    message: `${txs.length} –æ–ø–µ—Ä–∞—Ü–∏–π ¬´${merchant.substring(0, 25)}¬ª –Ω–∞ ${formatMoney(total)}`,
    type: 'success',
    showUndo: true
  });
}

// –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –û–î–ù–£ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –≤–µ–¥—Ä–æ (—Ä–∞–∑–æ–≤–æ, –±–µ–∑ –ø—Ä–∞–≤–∏–ª–∞)
function moveOneTxToBucket(date, merchant, amount, owner, reason, targetBucket) {
  const meta = BUCKET_META[targetBucket];
  const excl = budgetData.excludedTransactions || [];
  
  // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
  const idx = excl.findIndex(tx => {
    const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    return m === merchant && tx.date === date && Math.abs(tx.amount - amount) < 0.01 
           && (tx.owner || '') === owner;
  });
  
  if (idx === -1) return;
  
  excl[idx].bucket = targetBucket;
  
  saveToHistory(`1 –æ–ø–µ—Ä–∞—Ü–∏—è: ${merchant} ${date} ${formatMoney(amount)} ‚Üí ${meta.name}`);
  saveData();
  
  // –û–±–Ω–æ–≤–ª—è–µ–º drill (–ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º)
  showExcludedDrill(merchant, reason);
  
  showToast({
    icon: meta.icon,
    title: `‚Üí ${meta.name}`,
    message: `${date} ‚Ä¢ ${formatMoney(amount)} ‚Äî —Ä–∞–∑–æ–≤–æ`,
    type: 'success',
    duration: 2000
  });
}

// ==================== –ü–ï–†–ï–ù–û–° –ò–°–ö–õ–Æ–ß–Å–ù–ù–´–• –í –ë–Æ–î–ñ–ï–¢ ====================

function handleExclCategorySelectChange() {
  const select = document.getElementById('exclMoveCategorySelect');
  const inputDiv = document.getElementById('exclNewCategoryInput');
  if (select.value === '__NEW__') {
    inputDiv.classList.remove('hidden');
    document.getElementById('exclCustomCategoryName').focus();
  } else {
    inputDiv.classList.add('hidden');
  }
}

function getSelectedExclCategory() {
  const select = document.getElementById('exclMoveCategorySelect');
  if (select.value === '__NEW__') {
    const name = document.getElementById('exclCustomCategoryName').value.trim();
    if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'); return null; }
    saveUserCategory(name);
    return name;
  }
  return select.value;
}

function moveExcludedToCategory(merchant, reason) {
  const category = getSelectedExclCategory();
  if (!category) return;
  
  if (!budgetData.excludedTransactions) return;
  
  // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
  const toMove = budgetData.excludedTransactions.filter(tx => {
    const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    return m === merchant && (tx.reason || 'pattern') === reason;
  });
  
  if (toMove.length === 0) return;
  
  const total = toMove.reduce((s, t) => s + t.amount, 0);
  if (!confirm(`–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ ${toMove.length} –æ–ø–µ—Ä–∞—Ü–∏–π ¬´${merchant}¬ª –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´${category}¬ª?\n\n–°—É–º–º–∞: ${formatMoney(total)}\n\n–û–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ –±—é–¥–∂–µ—Ç–µ.`)) return;
  
  saveToHistory(`–ü–µ—Ä–µ–Ω–æ—Å –≤ –±—é–¥–∂–µ—Ç: ${merchant} ‚Üí ${category} (${toMove.length} —à—Ç.)`);
  
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º excluded ‚Üí –æ–±—ã—á–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  const newTxs = toMove.map(tx => ({
    date: tx.date,
    description: tx.description,
    merchant: tx.merchant,
    amount: tx.amount,
    category: category,
    monthKey: tx.monthKey,
    owner: tx.owner,
    source: tx.source
  }));
  
  // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  budgetData.transactions.push(...newTxs);
  budgetData.transactions = deduplicateTransactions(budgetData.transactions);
  
  // –£–¥–∞–ª—è–µ–º –∏–∑ excluded
  budgetData.excludedTransactions = budgetData.excludedTransactions.filter(tx => {
    const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    return !(m === merchant && (tx.reason || 'pattern') === reason);
  });
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –º–µ—Ä—á–∞–Ω—Ç–∞
  userCategoryRules[merchant] = category;
  saveUserRules();
  
  updateNorms();
  saveData();
  hideDrillModal();
  renderTab('excluded');
  
  showToast({
    icon: 'üì•',
    title: `–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ ¬´${category}¬ª`,
    message: `${toMove.length} –æ–ø–µ—Ä–∞—Ü–∏–π ¬´${merchant.substring(0, 25)}¬ª –Ω–∞ ${formatMoney(total)}\n–¢–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ –±—é–¥–∂–µ—Ç–µ.`,
    type: 'success',
    showUndo: true
  });
}

function moveOneExcludedPrompt(date, merchant, amount, owner, reason) {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ prompt-—Å—Ç–∏–ª—å –º–æ–¥–∞–ª
  const allCategories = getUserCategories();
  
  const html = `
    <div class="mb-4 p-4 bg-green-50 rounded-xl">
      <div class="font-medium text-gray-800">${merchant}</div>
      <div class="text-sm text-gray-500 mt-1">${date} ‚Ä¢ ${owner} ‚Ä¢ ${formatMoney(amount)}</div>
    </div>
    <div class="mb-3">
      <label class="block text-sm font-medium text-gray-700 mb-2">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
      <select id="exclMoveOneCategorySelect" class="w-full p-3 border rounded-xl text-sm" onchange="handleExclOneCategoryChange()">
        ${allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
        <option value="__NEW__">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
      </select>
      <div id="exclNewOneCategoryInput" class="hidden mt-2">
        <input type="text" id="exclCustomOneCategoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" 
               class="w-full p-3 border rounded-xl text-sm" maxlength="30">
      </div>
    </div>
    <div class="space-y-2">
      <button onclick="executeMoveOneExcluded('${date}', '${merchant.replace(/'/g, "\\'")}', ${amount}, '${owner.replace(/'/g, "\\'")}', '${reason}', false)" 
              class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl text-sm font-bold transition">
        üì• –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é
      </button>
      <button onclick="executeMoveOneExcluded('${date}', '${merchant.replace(/'/g, "\\'")}', ${amount}, '${owner.replace(/'/g, "\\'")}', '${reason}', true)" 
              class="w-full bg-green-500 hover:bg-green-600 text-white py-2.5 rounded-xl text-xs font-medium transition">
        üì• –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ¬´${merchant.substring(0, 20)}¬ª –≤ —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é
      </button>
    </div>
  `;
  
  document.getElementById('drillTitle').textContent = '–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –±—é–¥–∂–µ—Ç';
  document.getElementById('drillContent').innerHTML = html;
}

function handleExclOneCategoryChange() {
  const select = document.getElementById('exclMoveOneCategorySelect');
  const inputDiv = document.getElementById('exclNewOneCategoryInput');
  if (select.value === '__NEW__') {
    inputDiv.classList.remove('hidden');
    document.getElementById('exclCustomOneCategoryName').focus();
  } else {
    inputDiv.classList.add('hidden');
  }
}

function executeMoveOneExcluded(date, merchant, amount, owner, reason, moveAll) {
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
  const select = document.getElementById('exclMoveOneCategorySelect');
  let category;
  if (select.value === '__NEW__') {
    category = document.getElementById('exclCustomOneCategoryName').value.trim();
    if (!category) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'); return; }
    saveUserCategory(category);
  } else {
    category = select.value;
  }
  
  if (!budgetData.excludedTransactions) return;
  
  if (moveAll) {
    // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –º–µ—Ä—á–∞–Ω—Ç–∞
    moveExcludedToCategoryDirect(merchant, reason, category);
    return;
  }
  
  // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –æ–¥–Ω—É –æ–ø–µ—Ä–∞—Ü–∏—é
  saveToHistory(`–ü–µ—Ä–µ–Ω–æ—Å –≤ –±—é–¥–∂–µ—Ç: ${merchant} ${formatMoney(amount)} ‚Üí ${category}`);
  
  const idx = budgetData.excludedTransactions.findIndex(tx => {
    const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    return tx.date === date && m === merchant && tx.amount === amount && (tx.owner || '') === owner;
  });
  
  if (idx === -1) return;
  
  const tx = budgetData.excludedTransactions[idx];
  
  // –î–æ–±–∞–≤–ª—è–µ–º –≤ –±—é–¥–∂–µ—Ç
  budgetData.transactions.push({
    date: tx.date,
    description: tx.description,
    merchant: tx.merchant,
    amount: tx.amount,
    category: category,
    monthKey: tx.monthKey,
    owner: tx.owner,
    source: tx.source
  });
  budgetData.transactions = deduplicateTransactions(budgetData.transactions);
  
  // –£–¥–∞–ª—è–µ–º –∏–∑ excluded
  budgetData.excludedTransactions.splice(idx, 1);
  
  updateNorms();
  saveData();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –µ—â—ë –æ–ø–µ—Ä–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –º–µ—Ä—á–∞–Ω—Ç–∞
  const remaining = budgetData.excludedTransactions.filter(t => {
    const m = t.merchant || t.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    return m === merchant && (t.reason || 'pattern') === reason;
  });
  
  if (remaining.length > 0) {
    showExcludedDrill(merchant, reason);
  } else {
    hideDrillModal();
    renderTab('excluded');
  }
  
  showToast({
    icon: 'üì•',
    title: `–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ ¬´${category}¬ª`,
    message: `${date} ‚Ä¢ ${merchant.substring(0, 25)} ‚Ä¢ ${formatMoney(amount)}`,
    type: 'success',
    showUndo: true
  });
}

function moveExcludedToCategoryDirect(merchant, reason, category) {
  const toMove = budgetData.excludedTransactions.filter(tx => {
    const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    return m === merchant && (tx.reason || 'pattern') === reason;
  });
  
  if (toMove.length === 0) return;
  
  const total = toMove.reduce((s, t) => s + t.amount, 0);
  saveToHistory(`–ü–µ—Ä–µ–Ω–æ—Å –≤ –±—é–¥–∂–µ—Ç: ${merchant} ‚Üí ${category} (${toMove.length} —à—Ç.)`);
  
  const newTxs = toMove.map(tx => ({
    date: tx.date,
    description: tx.description,
    merchant: tx.merchant,
    amount: tx.amount,
    category: category,
    monthKey: tx.monthKey,
    owner: tx.owner,
    source: tx.source
  }));
  
  budgetData.transactions.push(...newTxs);
  budgetData.transactions = deduplicateTransactions(budgetData.transactions);
  
  budgetData.excludedTransactions = budgetData.excludedTransactions.filter(tx => {
    const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    return !(m === merchant && (tx.reason || 'pattern') === reason);
  });
  
  userCategoryRules[merchant] = category;
  saveUserRules();
  
  updateNorms();
  saveData();
  hideDrillModal();
  renderTab('excluded');
  
  showToast({
    icon: 'üì•',
    title: `–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ ¬´${category}¬ª`,
    message: `${toMove.length} –æ–ø–µ—Ä–∞—Ü–∏–π ¬´${merchant.substring(0, 25)}¬ª –Ω–∞ ${formatMoney(total)}`,
    type: 'success',
    showUndo: true
  });
}

// ==================== –£–î–ê–õ–ï–ù–ò–ï –ò–°–ö–õ–Æ–ß–Å–ù–ù–´–• ====================

function deleteOneExcluded(date, merchant, amount, owner, reason) {
  if (!budgetData.excludedTransactions) return;
  
  saveToHistory(`–£–¥–∞–ª–µ–Ω–∏–µ –∏—Å–∫–ª—é—á.: ${merchant} ${formatMoney(amount)}`);
  
  const idx = budgetData.excludedTransactions.findIndex(tx => {
    const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    return tx.date === date && m === merchant && tx.amount === amount && (tx.owner || '') === owner;
  });
  
  if (idx !== -1) {
    budgetData.excludedTransactions.splice(idx, 1);
    saveData();
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º drill-down —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    const remaining = (budgetData.excludedTransactions || []).filter(tx => {
      const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      return m === merchant && (tx.reason || 'pattern') === reason;
    });
    
    if (remaining.length > 0) {
      showExcludedDrill(merchant, reason);
    } else {
      hideDrillModal();
      renderTab('excluded');
    }
    
    showToast({
      icon: 'üóëÔ∏è',
      title: '–£–±—Ä–∞–Ω–æ –∏–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è',
      message: `${date} ‚Ä¢ ${merchant} ‚Ä¢ ${formatMoney(amount)}`,
      type: 'delete',
      showUndo: true
    });
  }
}

function deleteAllExcludedRecipient(merchant, reason) {
  if (!budgetData.excludedTransactions) return;
  
  const txs = budgetData.excludedTransactions.filter(tx => {
    const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    return m === merchant && (tx.reason || 'pattern') === reason;
  });
  
  if (txs.length === 0) return;
  
  const total = txs.reduce((s, t) => s + t.amount, 0);
  if (!confirm(`–£–±—Ä–∞—Ç—å ¬´${merchant}¬ª –∏–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è?\n\n${txs.length} –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞ ${formatMoney(total)}\n\n–û–ø–µ—Ä–∞—Ü–∏–∏ –∏—Å—á–µ–∑–Ω—É—Ç –∏–∑ –≤–∫–ª–∞–¥–∫–∏ ¬´–ò—Å–∫–ª—é—á–µ–Ω–∏—è¬ª.`)) return;
  
  saveToHistory(`–£–¥–∞–ª–µ–Ω–∏–µ –∏—Å–∫–ª—é—á.: ${merchant} (${txs.length} —à—Ç.)`);
  
  budgetData.excludedTransactions = budgetData.excludedTransactions.filter(tx => {
    const m = tx.merchant || tx.description?.substring(0, 35) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    return !(m === merchant && (tx.reason || 'pattern') === reason);
  });
  
  saveData();
  hideDrillModal();
  renderTab('excluded');
  
  showToast({
    icon: 'üóëÔ∏è',
    title: `¬´${merchant.substring(0, 25)}¬ª —É–±—Ä–∞–Ω`,
    message: `${txs.length} –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞ ${formatMoney(total)} —É–±—Ä–∞–Ω—ã –∏–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è.`,
    type: 'delete',
    showUndo: true
  });
}

// ==================== –ë–ò–ó–ù–ï–°-–†–ê–°–•–û–î–´ –ê–¢–ï–õ–¨–ï ====================

function tagAsBusiness(recipient, bizCategory) {
  const key = (recipient || '').toUpperCase().trim();
  if (!key) return;
  
  if (!bizCategory) {
    // –°–Ω—è—Ç—å –ø–æ–º–µ—Ç–∫—É
    delete businessRules[key];
    showToast({ icon: 'üö´', title: '–ú–µ—Ç–∫–∞ —Å–Ω—è—Ç–∞', message: `¬´${recipient.substring(0, 25)}¬ª –±–æ–ª—å—à–µ –Ω–µ –±–∏–∑–Ω–µ—Å-—Ä–∞—Å—Ö–æ–¥`, type: 'info' });
  } else {
    businessRules[key] = bizCategory;
    const catName = BIZ_EXPENSE_CATS[bizCategory] ? BIZ_EXPENSE_CATS[bizCategory].name : bizCategory;
    showToast({ icon: 'üíº', title: '–ü–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –±–∏–∑–Ω–µ—Å', message: `¬´${recipient.substring(0, 25)}¬ª ‚Üí ${catName}`, type: 'success' });
  }
  
  saveUserRules();
  hideDrillModal();
  renderTab('excluded');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –æ–∫–Ω–æ
  sendBizExpensesSummary();
}

function getBizExpenseTransactions() {
  const excl = budgetData.excludedTransactions || [];
  const result = [];
  
  excl.forEach(tx => {
    const m = (tx.merchant || tx.description || '').toUpperCase().trim();
    if (businessRules[m]) {
      result.push({ ...tx, bizCategory: businessRules[m] });
    }
  });
  
  return result;
}

function sendBizExpensesSummary() {
  if (window.parent === window) return;
  
  const txs = getBizExpenseTransactions();
  const byCat = {};
  Object.keys(BIZ_EXPENSE_CATS).forEach(k => { byCat[k] = 0; });
  txs.forEach(tx => { byCat[tx.bizCategory] = (byCat[tx.bizCategory] || 0) + tx.amount; });
  const total = txs.reduce((s, t) => s + t.amount, 0);
  
  try {
    window.parent.postMessage({ type: 'bizExpensesSummary', total, byCat, count: txs.length }, '*');
  } catch(e) {}
}

function renderBizExpenses() {
  const txs = getBizExpenseTransactions();
  const allExcl = budgetData.excludedTransactions || [];
  const rulesCount = Object.keys(businessRules).length;
  
  // –í—Å–µ –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –º–µ—Å—è—Ü—ã
  const allMonths = new Set();
  txs.forEach(tx => { if (tx.monthKey) allMonths.add(tx.monthKey); });
  const months = [...allMonths].sort();
  const monthCount = months.length || 1;
  
  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –±–∏–∑–Ω–µ—Å-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  const byCat = {};
  Object.keys(BIZ_EXPENSE_CATS).forEach(k => { byCat[k] = { total: 0, count: 0, recipients: {}, months: {} }; });
  
  txs.forEach(tx => {
    const cat = tx.bizCategory;
    if (!byCat[cat]) return;
    byCat[cat].total += tx.amount;
    byCat[cat].count++;
    
    const m = tx.merchant || tx.description?.substring(0, 35) || '?';
    if (!byCat[cat].recipients[m]) byCat[cat].recipients[m] = { total: 0, count: 0 };
    byCat[cat].recipients[m].total += tx.amount;
    byCat[cat].recipients[m].count++;
    
    byCat[cat].months[tx.monthKey] = (byCat[cat].months[tx.monthKey] || 0) + tx.amount;
  });
  
  const grandTotal = txs.reduce((s, t) => s + t.amount, 0);
  const avgPerMonth = Math.round(grandTotal / monthCount);
  
  // –ù–µ –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã (–ø–æ–¥—Å–∫–∞–∑–∫–∞)
  const untaggedTransfers = {};
  allExcl.filter(tx => tx.reason === 'transfer').forEach(tx => {
    const m = (tx.merchant || tx.description || '').toUpperCase().trim();
    if (!businessRules[m]) {
      const name = tx.merchant || tx.description?.substring(0, 35) || '?';
      if (!untaggedTransfers[name]) untaggedTransfers[name] = { total: 0, count: 0 };
      untaggedTransfers[name].total += tx.amount;
      untaggedTransfers[name].count++;
    }
  });
  const topUntagged = Object.entries(untaggedTransfers).sort((a, b) => b[1].total - a[1].total).slice(0, 5);
  
  if (rulesCount === 0 && txs.length === 0) {
    return `
      <div class="bg-white rounded-2xl p-8 shadow-sm text-center">
        <div class="text-6xl mb-4">üíº</div>
        <h3 class="font-semibold text-gray-700 mb-2">–†–∞—Å—Ö–æ–¥—ã –∞—Ç–µ–ª—å–µ</h3>
        <p class="text-gray-500 text-sm mb-4">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –±–∏–∑–Ω–µ—Å-—Ä–∞—Å—Ö–æ–¥—ã.<br>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <strong>–ò—Å–∫–ª—é—á–µ–Ω–∏—è</strong>, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–†–∞—Å—Ö–æ–¥ –∞—Ç–µ–ª—å–µ¬ª.</p>
        <div class="text-left bg-gray-50 rounded-xl p-4 text-sm">
          <div class="font-semibold mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</div>
          ${Object.entries(BIZ_EXPENSE_CATS).map(([k, v]) => 
            `<div class="py-1">${v.icon} <strong>${v.name}</strong></div>`
          ).join('')}
        </div>
      </div>
    `;
  }
  
  let html = '';
  
  // –û–±—â–∞—è —Å–≤–æ–¥–∫–∞
  html += `
    <div class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-2xl p-5 shadow-sm mb-4">
      <div class="text-center mb-3">
        <div class="text-sm opacity-80">–†–∞—Å—Ö–æ–¥—ã –∞—Ç–µ–ª—å–µ ‚Ä¢ ${rulesCount} –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π</div>
        <div class="text-3xl font-bold mt-1">${formatMoney(grandTotal)}</div>
        <div class="text-sm opacity-80 mt-1">~${formatMoney(avgPerMonth)} / –º–µ—Å${months.length > 1 ? ' (' + months.length + ' –º–µ—Å.)' : ''}</div>
      </div>
      <div class="grid grid-cols-3 gap-2 mt-3">
        ${Object.entries(BIZ_EXPENSE_CATS).filter(([k]) => byCat[k].total > 0).map(([k, v]) => `
          <div class="bg-white/15 rounded-xl p-2 text-center">
            <div class="text-lg">${v.icon}</div>
            <div class="text-xs opacity-80">${v.name}</div>
            <div class="font-bold text-sm">${formatMoney(byCat[k].total)}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ
  Object.entries(BIZ_EXPENSE_CATS).forEach(([catKey, catInfo]) => {
    const cat = byCat[catKey];
    if (cat.total === 0) return;
    
    const catAvg = Math.round(cat.total / monthCount);
    const sortedRecipients = Object.entries(cat.recipients).sort((a, b) => b[1].total - a[1].total);
    
    html += `
      <div class="bg-white rounded-2xl shadow-sm mb-3 overflow-hidden">
        <div class="p-4 cursor-pointer" onclick="toggleExclSection('biz_${catKey}')" 
             style="background: ${catInfo.color}15; border-left: 4px solid ${catInfo.color};">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="font-semibold text-gray-800">${catInfo.icon} ${catInfo.name}</h3>
              <div class="text-xs text-gray-500">${cat.count} –æ–ø–µ—Ä–∞—Ü–∏–π ‚Ä¢ ${sortedRecipients.length} –ø–æ–ª—É—á–∞—Ç. ‚Ä¢ ~${formatMoney(catAvg)}/–º–µ—Å</div>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold" style="color:${catInfo.color}">${formatMoney(cat.total)}</div>
            </div>
          </div>
        </div>
        <div id="biz_${catKey}" class="hidden divide-y divide-gray-100">
          ${sortedRecipients.map(([name, data]) => `
            <div class="p-3 hover:bg-gray-50 transition flex justify-between items-center">
              <div>
                <div class="font-medium text-sm text-gray-800">${name}</div>
                <div class="text-xs text-gray-400">${data.count} –æ–ø–µ—Ä–∞—Ü–∏–π</div>
              </div>
              <div class="text-right">
                <div class="font-bold text-gray-800">${formatMoney(data.total)}</div>
                <div class="text-xs text-gray-500">~${formatMoney(Math.round(data.total / monthCount))}/–º–µ—Å</div>
              </div>
            </div>
          `).join('')}
          ${months.length > 1 ? `
          <div class="p-3">
            <div class="text-xs font-semibold text-gray-500 mb-2">–ü–æ –º–µ—Å—è—Ü–∞–º:</div>
            <div class="flex gap-1 flex-wrap">
              ${months.map(mk => `
                <div class="text-center px-2 py-1 bg-gray-50 rounded-lg text-xs">
                  <div class="text-gray-400">${getMonthShortName(mk)}</div>
                  <div class="font-bold" style="color:${catInfo.color}">${cat.months[mk] ? formatMoney(cat.months[mk]) : '‚Äî'}</div>
                </div>
              `).join('')}
            </div>
          </div>` : ''}
        </div>
      </div>
    `;
  });
  
  // –ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–µ–ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã
  if (topUntagged.length > 0) {
    html += `
      <div class="bg-yellow-50 rounded-2xl p-4 shadow-sm border border-yellow-200 mt-4">
        <h4 class="font-semibold text-yellow-800 mb-2">üí° –ù–µ–ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã</h4>
        <p class="text-xs text-yellow-700 mb-3">–≠—Ç–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ –µ—â—ë –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –±–∏–∑–Ω–µ—Å-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –ø–æ–º–µ—Ç–∏—Ç—å.</p>
        ${topUntagged.map(([name, data]) => `
          <div class="flex justify-between items-center py-2 border-b border-yellow-100 cursor-pointer hover:bg-yellow-100 rounded-lg px-2 transition"
               onclick="showExcludedDrill('${name.replace(/'/g, "\\'")}', 'transfer')">
            <div class="text-sm text-gray-700">${name}</div>
            <div class="text-sm font-bold text-gray-800">${formatMoney(data.total)}</div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  return html;
}
function showMerchantCategoryModal(merchant, currentCategory, txDate, txAmount, txOwner) {
  const allCategories = getUserCategories();
  const hasRule = userCategoryRules[merchant];
  const merchantTxs = budgetData.transactions.filter(tx => tx.merchant === merchant);
  const merchantTxCount = merchantTxs.length;
  const merchantTotal = merchantTxs.reduce((sum, tx) => sum + tx.amount, 0);
  
  document.getElementById('drillModal').classList.remove('hidden');
  document.getElementById('drillModal').classList.add('flex');
  document.getElementById('drillTitle').textContent = merchant;
  document.getElementById('drillContent').innerHTML = `
    <div class="mb-4 p-4 bg-purple-50 rounded-xl">
      <div class="font-medium text-lg">${merchant}</div>
      ${txDate ? `<div class="text-sm text-gray-600 mt-1">–í—ã–±—Ä–∞–Ω–æ: ${txDate} ‚Ä¢ ${txOwner} ‚Ä¢ ${formatMoney(txAmount)}</div>` : ''}
      <div class="text-sm text-gray-500 mt-1">–í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${merchantTxCount} ‚Ä¢ –°—É–º–º–∞: ${formatMoney(merchantTotal)}</div>
      <div class="text-sm text-gray-500 mt-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: <span class="font-medium">${currentCategory}</span></div>
      ${hasRule ? '<div class="text-xs text-green-600 mt-2">‚úì –ï—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ</div>' : ''}
    </div>
    
    <!-- –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
      <select id="newCategorySelect" class="w-full p-3 border rounded-xl text-lg" onchange="handleCategorySelectChange()">
        ${allCategories.map(cat => `
          <option value="${cat}" ${cat === currentCategory ? 'selected' : ''}>${cat}</option>
        `).join('')}
        <option value="__NEW__">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
      </select>
      
      <div id="newCategoryInput" class="hidden mt-3">
        <input type="text" id="customCategoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" 
               class="w-full p-3 border rounded-xl text-lg" maxlength="30">
      </div>
    </div>
    
    <button onclick="applyMerchantCategoryGlobal('${merchant.replace(/'/g, "\\'")}')" 
            class="w-full bg-purple-600 text-white py-3 rounded-xl font-medium hover:bg-purple-700 transition">
      –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º ${merchantTxCount} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
    </button>
    
    ${hasRule ? `
      <button onclick="removeMerchantRule('${merchant.replace(/'/g, "\\'")}'); hideDrillModal(); updateUI();" 
              class="w-full mt-2 bg-gray-200 text-gray-700 py-2 rounded-xl text-sm hover:bg-gray-300 transition">
        –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ
      </button>
    ` : ''}
    
    <!-- –£–¥–∞–ª–µ–Ω–∏–µ -->
    <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
      ${txDate ? `
        <button onclick="deleteOneTransaction('${txDate}', '${merchant.replace(/'/g, "\\'")}', ${txAmount}, '${txOwner}')" 
                class="w-full border-2 border-red-300 text-red-600 py-2.5 rounded-xl text-sm font-medium hover:bg-red-50 transition">
          üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        </button>
        ${merchantTxCount > 1 ? `
          <button onclick="deleteAllMerchantTransactions('${merchant.replace(/'/g, "\\'")}')" 
                  class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl text-sm font-bold transition">
            ‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç—Ä–∞—Ç—ã –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ (${merchantTxCount} —à—Ç.)
          </button>
        ` : ''}
      ` : `
        <button onclick="deleteAllMerchantTransactions('${merchant.replace(/'/g, "\\'")}')" 
                class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl text-sm font-bold transition">
          üóëÔ∏è –£–¥–∞–ª–∏—Ç—å ${merchantTxCount > 1 ? '–≤—Å–µ —Ç—Ä–∞—Ç—ã –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ (' + merchantTxCount + ' —à—Ç.)' : '—ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–∑ –±—é–¥–∂–µ—Ç–∞'}
        </button>
      `}
    </div>
  `;
}

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ + –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ)
function getUserCategories() {
  const builtIn = [...new Set(CATEGORY_PATTERNS.map(p => p.category))];
  const userCreated = JSON.parse(localStorage.getItem('userCategories') || '[]');
  const all = [...new Set([...builtIn, ...userCreated, '–ü—Ä–æ—á–µ–µ'])].sort();
  return all;
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
function saveUserCategory(category) {
  const userCreated = JSON.parse(localStorage.getItem('userCategories') || '[]');
  if (!userCreated.includes(category)) {
    userCreated.push(category);
    localStorage.setItem('userCategories', JSON.stringify(userCreated));
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è select –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function handleCategorySelectChange() {
  const select = document.getElementById('newCategorySelect');
  const inputDiv = document.getElementById('newCategoryInput');
  
  if (select.value === '__NEW__') {
    inputDiv.classList.remove('hidden');
    document.getElementById('customCategoryName').focus();
  } else {
    inputDiv.classList.add('hidden');
  }
}

// –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ
function applyMerchantCategoryGlobal(merchant) {
  let newCategory = document.getElementById('newCategorySelect').value;
  
  // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  if (newCategory === '__NEW__') {
    const customName = document.getElementById('customCategoryName').value.trim();
    if (!customName) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
      return;
    }
    newCategory = customName;
    saveUserCategory(newCategory);
  }
  
  const oldCategory = budgetData.transactions.find(tx => tx.merchant === merchant)?.category || '–ü—Ä–æ—á–µ–µ';
  
  if (newCategory === oldCategory) {
    alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å');
    return;
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
  saveToHistory(`${merchant}: ${oldCategory} ‚Üí ${newCategory}`);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–æ
  userCategoryRules[merchant] = newCategory;
  saveUserRules();
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º —ç—Ç–æ–≥–æ –º–µ—Ä—á–∞–Ω—Ç–∞
  let changed = 0;
  budgetData.transactions.forEach(tx => {
    if (tx.merchant === merchant) {
      tx.category = newCategory;
      changed++;
    }
  });
  
  saveData();
  updateUI();
  hideDrillModal();
  
  showToast({
    icon: 'üìÅ',
    title: `¬´${merchant}¬ª ‚Üí ${newCategory}`,
    message: `–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ ${changed} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–∑ ¬´${oldCategory}¬ª.\n–í—Å–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∫—É–ø–∫–∏ –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—Ç—å –≤ ¬´${newCategory}¬ª.`,
    type: 'success'
  });
}

// ==================== DRILL-DOWN ====================

function showCategoryDrill(category) {
  const filtered = getFilteredTransactions().filter(tx => tx.category === category);
  const merchants = {};
  
  filtered.forEach(tx => {
    if (!merchants[tx.merchant]) {
      merchants[tx.merchant] = { total: 0, count: 0, transactions: [] };
    }
    merchants[tx.merchant].total += tx.amount;
    merchants[tx.merchant].count++;
    merchants[tx.merchant].transactions.push(tx);
  });
  
  const sorted = Object.entries(merchants).sort((a, b) => b[1].total - a[1].total);
  const total = sorted.reduce((sum, [_, data]) => sum + data.total, 0);
  const norm = budgetData.norms[category]?.monthly_avg || 0;
  
  document.getElementById('drillTitle').textContent = category;
  document.getElementById('drillContent').innerHTML = `
    <div class="mb-4 p-4 rounded-xl ${total > norm && norm > 0 ? 'bg-red-50' : 'bg-green-50'}">
      <div class="flex justify-between items-center">
        <span class="font-medium">–ò—Ç–æ–≥–æ:</span>
        <span class="text-xl font-bold">${formatMoney(total)}</span>
      </div>
      ${norm > 0 ? `
        <div class="flex justify-between items-center text-sm mt-1">
          <span>–ù–æ—Ä–º–∞:</span>
          <span>${formatMoney(norm)} (${total > norm ? '+' : ''}${formatMoney(total - norm)})</span>
        </div>
      ` : ''}
    </div>
    
    <h4 class="font-semibold text-gray-700 mb-2">–¢–æ–ø –º–µ—Ä—á–∞–Ω—Ç—ã:</h4>
    <div class="space-y-2 max-h-96 overflow-y-auto">
      ${sorted.map(([merchant, data]) => `
        <div class="p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100" onclick="showMerchantDrill('${category}', '${merchant.replace(/'/g, "\\'")}')">
          <div class="flex justify-between items-center">
            <div>
              <div class="font-medium text-gray-800 text-sm">${merchant}</div>
              <div class="text-xs text-gray-500">${data.count} –ø–æ–∫—É–ø–æ–∫</div>
            </div>
            <div class="font-bold text-gray-800">${formatMoney(data.total)}</div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  
  document.getElementById('drillModal').classList.remove('hidden');
  document.getElementById('drillModal').classList.add('flex');
}

function showMerchantDrill(category, merchant) {
  const filtered = getFilteredTransactions().filter(tx => tx.category === category && tx.merchant === merchant);
  const total = filtered.reduce((sum, tx) => sum + tx.amount, 0);
  const allMerchantTxs = budgetData.transactions.filter(tx => tx.merchant === merchant);
  const allCount = allMerchantTxs.length;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Ä—á–∞–Ω—Ç–∞
  const hasUserRule = Object.keys(userCategoryRules).some(rule => 
    merchant.toUpperCase().includes(rule) || rule.includes(merchant.toUpperCase())
  );
  
  document.getElementById('drillTitle').innerHTML = `<button onclick="showCategoryDrill('${category}')" class="text-purple-600 hover:underline">‚Üê ${category}</button> / ${merchant}`;
  document.getElementById('drillContent').innerHTML = `
    <div class="mb-4 p-4 bg-purple-50 rounded-xl">
      <div class="flex justify-between items-center">
        <span class="font-medium">–ò—Ç–æ–≥–æ –ø–æ "${merchant}":</span>
        <span class="text-xl font-bold">${formatMoney(total)}</span>
      </div>
      <div class="text-sm text-gray-500 mt-1">${filtered.length} –æ–ø–µ—Ä–∞—Ü–∏–π</div>
    </div>
    
    <!-- –°–º–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div class="mb-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
      <div class="text-sm font-medium text-blue-800 mb-2">üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è:</div>
      <select id="categorySelect" onchange="handleCategoryDrillChange('${merchant.replace(/'/g, "\\'")}')" 
              class="w-full p-2 rounded-lg border border-blue-300 bg-white text-sm font-medium">
        ${getAllCategories().map(cat => `
          <option value="${cat}" ${cat === category ? 'selected' : ''}>${cat}</option>
        `).join('')}
        <option value="__NEW__">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
      </select>
      
      <div id="newCategoryDrillInput" class="hidden mt-3">
        <input type="text" id="customCategoryDrillName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" 
               class="w-full p-2 border rounded-lg text-sm" maxlength="30">
        <button onclick="applyNewCategoryDrill('${merchant.replace(/'/g, "\\'")}')" 
                class="w-full mt-2 bg-blue-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-blue-700">
          –°–æ–∑–¥–∞—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å
        </button>
      </div>
      
      ${hasUserRule ? `<div class="text-xs text-blue-600 mt-2">‚úì –ï—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ</div>` : ''}
    </div>
    
    <h4 class="font-semibold text-gray-700 mb-2">–û–ø–µ—Ä–∞—Ü–∏–∏:</h4>
    <div class="space-y-2 max-h-64 overflow-y-auto mb-4">
      ${filtered.sort((a, b) => b.date.split('.').reverse().join('-').localeCompare(a.date.split('.').reverse().join('-'))).map(tx => `
        <div class="p-3 bg-gray-50 rounded-xl flex justify-between items-center">
          <div>
            <div class="text-sm text-gray-500">${tx.date}</div>
            <div class="text-xs text-gray-400">${tx.owner}</div>
          </div>
          <div class="flex items-center gap-2">
            <div class="font-bold text-gray-800">${formatMoney(tx.amount)}</div>
            <button onclick="deleteOneTransaction('${tx.date}', '${merchant.replace(/'/g, "\\'")}', ${tx.amount}, '${tx.owner}'); showCategoryDrill('${category}');" 
                    class="text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg p-1 transition" title="–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–∑ –±—é–¥–∂–µ—Ç–∞">
              ‚úï
            </button>
          </div>
        </div>
      `).join('')}
    </div>
    
    <!-- –£–¥–∞–ª–µ–Ω–∏–µ -->
    <div class="pt-4 border-t border-gray-200 space-y-2">
      <button onclick="deleteAllMerchantTransactions('${merchant.replace(/'/g, "\\'")}')" 
              class="w-full bg-red-600 hover:bg-red-700 text-white py-2.5 rounded-xl text-sm font-medium transition">
        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å ${allCount > 1 ? '–≤—Å–µ —Ç—Ä–∞—Ç—ã –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ (' + allCount + ' —à—Ç.)' : '—ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–∑ –±—é–¥–∂–µ—Ç–∞'}
      </button>
    </div>
  `;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ drill-down
function handleCategoryDrillChange(merchant) {
  const select = document.getElementById('categorySelect');
  const inputDiv = document.getElementById('newCategoryDrillInput');
  
  if (select.value === '__NEW__') {
    inputDiv.classList.remove('hidden');
    document.getElementById('customCategoryDrillName').focus();
  } else {
    inputDiv.classList.add('hidden');
    changeMerchantCategory(merchant, select.value);
  }
}

// –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ drill-down
function applyNewCategoryDrill(merchant) {
  const customName = document.getElementById('customCategoryDrillName').value.trim();
  if (!customName) {
    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
    return;
  }
  saveUserCategory(customName);
  changeMerchantCategory(merchant, customName);
}

// –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–µ—Ä—á–∞–Ω—Ç–∞
function changeMerchantCategory(merchant, newCategory) {
  const changed = setMerchantCategory(merchant, newCategory);
  
  hideDrillModal();
  showToast({
    icon: 'üìÅ',
    title: `¬´${merchant}¬ª ‚Üí ${newCategory}`,
    message: `–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ ${changed} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.\n–í—Å–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∫—É–ø–∫–∏ –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—Ç—å –≤ ¬´${newCategory}¬ª.`,
    type: 'success'
  });
}

function hideDrillModal() {
  document.getElementById('drillModal').classList.add('hidden');
  document.getElementById('drillModal').classList.remove('flex');
}

// ==================== CHARTS ====================

function renderCharts(transactions) {
  const byCategory = {};
  transactions.forEach(tx => {
    byCategory[tx.category] = (byCategory[tx.category] || 0) + tx.amount;
  });
  
  const sorted = Object.entries(byCategory).sort((a, b) => b[1] - a[1]).slice(0, 10);
  const labels = sorted.map(([cat]) => cat);
  const data = sorted.map(([_, amount]) => amount);
  const colors = [
    '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e',
    '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6'
  ];
  
  if (charts.pie) charts.pie.destroy();
  
  const ctx = document.getElementById('pieChart')?.getContext('2d');
  if (ctx) {
    charts.pie = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{ data, backgroundColor: colors, borderWidth: 0 }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } }
        }
      }
    });
  }
}

function renderTrendChart() {
  const byMonth = {};
  const byMonthCategory = {};
  
  budgetData.transactions.forEach(tx => {
    if (!tx.monthKey) return;
    byMonth[tx.monthKey] = (byMonth[tx.monthKey] || 0) + tx.amount;
    
    if (!byMonthCategory[tx.category]) byMonthCategory[tx.category] = {};
    byMonthCategory[tx.category][tx.monthKey] = (byMonthCategory[tx.category][tx.monthKey] || 0) + tx.amount;
  });
  
  const allMonths = Object.keys(byMonth).sort();
  const labels = allMonths.map(m => getMonthName(m));
  const data = allMonths.map(m => byMonth[m] || 0);
  const norm = Object.values(budgetData.norms).reduce((sum, n) => sum + (n.monthly_avg || 0), 0);
  
  if (charts.trend) charts.trend.destroy();
  
  // –ì–ª–∞–≤–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ - –ª–∏–Ω–∏—è —Å –∑–∞–ª–∏–≤–∫–æ–π + –ª–∏–Ω–∏—è –Ω–æ—Ä–º—ã
  const ctx = document.getElementById('trendChart')?.getContext('2d');
  if (ctx) {
    charts.trend = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { 
            label: '–†–∞—Å—Ö–æ–¥—ã', 
            data, 
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 6,
            pointBackgroundColor: '#8b5cf6',
            pointHoverRadius: 8
          },
          { 
            label: '–ù–æ—Ä–º–∞', 
            data: data.map(() => norm), 
            borderColor: '#f43f5e', 
            borderDash: [5, 5], 
            pointRadius: 0, 
            fill: false,
            tension: 0
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { intersect: false, mode: 'index' },
        onClick: (event, elements) => {
          if (elements.length > 0 && elements[0].datasetIndex === 0) {
            const index = elements[0].index;
            const monthKey = allMonths[index];
            showMonthBreakdown(monthKey);
          }
        },
        plugins: { 
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${formatMoney(ctx.raw)}`,
              footer: () => 'üëÜ –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏'
            }
          }
        },
        scales: { 
          y: { 
            beginAtZero: true,
            ticks: { callback: (v) => formatMoney(v) }
          } 
        }
      }
    });
  }
  
  // –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  const categoryTotals = {};
  Object.entries(byMonthCategory).forEach(([cat, months]) => {
    categoryTotals[cat] = Object.values(months).reduce((a, b) => a + b, 0);
  });
  const topCategories = Object.entries(categoryTotals)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 8)
    .map(([cat]) => cat);
  
  topCategories.forEach(cat => {
    const canvasId = `catChart_${cat.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9]/g, '_')}`;
    const catCtx = document.getElementById(canvasId)?.getContext('2d');
    if (!catCtx) return;
    
    const catData = allMonths.map(m => byMonthCategory[cat]?.[m] || 0);
    const catNorm = budgetData.norms[cat]?.monthly_avg || 0;
    
    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (charts[canvasId]) charts[canvasId].destroy();
    
    charts[canvasId] = new Chart(catCtx, {
      type: 'line',
      data: {
        labels: allMonths.map(m => m.split('-')[1]), // –¢–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä –º–µ—Å—è—Ü–∞
        datasets: [
          { 
            data: catData, 
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 2
          },
          { 
            data: catData.map(() => catNorm), 
            borderColor: '#f43f5e', 
            borderDash: [3, 3], 
            pointRadius: 0, 
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { 
          x: { display: false },
          y: { display: false, beginAtZero: true }
        }
      }
    });
  });
}

// –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–Ω–∞–º–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
// –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–±–∏–≤–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∑–∞ –º–µ—Å—è—Ü (–ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ç–æ—á–∫—É –≥—Ä–∞—Ñ–∏–∫–∞)
function showMonthBreakdown(monthKey) {
  const transactions = budgetData.transactions.filter(tx => tx.monthKey === monthKey);
  
  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  const byCategory = {};
  transactions.forEach(tx => {
    if (!byCategory[tx.category]) {
      byCategory[tx.category] = 0;
    }
    byCategory[tx.category] += tx.amount;
  });
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—É–º–º–µ
  const sorted = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);
  const total = sorted.reduce((sum, [_, amount]) => sum + amount, 0);
  const totalNorm = Object.values(budgetData.norms).reduce((sum, n) => sum + (n.monthly_avg || 0), 0);
  
  document.getElementById('drillModal').classList.remove('hidden');
  document.getElementById('drillModal').classList.add('flex');
  document.getElementById('drillTitle').textContent = `üìÖ ${getMonthName(monthKey)} ‚Äî –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è`;
  document.getElementById('drillContent').innerHTML = `
    <div class="mb-4 p-4 bg-purple-50 rounded-xl">
      <div class="grid grid-cols-2 gap-4 text-center">
        <div>
          <div class="text-xs text-gray-500">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
          <div class="font-bold text-xl">${formatMoney(total)}</div>
        </div>
        <div>
          <div class="text-xs text-gray-500">–ù–æ—Ä–º–∞</div>
          <div class="font-bold text-xl ${total > totalNorm ? 'text-red-600' : 'text-green-600'}">${formatMoney(totalNorm)}</div>
        </div>
      </div>
      <div class="mt-3 text-center">
        <span class="text-sm ${total > totalNorm ? 'text-red-600' : 'text-green-600'} font-medium">
          ${total > totalNorm ? 'üî¥ –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –Ω–∞ ' + formatMoney(total - totalNorm) : 'üü¢ –≠–∫–æ–Ω–æ–º–∏—è ' + formatMoney(totalNorm - total)}
        </span>
      </div>
    </div>
    
    <h4 class="font-semibold text-gray-700 mb-3">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</h4>
    <div class="space-y-2 max-h-96 overflow-y-auto">
      ${sorted.map(([cat, amount]) => {
        const norm = budgetData.norms[cat]?.monthly_avg || 0;
        const diff = amount - norm;
        const percent = norm > 0 ? Math.round((amount / norm) * 100) : 0;
        const isOver = diff > 0;
        
        return `
          <div class="p-3 ${isOver ? 'bg-red-50' : 'bg-green-50'} rounded-xl cursor-pointer hover:opacity-80 transition" 
               onclick="showMonthCategoryDetail('${cat}', '${monthKey}')">
            <div class="flex justify-between items-center mb-1">
              <span class="font-medium ${isOver ? 'text-red-700' : 'text-green-700'}">${cat}</span>
              <span class="font-bold ${isOver ? 'text-red-600' : 'text-green-600'}">${formatMoney(amount)}</span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="${isOver ? 'text-red-600' : 'text-green-600'} opacity-70">
                –ù–æ—Ä–º–∞: ${formatMoney(norm)}
              </span>
              <span class="${isOver ? 'text-red-600' : 'text-green-600'}">
                ${isOver ? '+' : ''}${formatMoney(diff)} (${percent}%)
              </span>
            </div>
            ${norm > 0 ? `
              <div class="mt-2 bg-gray-200 rounded-full h-2 overflow-hidden">
                <div class="h-full ${isOver ? 'bg-red-500' : 'bg-green-500'} transition-all" 
                     style="width: ${Math.min(percent, 150)}%"></div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('')}
    </div>
    
    <div class="mt-4 p-3 bg-gray-100 rounded-xl text-sm text-gray-600">
      üí° –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    </div>
  `;
}

function showCategoryTrendDrill(category) {
  const byMonth = {};
  budgetData.transactions
    .filter(tx => tx.category === category)
    .forEach(tx => {
      if (!tx.monthKey) return;
      byMonth[tx.monthKey] = (byMonth[tx.monthKey] || 0) + tx.amount;
    });
  
  const allMonths = Object.keys(byMonth).sort();
  const total = Object.values(byMonth).reduce((a, b) => a + b, 0);
  const avg = allMonths.length > 0 ? total / allMonths.length : 0;
  const norm = budgetData.norms[category]?.monthly_avg || 0;
  
  document.getElementById('drillModal').classList.remove('hidden');
  document.getElementById('drillModal').classList.add('flex');
  document.getElementById('drillTitle').textContent = `üìà ${category} ‚Äî –¥–∏–Ω–∞–º–∏–∫–∞`;
  document.getElementById('drillContent').innerHTML = `
    <div class="mb-4 p-4 bg-purple-50 rounded-xl">
      <div class="grid grid-cols-3 gap-4 text-center">
        <div>
          <div class="text-xs text-gray-500">–í—Å–µ–≥–æ</div>
          <div class="font-bold text-lg">${formatMoney(total)}</div>
        </div>
        <div>
          <div class="text-xs text-gray-500">–°—Ä–µ–¥–Ω–µ–µ/–º–µ—Å</div>
          <div class="font-bold text-lg">${formatMoney(avg)}</div>
        </div>
        <div>
          <div class="text-xs text-gray-500">–ù–æ—Ä–º–∞/–º–µ—Å</div>
          <div class="font-bold text-lg ${avg > norm ? 'text-red-600' : 'text-green-600'}">${formatMoney(norm)}</div>
        </div>
      </div>
    </div>
    
    <canvas id="drillTrendChart" height="200"></canvas>
    
    <h4 class="font-semibold text-gray-700 mt-4 mb-2">–ü–æ –º–µ—Å—è—Ü–∞–º:</h4>
    <div class="space-y-1 max-h-48 overflow-y-auto">
      ${allMonths.reverse().map(m => {
        const amount = byMonth[m];
        const diff = amount - norm;
        const diffClass = diff > 0 ? 'text-red-600' : 'text-green-600';
        const diffSign = diff > 0 ? '+' : '';
        return `
          <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100" onclick="showMonthCategoryDetail('${category}', '${m}')">
            <span class="text-sm">${getMonthName(m)}</span>
            <div class="text-right">
              <span class="font-medium">${formatMoney(amount)}</span>
              <span class="text-xs ${diffClass} ml-2">${diffSign}${formatMoney(diff)}</span>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
  
  // –†–∏—Å—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
  setTimeout(() => {
    const ctx = document.getElementById('drillTrendChart')?.getContext('2d');
    if (!ctx) return;
    
    const sortedMonths = Object.keys(byMonth).sort();
    if (charts.drillTrend) charts.drillTrend.destroy();
    
    charts.drillTrend = new Chart(ctx, {
      type: 'line',
      data: {
        labels: sortedMonths.map(m => getMonthName(m)),
        datasets: [
          { 
            label: category, 
            data: sortedMonths.map(m => byMonth[m]), 
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 6,
            pointBackgroundColor: '#8b5cf6',
            pointHoverRadius: 10,
            pointHoverBackgroundColor: '#7c3aed'
          },
          { 
            label: '–ù–æ—Ä–º–∞', 
            data: sortedMonths.map(() => norm), 
            borderColor: '#f43f5e', 
            borderDash: [5, 5], 
            pointRadius: 0, 
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { display: true },
          tooltip: {
            callbacks: {
              afterLabel: () => '(–∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π)'
            }
          }
        },
        scales: { 
          y: { 
            beginAtZero: true,
            ticks: { callback: (v) => formatMoney(v) }
          } 
        },
        onClick: (evt, elements) => {
          if (elements.length > 0 && elements[0].datasetIndex === 0) {
            const idx = elements[0].index;
            const monthKey = sortedMonths[idx];
            showMonthCategoryDetail(category, monthKey);
          }
        },
        onHover: (evt, elements) => {
          evt.native.target.style.cursor = elements.length > 0 && elements[0].datasetIndex === 0 ? 'pointer' : 'default';
        }
      }
    });
  }, 100);
}

// –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function showMonthCategoryDetail(category, monthKey) {
  // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ä–µ–∞–ª—å–Ω–æ–π –¥–∞—Ç–µ, –∞ –Ω–µ –ø–æ monthKey (–∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º)
  const transactions = budgetData.transactions.filter(tx => {
    if (tx.category !== category) return false;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—è—Ü –∏–∑ –¥–∞—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    const txMonth = getMonthKeyFromDate(tx.date);
    return txMonth === monthKey;
  });
  
  const total = transactions.reduce((sum, tx) => sum + tx.amount, 0);
  
  // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  const allCategories = [...new Set(CATEGORY_PATTERNS.map(p => p.category))].sort();
  
  document.getElementById('drillTitle').innerHTML = `<button onclick="showCategoryTrendDrill('${category}')" class="text-purple-600 hover:underline">‚Üê ${category}</button> / ${getMonthName(monthKey)}`;
  document.getElementById('drillContent').innerHTML = `
    <div class="mb-4 p-4 bg-purple-50 rounded-xl">
      <div class="flex justify-between items-center">
        <span class="font-medium">–ò—Ç–æ–≥–æ –∑–∞ ${getMonthName(monthKey)}:</span>
        <span class="text-xl font-bold">${formatMoney(total)}</span>
      </div>
      <div class="text-sm text-gray-500 mt-1">${transactions.length} –æ–ø–µ—Ä–∞—Ü–∏–π</div>
      <div class="text-xs text-purple-600 mt-2">üí° –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å</div>
    </div>
    
    <div class="space-y-2 max-h-96 overflow-y-auto">
      ${transactions.sort((a, b) => b.amount - a.amount).map((tx, idx) => `
        <div class="p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-purple-50 transition" onclick="showMerchantCategorySelect('${tx.merchant.replace(/'/g, "\\'")}', '${category}', '${monthKey}', '${tx.date}', ${tx.amount}, '${tx.owner}')">
          <div class="flex justify-between items-center">
            <div>
              <div class="font-medium text-sm">${tx.merchant}</div>
              <div class="text-xs text-gray-500">${formatDate(tx.date)} ‚Ä¢ ${tx.owner}</div>
            </div>
            <div class="font-bold text-gray-800">${formatMoney(tx.amount)}</div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

// –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –º–µ—Ä—á–∞–Ω—Ç–∞
function showMerchantCategorySelect(merchant, currentCategory, monthKey, txDate, txAmount, txOwner) {
  const allCategories = getUserCategories();
  const hasRule = userCategoryRules[merchant];
  
  const merchantTxs = budgetData.transactions.filter(tx => tx.merchant === merchant);
  const merchantTxCount = merchantTxs.length;
  
  document.getElementById('drillTitle').innerHTML = `<button onclick="showMonthCategoryDetail('${currentCategory}', '${monthKey}')" class="text-purple-600 hover:underline">‚Üê –ù–∞–∑–∞–¥</button> / ${merchant}`;
  document.getElementById('drillContent').innerHTML = `
    <div class="mb-4 p-4 bg-purple-50 rounded-xl">
      <div class="font-medium">${merchant}</div>
      ${txDate ? `<div class="text-sm text-gray-600 mt-1">–í—ã–±—Ä–∞–Ω–æ: ${txDate} ‚Ä¢ ${txOwner} ‚Ä¢ ${formatMoney(txAmount)}</div>` : ''}
      <div class="text-sm text-gray-500 mt-1">–í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${merchantTxCount}</div>
      ${hasRule ? '<div class="text-xs text-green-600 mt-1">‚úì –ï—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ</div>' : ''}
    </div>
    
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
      <select id="newCategorySelect" class="w-full p-3 border rounded-xl text-lg" onchange="handleCategorySelectChange()">
        ${allCategories.map(cat => `
          <option value="${cat}" ${cat === currentCategory ? 'selected' : ''}>${cat}</option>
        `).join('')}
        <option value="__NEW__">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
      </select>
      
      <div id="newCategoryInput" class="hidden mt-3">
        <input type="text" id="customCategoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" 
               class="w-full p-3 border rounded-xl text-lg" maxlength="30">
      </div>
    </div>
    
    <button onclick="applyMerchantCategory('${merchant.replace(/'/g, "\\'")}', '${currentCategory}', '${monthKey}')" 
            class="w-full bg-purple-600 text-white py-3 rounded-xl font-medium hover:bg-purple-700 transition">
      –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º (${merchantTxCount} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
    </button>
    
    ${hasRule ? `
      <button onclick="removeMerchantRule('${merchant.replace(/'/g, "\\'")}'); showMonthCategoryDetail('${currentCategory}', '${monthKey}');" 
              class="w-full mt-2 bg-gray-200 text-gray-700 py-2 rounded-xl text-sm hover:bg-gray-300 transition">
        –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ
      </button>
    ` : ''}
    
    <!-- –£–¥–∞–ª–µ–Ω–∏–µ -->
    <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
      ${txDate ? `
        <button onclick="deleteOneTransaction('${txDate}', '${merchant.replace(/'/g, "\\'")}', ${txAmount}, '${txOwner}'); showMonthCategoryDetail('${currentCategory}', '${monthKey}');" 
                class="w-full border-2 border-red-300 text-red-600 py-2.5 rounded-xl text-sm font-medium hover:bg-red-50 transition">
          üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        </button>
        ${merchantTxCount > 1 ? `
          <button onclick="deleteAllMerchantTransactions('${merchant.replace(/'/g, "\\'")}')" 
                  class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl text-sm font-bold transition">
            ‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç—Ä–∞—Ç—ã –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ (${merchantTxCount} —à—Ç.)
          </button>
        ` : ''}
      ` : `
        <button onclick="deleteAllMerchantTransactions('${merchant.replace(/'/g, "\\'")}')" 
                class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl text-sm font-bold transition">
          üóëÔ∏è –£–¥–∞–ª–∏—Ç—å ${merchantTxCount > 1 ? '–≤—Å–µ —Ç—Ä–∞—Ç—ã –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ (' + merchantTxCount + ' —à—Ç.)' : '—ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–∑ –±—é–¥–∂–µ—Ç–∞'}
        </button>
      `}
    </div>
  `;
}

// ==================== –£–î–ê–õ–ï–ù–ò–ï –¢–†–ê–ù–ó–ê–ö–¶–ò–ô ====================

// –£–¥–∞–ª–∏—Ç—å –æ–¥–Ω—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
function deleteOneTransaction(date, merchant, amount, owner) {
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?\n${date} ‚Ä¢ ${merchant} ‚Ä¢ ${formatMoney(amount)}`)) return;
  
  saveToHistory(`–£–¥–∞–ª–µ–Ω–∏–µ: ${merchant} ${formatMoney(amount)}`);
  
  // –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å–æ–≤–ø–∞–¥–∞—é—â—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
  const idx = budgetData.transactions.findIndex(tx => 
    tx.date === date && 
    tx.merchant === merchant && 
    tx.amount === amount && 
    tx.owner === owner
  );
  
  if (idx !== -1) {
    budgetData.transactions.splice(idx, 1);
    saveData();
    updateUI();
    
    const remaining = budgetData.transactions.filter(tx => tx.merchant === merchant).length;
    showToast({
      icon: 'üóëÔ∏è',
      title: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞',
      message: `${date} ‚Ä¢ ${merchant} ‚Ä¢ ${formatMoney(amount)}\n–≠—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Å–µ–º–µ–π–Ω–æ–º –±—é–¥–∂–µ—Ç–µ.${remaining > 0 ? `\n–û—Å—Ç–∞–ª—å–Ω—ã–µ ${remaining} –ø–æ–∫—É–ø–æ–∫ –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ –æ—Å—Ç–∞–≤–ª–µ–Ω—ã.` : ''}`,
      type: 'delete'
    });
  }
}

// –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–µ—Ä—á–∞–Ω—Ç–∞ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü
function deleteMerchantMonthTransactions(merchant, monthKey, category) {
  const txs = budgetData.transactions.filter(tx => tx.merchant === merchant && tx.monthKey === monthKey);
  
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${txs.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ¬´${merchant}¬ª –∑–∞ ${getMonthName(monthKey)}?\n\n–°—É–º–º–∞: ${formatMoney(txs.reduce((s, t) => s + t.amount, 0))}`)) return;
  
  saveToHistory(`–£–¥–∞–ª–µ–Ω–∏–µ ${txs.length}—à—Ç: ${merchant} (${getMonthName(monthKey)})`);
  
  budgetData.transactions = budgetData.transactions.filter(tx => 
    !(tx.merchant === merchant && tx.monthKey === monthKey)
  );
  
  saveData();
  updateUI();
}

// –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–µ—Ä—á–∞–Ω—Ç–∞ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è
function deleteAllMerchantTransactions(merchant) {
  const txs = budgetData.transactions.filter(tx => tx.merchant === merchant);
  const total = txs.reduce((s, t) => s + t.amount, 0);
  const count = txs.length;
  
  const msg = count === 1
    ? `–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é ¬´${merchant}¬ª?\n\n–°—É–º–º–∞: ${formatMoney(total)}`
    : `–£–¥–∞–ª–∏—Ç—å –≤—Å–µ ${count} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —ç—Ç–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞?\n\n¬´${merchant}¬ª\n–û–±—â–∞—è —Å—É–º–º–∞: ${formatMoney(total)}`;
  
  if (!confirm(msg)) return;
  
  saveToHistory(`–£–¥–∞–ª–µ–Ω–∏–µ ${count}—à—Ç: ${merchant}`);
  
  budgetData.transactions = budgetData.transactions.filter(tx => tx.merchant !== merchant);
  
  saveData();
  updateUI();
  hideDrillModal();
  
  showToast({
    icon: 'üóëÔ∏è',
    title: `–ú–∞–≥–∞–∑–∏–Ω ¬´${merchant}¬ª —É–¥–∞–ª—ë–Ω`,
    message: `–£–¥–∞–ª–µ–Ω–æ ${count} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–∞ —Å—É–º–º—É ${formatMoney(total)}.\n–í—Å–µ –ø–æ–∫—É–ø–∫–∏ –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ –±–æ–ª—å—à–µ –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Å–µ–º–µ–π–Ω–æ–º –±—é–¥–∂–µ—Ç–µ.`,
    type: 'delete'
  });
}

// –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫ –º–µ—Ä—á–∞–Ω—Ç—É
function applyMerchantCategory(merchant, oldCategory, monthKey) {
  let newCategory = document.getElementById('newCategorySelect').value;
  
  // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  if (newCategory === '__NEW__') {
    const customName = document.getElementById('customCategoryName').value.trim();
    if (!customName) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
      return;
    }
    newCategory = customName;
    saveUserCategory(newCategory);
  }
  
  if (newCategory === oldCategory) {
    alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å');
    return;
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
  saveToHistory(`${merchant}: ${oldCategory} ‚Üí ${newCategory}`);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–æ
  userCategoryRules[merchant] = newCategory;
  saveUserRules();
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º —ç—Ç–æ–≥–æ –º–µ—Ä—á–∞–Ω—Ç–∞
  let changed = 0;
  budgetData.transactions.forEach(tx => {
    if (tx.merchant === merchant) {
      tx.category = newCategory;
      changed++;
    }
  });
  
  saveData();
  updateUI();
  hideDrillModal();
  
  showToast({
    icon: 'üìÅ',
    title: `¬´${merchant}¬ª ‚Üí ${newCategory}`,
    message: `–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ ${changed} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–∑ ¬´${oldCategory}¬ª.\n–í—Å–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∫—É–ø–∫–∏ –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—Ç—å –≤ ¬´${newCategory}¬ª.`,
    type: 'success'
  });
}

// –ü–æ–ª—É—á–∏—Ç—å monthKey –∏–∑ –¥–∞—Ç—ã (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤)
function getMonthKeyFromDate(dateStr) {
  if (!dateStr) return null;
  const str = String(dateStr).trim();
  
  // –§–æ—Ä–º–∞—Ç DD.MM.YYYY –∏–ª–∏ DD.MM.YYYY HH:MM
  if (str.includes('.')) {
    const parts = str.split('.');
    if (parts.length >= 3) {
      let year = parts[2].split(/[\sT]/)[0]; // –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è –µ—Å–ª–∏ –µ—Å—Ç—å
      if (year.length === 2) year = '20' + year;
      return `${year}-${parts[1].padStart(2, '0')}`;
    }
  }
  
  // ISO —Ñ–æ—Ä–º–∞—Ç: 2026-02-01 –∏–ª–∏ 2026-02-01T00:00:00.000Z
  // –ü–∞—Ä—Å–∏–º –∏–∑ —Å—Ç—Ä–æ–∫–∏ –Ω–∞–ø—Ä—è–º—É—é, –ë–ï–ó new Date() (–∏–∑–±–µ–≥–∞–µ–º –ø—Ä–æ–±–ª–µ–º—ã —Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º)
  const isoMatch = str.match(/^(\d{4})-(\d{1,2})/);
  if (isoMatch) {
    return `${isoMatch[1]}-${isoMatch[2].padStart(2, '0')}`;
  }
  
  return null;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
function formatDate(dateStr) {
  if (!dateStr) return '';
  
  // ISO —Ñ–æ—Ä–º–∞—Ç
  if (dateStr.includes('T')) {
    const d = new Date(dateStr);
    if (!isNaN(d)) {
      return d.toLocaleDateString('ru-RU');
    }
  }
  
  // –£–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY
  if (dateStr.includes('.')) {
    return dateStr.split(' ')[0]; // –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è –µ—Å–ª–∏ –µ—Å—Ç—å
  }
  
  return dateStr;
}

// ==================== UPLOAD ====================

function showUploadModal() {
  document.getElementById('uploadModal').classList.remove('hidden');
  document.getElementById('uploadModal').classList.add('flex');
}

function hideUploadModal() {
  document.getElementById('uploadModal').classList.add('hidden');
  document.getElementById('uploadModal').classList.remove('flex');
  pendingTransactions = [];
  pendingExcluded = [];
  document.getElementById('uploadPreview').classList.add('hidden');
  document.getElementById('selectedFiles').classList.add('hidden');
  const btn = document.getElementById('processBtn');
  btn.disabled = true;
  btn.dataset.processing = 'false';
  btn.textContent = '‚úÖ –î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
}

// –ò–º–ø–æ—Ä—Ç JSON —Ñ–∞–π–ª–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
async function handleJsonImport(files) {
  if (!files.length) return;
  
  const file = files[0];
  document.getElementById('loadingIndicator').classList.remove('hidden');
  
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    
    if (data.transactions && Array.isArray(data.transactions)) {
      pendingTransactions = data.transactions;
      
      document.getElementById('loadingIndicator').classList.add('hidden');
      document.getElementById('previewCount').textContent = pendingTransactions.length;
      document.getElementById('previewList').innerHTML = pendingTransactions.slice(0, 10).map(tx =>
        `<div class="text-gray-600">${tx.date} | ${tx.category} | ${formatMoney(tx.amount)} | ${(tx.merchant || '').substring(0, 30)}</div>`
      ).join('') + (pendingTransactions.length > 10 ? `<div class="text-gray-400">...–∏ –µ—â—ë ${pendingTransactions.length - 10}</div>` : '');
      
      document.getElementById('uploadPreview').classList.remove('hidden');
      document.getElementById('processBtn').disabled = false;
    } else {
      throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON');
    }
  } catch (e) {
    document.getElementById('loadingIndicator').classList.add('hidden');
    alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ JSON: ' + e.message);
  }
}

async function handleFiles(files) {
  if (!files.length) return;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
  document.getElementById('selectedFiles').classList.remove('hidden');
  document.getElementById('filesCount').textContent = `${files.length} —Ñ–∞–π–ª${files.length > 1 ? (files.length < 5 ? '–∞' : '–æ–≤') : ''} –≤—ã–±—Ä–∞–Ω–æ`;
  
  document.getElementById('loadingIndicator').classList.remove('hidden');
  pendingTransactions = [];
  pendingExcluded = [];
  
  for (const file of files) {
    if (file.name.toLowerCase().endsWith('.pdf')) {
      try {
        const result = await parsePDF(file);
        pendingTransactions.push(...result.transactions);
        pendingExcluded.push(...result.excluded);
      } catch (e) {
        console.error('PDF parse error:', e);
        alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ' + file.name);
      }
    }
  }
  
  document.getElementById('loadingIndicator').classList.add('hidden');
  
  if (pendingTransactions.length > 0 || pendingExcluded.length > 0) {
    document.getElementById('previewCount').textContent = pendingTransactions.length;
    const excludedInfo = pendingExcluded.length > 0 
      ? `<div class="text-orange-500 mt-2 text-xs">üö´ –ò—Å–∫–ª—é—á–µ–Ω–æ: ${pendingExcluded.length} –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞ ${formatMoney(pendingExcluded.reduce((s,t) => s + t.amount, 0))} (–ø–µ—Ä–µ–≤–æ–¥—ã, –±–∏–∑–Ω–µ—Å –∏ –¥—Ä.)</div>` 
      : '';
    document.getElementById('previewList').innerHTML = pendingTransactions.slice(0, 10).map(tx =>
      `<div class="text-gray-600">${tx.date} | ${tx.category} | ${formatMoney(tx.amount)} | ${tx.merchant.substring(0, 30)}</div>`
    ).join('') + (pendingTransactions.length > 10 ? `<div class="text-gray-400">...–∏ –µ—â—ë ${pendingTransactions.length - 10}</div>` : '') + excludedInfo;
    
    document.getElementById('uploadPreview').classList.remove('hidden');
    document.getElementById('processBtn').disabled = false;
  }
}

async function processTransactions() {
  if (!pendingTransactions.length && !pendingExcluded.length) return;
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
  const btn = document.getElementById('processBtn');
  if (btn.dataset.processing === 'true') return;
  btn.dataset.processing = 'true';
  btn.disabled = true;
  btn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
  saveToHistory(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${pendingTransactions.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π`);
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∏ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  const beforeCount = budgetData.transactions.length;
  pendingTransactions.forEach(tx => {
    if (tx.monthKey) tx.monthKey = normalizeMonthKey(tx.monthKey);
  });
  budgetData.transactions.push(...pendingTransactions);
  budgetData.transactions = deduplicateTransactions(budgetData.transactions);
  const afterCount = budgetData.transactions.length;
  const added = afterCount - beforeCount;
  const skipped = pendingTransactions.length - added;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  if (!budgetData.excludedTransactions) budgetData.excludedTransactions = [];
  pendingExcluded.forEach(tx => {
    if (tx.monthKey) tx.monthKey = normalizeMonthKey(tx.monthKey);
  });
  budgetData.excludedTransactions.push(...pendingExcluded);
  // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã—Ö
  const exclSeen = new Map();
  budgetData.excludedTransactions = budgetData.excludedTransactions.filter(tx => {
    const key = `${normalizeDate(tx.date)}|${tx.amount}|${(tx.merchant || '').substring(0, 25)}`;
    if (exclSeen.has(key)) return false;
    exclSeen.set(key, true);
    return true;
  });
  
  budgetData.lastUpdate = new Date().toISOString();
  
  // –û—á–∏—â–∞–µ–º pending
  const uploadedCount = pendingTransactions.length;
  pendingTransactions = [];
  pendingExcluded = [];
  
  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ—Ä–º—ã
  updateNorms();
  
  // –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Google Sheets
  // –û–±–ª–∞—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ saveData ‚Üí uploadAllDataDebounced
  
  saveData();
  updateUI();
  hideUploadModal();
  
  showToast({
    icon: 'üì§',
    title: `–î–æ–±–∞–≤–ª–µ–Ω–æ ${added} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π`,
    message: skipped > 0 
      ? `–ò–∑ –≤—ã–ø–∏—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${added} –Ω–æ–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.\n${skipped} –¥—É–±–ª–µ–π –ø—Ä–æ–ø—É—â–µ–Ω–æ.`
      : '–î–∞–Ω–Ω—ã–µ –∏–∑ –≤—ã–ø–∏—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ —Å–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç.',
    type: 'success',
    showUndo: true
  });
}

// ==================== FILTERS ====================

function applyFilters() {
  currentMonth = document.getElementById('monthFilter').value;
  currentOwner = document.getElementById('ownerFilter').value;
  
  document.getElementById('periodInfo').textContent = `${getMonthName(currentMonth)} ‚Ä¢ ${currentOwner === 'all' ? '–í—Å–µ' : currentOwner}`;
  
  const activeTab = document.querySelector('.tab-btn.tab-active')?.dataset.tab || 'overview';
  renderTab(activeTab);
}

function updateMonthFilter() {
  const months = new Set();
  const categories = new Set();
  
  budgetData.transactions.forEach(tx => {
    if (tx.monthKey) {
      months.add(normalizeMonthKey(tx.monthKey));
    }
    if (tx.category) categories.add(tx.category);
  });
  
  // –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
  const now = new Date();
  const currentMK = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  months.add(currentMK);
  
  const sorted = [...months].sort().reverse();
  
  // –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä –º–µ—Å—è—Ü–µ–≤
  const select = document.getElementById('monthFilter');
  select.innerHTML = sorted.map(m => 
    `<option value="${m}" ${m === currentMonth ? 'selected' : ''}>${getMonthName(m)}</option>`
  ).join('');
  
  // –í—Ç–æ—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä (–¥–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞)
  const selectTo = document.getElementById('monthFilterTo');
  selectTo.innerHTML = '<option value="">–¥–æ...</option>' + sorted.map(m => 
    `<option value="${m}">${getMonthName(m)}</option>`
  ).join('');
  
  // –§–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  const catSelect = document.getElementById('categoryFilter');
  const sortedCats = [...categories].sort();
  catSelect.innerHTML = '<option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' + sortedCats.map(c => 
    `<option value="${c}">${c}</option>`
  ).join('');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É
function toggleRangeFilter() {
  const selectTo = document.getElementById('monthFilterTo');
  selectTo.classList.toggle('hidden');
  if (selectTo.classList.contains('hidden')) {
    selectTo.value = '';
    applyFilters();
  }
}

// ==================== STORAGE ====================

function saveData() {
  localStorage.setItem('familyBudgetV19', JSON.stringify(budgetData));
  uploadAllDataDebounced();
}

function loadData() {
  const saved = localStorage.getItem('familyBudgetV19');
  if (saved) {
    try {
      budgetData = JSON.parse(saved);
      if (!budgetData.excludedTransactions) budgetData.excludedTransactions = [];
      if (budgetData.transactions && budgetData.transactions.length > 0) {
        // –ì–õ–£–ë–û–ö–ê–Ø –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø: –ø—Ä–∏–≤–æ–¥–∏–º –í–°–ï –¥–∞—Ç—ã –∫ DD.MM.YYYY –∏ amounts –∫ —á–∏—Å–ª–∞–º.
        // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ ‚Äî –ø–æ—Å–ª–µ –±–∞–≥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ localStorage
        // –º–æ–≥—É—Ç –±—ã—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –¥–∞—Ç:
        //   "28.06.2025" (–∏–∑ PDF) vs "2025-06-27T21:00:00.000Z" (–∏–∑ Google Sheets)
        // –ë–µ–∑ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ getTxKey() –¥–∞—ë—Ç —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏ ‚Üí –¥—É–±–ª–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è.
        budgetData.transactions.forEach(tx => {
          if (tx.date) tx.date = normalizeDateForStorage(tx.date);
          if (tx.amount !== undefined) tx.amount = parseFloat(tx.amount) || 0;
          const computedMK = getMonthKeyFromDate(tx.date);
          if (computedMK) {
            tx.monthKey = computedMK;
          } else if (tx.monthKey) {
            tx.monthKey = normalizeMonthKey(tx.monthKey);
          }
        });
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º –¥—É–±–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        const before = budgetData.transactions.length;
        budgetData.transactions = deduplicateTransactions(budgetData.transactions);
        if (budgetData.transactions.length < before) {
          const removed = before - budgetData.transactions.length;
          console.log(`üßπ –û—á–∏—â–µ–Ω–æ –¥—É–±–ª–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${removed} (–±—ã–ª–æ ${before}, —Å—Ç–∞–ª–æ ${budgetData.transactions.length})`);
          saveData();
        }
      }
      // –ì–ª—É–±–æ–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è excluded (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ transactions)
      if (budgetData.excludedTransactions && budgetData.excludedTransactions.length > 0) {
        budgetData.excludedTransactions.forEach(tx => {
          if (tx.date) tx.date = normalizeDateForStorage(tx.date);
          if (tx.amount !== undefined) tx.amount = parseFloat(tx.amount) || 0;
          const computedMK = getMonthKeyFromDate(tx.date);
          if (computedMK) tx.monthKey = computedMK;
        });
        const beforeEx = budgetData.excludedTransactions.length;
        budgetData.excludedTransactions = deduplicateTransactions(budgetData.excludedTransactions);
        if (budgetData.excludedTransactions.length < beforeEx) {
          const removedEx = beforeEx - budgetData.excludedTransactions.length;
          console.log(`üßπ –û—á–∏—â–µ–Ω–æ –¥—É–±–ª–µ–π –∏—Å–∫–ª—é—á–µ–Ω–∏–π: ${removedEx} (–±—ã–ª–æ ${beforeEx}, —Å—Ç–∞–ª–æ ${budgetData.excludedTransactions.length})`);
          saveData();
        }
      }
    } catch (e) {
      console.error('Load error:', e);
    }
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ—Ä–º—ã (–∞–≤—Ç–æ –∏–ª–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
  updateNorms();
}

function updateUI() {
  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º monthKey –∏–∑ –¥–∞—Ç—ã (–∑–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
  if (budgetData.transactions) {
    budgetData.transactions.forEach(tx => {
      const computedMK = getMonthKeyFromDate(tx.date);
      if (computedMK) tx.monthKey = computedMK;
    });
  }
  
  updateMonthFilter();
  document.getElementById('lastUpdate').textContent = budgetData.lastUpdate 
    ? new Date(budgetData.lastUpdate).toLocaleDateString('ru-RU') 
    : '‚Äî';
  
  showTab('overview');
}

// ==================== INIT ====================

document.addEventListener('DOMContentLoaded', () => {
  // Embedded mode detection (when loaded inside unified app iframe)
  if (new URLSearchParams(window.location.search).has('embedded')) {
    document.body.classList.add('embedded-mode');
  }
  
  loadUserRules();
  loadData();
  updateUI();
  updateUndoButton();
  setTimeout(loadSavedSettings, 100);
  setTimeout(autoSync, 500);
  
  // Auto-PULL –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      console.log('App visible ‚Äî running autoSync');
      autoSync();
    }
  });
});

async function autoSync() {
  try {
    const [txData, exData, rulesData, settingsData, bizRulesData, bucketRulesData] = await Promise.all([
      fetchFromSheets('transactions'), fetchFromSheets('excluded'),
      fetchFromSheets('rules'), fetchFromSheets('settings'),
      fetchFromSheets('bizrules'), fetchFromSheets('bucketrules')
    ]);
    
    let changed = false;
    
    if (txData.success && txData.data && txData.data.length > 0) {
      const beforeCount = budgetData.transactions.length;
      budgetData.transactions = mergeTransactions(budgetData.transactions, txData.data);
      if (budgetData.transactions.length !== beforeCount) changed = true;
    }
    if (exData.success && exData.data && exData.data.length > 0) {
      const beforeExcl = (budgetData.excludedTransactions || []).length;
      budgetData.excludedTransactions = mergeTransactions(budgetData.excludedTransactions || [], exData.data);
      if ((budgetData.excludedTransactions || []).length !== beforeExcl) changed = true;
    }
    if (rulesData.success && rulesData.data && Object.keys(rulesData.data).length > 0) {
      const oldRulesJson = JSON.stringify(userCategoryRules);
      userCategoryRules = { ...userCategoryRules, ...rulesData.data };
      localStorage.setItem('userCategoryRules', JSON.stringify(userCategoryRules));
      if (JSON.stringify(userCategoryRules) !== oldRulesJson) changed = true;
    }
    if (bizRulesData && bizRulesData.success && bizRulesData.data && Object.keys(bizRulesData.data).length > 0) {
      const oldBizJson = JSON.stringify(businessRules);
      businessRules = { ...businessRules, ...bizRulesData.data };
      localStorage.setItem('businessRules', JSON.stringify(businessRules));
      if (JSON.stringify(businessRules) !== oldBizJson) changed = true;
    }
    if (bucketRulesData && bucketRulesData.success && bucketRulesData.data && Object.keys(bucketRulesData.data).length > 0) {
      const oldBucketJson = JSON.stringify(bucketRules);
      bucketRules = { ...bucketRules, ...bucketRulesData.data };
      localStorage.setItem('bucketRules', JSON.stringify(bucketRules));
      if (JSON.stringify(bucketRules) !== oldBucketJson) changed = true;
    }
    if (settingsData.success && settingsData.data && Object.keys(settingsData.data).length > 0) {
      applyCloudSettings(settingsData.data);
      changed = true;
    }
    
    if (changed) {
      assignBucketsToAll();
      budgetData.lastUpdate = new Date().toISOString();
      updateNorms();
      saveDataLocal();
      updateUI();
      console.log('AutoSync: data updated from cloud');
      showToast({ icon: '‚òÅÔ∏è', title: '–î–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', message: `–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${budgetData.transactions.length}`, type: 'success', showUndo: false, duration: 3000 });
    } else {
      console.log('AutoSync: no new data');
    }
  } catch (e) {
    console.log('Auto-sync skipped:', e.message);
  }
}
</script>

</body>
</html>
